<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>AJAX | Pinsflora</title><meta name="description" content="new Promise(resolve, reject)&#x3D;&gt; ???"><meta name="keywords" content="AJAX"><meta name="author" content="Joaxin"><meta name="copyright" content="Joaxin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://u.pinsflora.com/web/js/web_js_ajax/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="AJAX"><meta property="og:url" content="https://u.pinsflora.com/web/js/web_js_ajax/"><meta property="og:site_name" content="Pinsflora"><meta property="og:description" content="new Promise(resolve, reject)&#x3D;&gt; ???"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2018-03-01T16:00:00.000Z"><meta property="article:modified_time" content="2019-05-20T16:00:00.000Z"><meta name="twitter:card" content="summary"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-177831205-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-177831205-1');
</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.1.1',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime: 'days',
  date_suffix: {"one_hour":"Just","hours":"hours ago","day":"days ago"},
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"Press","message_next":"to bookmark this page"},"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
    },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2019-05-21 00:00:00'
}</script><noscript><style type="text/css">
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
  }
}

var autoChangeMode = 'false'
var t = saveToLocal.get('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (saveToLocal.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Pinsflora" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://avatars2.githubusercontent.com/u/8346164?s=460&amp;v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">273</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">99</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">34</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-file-image-o"></i><span> Galleries</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> Games</span></a></li><li><a class="site-page" href="/tools/"><i class="fa-fw fas fa-wrench"></i><span> Tools</span></a></li></ul></div></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#what-is-the-problem-here"><span class="toc-number">1.</span> <span class="toc-text"> What is the problem here?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a-basic-ajax-request"><span class="toc-number">2.</span> <span class="toc-text"> A basic Ajax request</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#xmlhttprequest"><span class="toc-number">2.1.</span> <span class="toc-text"> XMLHttpRequest</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fetch"><span class="toc-number">2.2.</span> <span class="toc-text"> Fetch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a-more-complex-example"><span class="toc-number">3.</span> <span class="toc-text"> A more complex example</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sending-forms-data"><span class="toc-number">4.</span> <span class="toc-text"> Sending forms data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#how-is-it-different"><span class="toc-number">4.1.</span> <span class="toc-text"> How is it different?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sending-form-data"><span class="toc-number">4.2.</span> <span class="toc-text"> Sending form data</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#building-an-xmlhttprequest-manually"><span class="toc-number">4.2.1.</span> <span class="toc-text"> Building an XMLHttpRequest manually</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#using-xmlhttprequest-and-the-formdata-object"><span class="toc-number">4.2.2.</span> <span class="toc-text"> Using XMLHttpRequest and the FormData object</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#building-a-dom-in-a-hidden-iframe"><span class="toc-number">4.2.3.</span> <span class="toc-text"> Building a DOM in a hidden iframe</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dealing-with-binary-data"><span class="toc-number">4.3.</span> <span class="toc-text"> Dealing with binary data</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#references"><span class="toc-number">5.</span> <span class="toc-text"> REFERENCES</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Pinsflora</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-file-image-o"></i><span> Galleries</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> Games</span></a></li><li><a class="site-page" href="/tools/"><i class="fa-fw fas fa-wrench"></i><span> Tools</span></a></li></ul></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">AJAX</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2018-03-01T16:00:00.000Z" title="Created 2018-03-02 00:00:00">2018-03-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2019-05-20T16:00:00.000Z" title="Updated 2019-05-21 00:00:00">2019-05-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/">Web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/JS/">JS</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">3.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>21min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="what-is-the-problem-here"><a class="markdownIt-Anchor" href="#what-is-the-problem-here"></a> What is the problem here?</h2>
<p>Originally page loading on the web was simple — you’d send a request for a website to a server, and as long as nothing went wrong, the assets that made the web page would be downloaded and displayed on your computer.</p>
<p>The trouble with this model is that whenever you want to update any part of the page, for example, to display a new set of products or load a new page, you’ve got to load the entire page again. This is extremely wasteful and results in a poor user experience, especially as pages get larger and more complex.</p>
<p>Let’s think about the significance of this:</p>
<ol>
<li>Go to one of your favorite information-rich sites, like Amazon, YouTube, CNN, etc., and load it.</li>
<li>Now search for something, like a new product. The main content will change, but most of the surrounding information, like the header, footer, navigation menu, etc., will stay the same.</li>
</ol>
<p>This is a really good thing because:</p>
<ul>
<li>Page updates are a lot quicker and you don’t have to wait for the page to refresh, meaning that the site feels faster and more responsive.</li>
<li>Less data is downloaded on each update, meaning less wasted bandwidth. This may not be such a big issue on a desktop on a broadband connection, but it’s a major issue on mobile devices and in developing countries that don’t have ubiquitous fast Internet service.</li>
</ul>
<p>This is achieved by using APIs like <code>XMLHttpRequest</code> or — more recently — the Fetch API.</p>
<p>To speed things up even further, some sites also store assets and data on the user’s computer when they are first requested, meaning that on subsequent visits they use the local versions instead of downloading fresh copies when the page is first loaded. The content is only reloaded from the server when it has been updated.</p>
<p><img src="https://mdn.mozillademos.org/files/6479/web-app-architecture@2x.png" alt="A basic web app data flow architecture"></p>
<h2 id="a-basic-ajax-request"><a class="markdownIt-Anchor" href="#a-basic-ajax-request"></a> A basic Ajax request</h2>
<p>Let’s look at how such a request is handled, using both <code>XMLHttpRequest</code>and Fetch. For these simple examples, we’ll request data out of a few different text files and use them to populate a content area.</p>
<h3 id="xmlhttprequest"><a class="markdownIt-Anchor" href="#xmlhttprequest"></a> XMLHttpRequest</h3>
<p><code>XMLHttpRequest</code> (which is frequently abbreviated to XHR) is a fairly old technology now — it was invented by Microsoft in the late '90s, and has been standardized across browsers for quite a long time.</p>
<blockquote>
<p>see <a href="/web/intro/js/web_json">XMLHttpRequest details here</a></p>
</blockquote>
<p><a href="/web/js/fetching/xhr_fetch/web_js_xhr_basic.html">See XHR Live demo here</a></p>
<h3 id="fetch"><a class="markdownIt-Anchor" href="#fetch"></a> Fetch</h3>
<p>The Fetch API is basically a modern replacement for XHR; it was introduced in browsers recently to make asynchronous HTTP requests easier to do in JavaScript, both for developers and other APIs that build on top of Fetch.</p>
<p>Let’s convert the last example to use Fetch instead.</p>
<p>Inside the <code>updateDisplay()</code> function, find the XHR code:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">request.open(<span class="string">'GET'</span>, url);</span><br><span class="line">request.responseType = <span class="string">'text'</span>;</span><br><span class="line"></span><br><span class="line">request.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">  poemDisplay.textContent = request.response;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">request.send();</span><br></pre></td></tr></tbody></table></figure>
<p>Replace all the XHR code with this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fetch(url).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>{</span><br><span class="line">  response.text().then(<span class="function"><span class="keyword">function</span>(<span class="params">text</span>) </span>{</span><br><span class="line">    poemDisplay.textContent = text;</span><br><span class="line">  });</span><br><span class="line">});</span><br><span class="line"><span class="comment">//==</span></span><br><span class="line">fetch(url).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> response.text()</span><br><span class="line">}).then(<span class="function"><span class="keyword">function</span>(<span class="params">text</span>) </span>{</span><br><span class="line">  poemDisplay.textContent = text;</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p><a href="/web/js/fetching/xhr_fetch/web_js_fetch_basic.html">See XHR Live demo here</a></p>
<p>First of all, we invoke the <code>fetch()</code> method, passing it the URL of the resource we want to fetch. This is the modern equivalent of <code>request.open()</code> in XHR, plus you don’t need any equivalent to <code>.send</code>.</p>
<p>After that, you can see the <code>.then()</code> method chained onto the end of <code>fetch</code> — this method is a part of <code>Promises</code>, a modern JavaScript feature for performing asynchronous operations. <code>fetch</code> returns a promise, which resolves to the response sent back from the server — we use <code>.then</code> to run some follow-up code after the promise resolves, which is the function we’ve defined inside it. This is the equivalent of the <code>onload</code> event handler in the XHR version.</p>
<p>This function is automatically given the response from the server as a parameter when the <code>fetch</code> promise resolves. Inside the function we grab the response and run its <code>text()</code>method, which basically returns the response as raw text. This is the equivalent of <code>request.responseType = 'text'</code> in the XHR version.</p>
<p>You’ll see that <code>text</code> also returns a promise, so we chain another <code>.then</code> onto it, inside of which we define a function to receive the raw text that the <code>text</code> promise resolves to.</p>
<h2 id="a-more-complex-example"><a class="markdownIt-Anchor" href="#a-more-complex-example"></a> A more complex example</h2>
<p>To round off the article, we’ll look at a slightly more complex example that shows some more interesting uses of Fetch.</p>
<p>By default, the site displays all the products, but you can use the form controls in the left hand column to filter them by category, or search term, or both.</p>
<p>There is quite a lot of complex code that deals with filtering the products by category and search terms, manipulating strings so the data displays correctly in the UI, etc. We won’t discuss all of it in the article, but you can find extensive comments in the source code .</p>
<p>We will however explain the Fetch code.</p>
<p>The first block that uses Fetch can be found at the start of the JavaScript:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">'products.json'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> response.json();</span><br><span class="line">}).then(<span class="function"><span class="keyword">function</span>(<span class="params">json</span>) </span>{</span><br><span class="line">  products = json;</span><br><span class="line">  initialize();</span><br><span class="line">}).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Fetch problem: '</span> + err.message);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>The <code>fetch()</code> function returns a <code>promise</code>. If this completes successfully, the function inside the first <code>.then()</code> block contains the <code>response</code> returned from the network.</p>
<p>Next, we chain another <code>.then()</code> onto the end of our first one, the success function that contains the <code>json</code> returned from the <code>response.json()</code> promise. We set this to be the value of the products global object, then run <code>initialize()</code>, which starts the process of displaying all the products in the user interface.</p>
<p>To handle errors, we chain a <code>.catch()</code> block onto the end of the chain. This runs if the promise fails for some reason. Inside it, we include a function that is passed as a parameter, an <code>error</code> object. This <code>error</code> object can be used to report the nature of the error that has occurred, in this case we do it with a simple <code>console.log()</code>.</p>
<p>However, a complete website would handle this error more gracefully by displaying a message on the user’s screen and perhaps offering options to remedy the situation, but we don’t need anything more than a simple <code>console.log()</code>.</p>
<p>The second Fetch block can be found inside the <code>fetchBlob()</code> function:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fetch(url).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> response.blob();</span><br><span class="line">}).then(<span class="function"><span class="keyword">function</span>(<span class="params">blob</span>) </span>{</span><br><span class="line">  <span class="comment">// Convert the blob to an object URL — this is basically an temporary internal URL</span></span><br><span class="line">  <span class="comment">// that points to an object stored inside the browser</span></span><br><span class="line">  <span class="keyword">var</span> objectURL = URL.createObjectURL(blob);</span><br><span class="line">  <span class="comment">// invoke showProduct</span></span><br><span class="line">  showProduct(objectURL, product);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>This works in much the same way as the previous one, except that instead of using <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Body/json"><code>json()</code></a>, we use <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Body/blob"><code>blob()</code></a>. In this case we want to return our response as an image file, and the data format we use for that is <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Blob">Blob</a> (the term is an abbreviation of “Binary Large Object” and can basically be used to represent large file-like objects, such as images or video files).</p>
<p>Once we’ve successfully received our blob, we create an object URL out of it using <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL"><code>createObjectURL()</code></a>. This returns a temporary internal URL that points to an object referenced inside the browser. These are not very readable, but you can see what one looks like by opening up the Can Store app, Ctrl-/Right-clicking on an image, and selecting the “View image” option (which might vary slightly depending on what browser you are using). The object URL will be visible inside the address bar, and should be something like this:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blob:http://localhost:7800/9b75250e-5279-e249-884f-d03eb1fd84f4</span><br></pre></td></tr></tbody></table></figure>
<p><a href="/web/js/fetching/can-store/index.html">See Fetch demo here</a></p>
<p><a href="/web/js/fetching/can-store/index_xhr.html">See XHR demo here</a></p>
<h2 id="sending-forms-data"><a class="markdownIt-Anchor" href="#sending-forms-data"></a> Sending forms data</h2>
<p>Standard HTML form submission loads the URL where the data was sent, which means the browser window navigates with a full page load. Avoiding a full page load can provide a smoother experience by hiding flickering and network lag.</p>
<p>Many modern UIs only use HTML forms to collect input from the user. When the user tries to send the data, the application takes control and transmits the data asynchronously in the background, updating only the parts of the UI that require changes.</p>
<p>Sending arbitrary data asynchronously is known as AJAX, which stands for “Asynchronous JavaScript And XML.”</p>
<h3 id="how-is-it-different"><a class="markdownIt-Anchor" href="#how-is-it-different"></a> How is it different?</h3>
<p>AJAX uses the <code>XMLHttpRequest</code> (XHR) DOM object. It can build HTTP requests, send them, and retrieve their results.</p>
<blockquote>
<p><strong>Note:</strong> Older AJAX techniques might not rely on <code>XMLHttpRequest</code>. For example, JSONP combined with the <code>eval()</code> function. It works, but it’s not recommended because of serious security issues. The only reason to use this is for legacy browsers that lack support for <code>XMLHttpRequest</code> or JSON, but those are very old browsers indeed! <strong>Avoid such techniques.</strong></p>
</blockquote>
<p>Historically, <code>XMLHttpRequest</code> was designed to fetch and send XML as an exchange format. However, JSON superseded XML and is overwhelmingly more common today.</p>
<p>But neither XML nor JSON fit into form data request encoding. Form data (<code>application/x-www-form-urlencoded</code>) is made of URL-encoded lists of key/value pairs. For transmitting binary data, the HTTP request is reshaped into <code>multipart/form-data</code>.</p>
<h3 id="sending-form-data"><a class="markdownIt-Anchor" href="#sending-form-data"></a> Sending form data</h3>
<p>There are 3 ways to send form data, from legacy techniques to the newer <code>FormData</code>]object. Let’s look at them in detail.</p>
<h4 id="building-an-xmlhttprequest-manually"><a class="markdownIt-Anchor" href="#building-an-xmlhttprequest-manually"></a> Building an XMLHttpRequest manually</h4>
<p><code>XMLHttpRequest</code> is the safest and most reliable way to make HTTP requests. To send form data with <code>XMLHttpRequest</code>, prepare the data by URL-encoding it, and obey the specifics of form data requests.</p>
<p>Let’s see a simple example:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"sendData({test:'ok'})"</span>&gt;</span>Click Me!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>As you can see, the HTML hasn’t really changed. However, the JavaScript is completely different:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendData</span>(<span class="params">data</span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log( <span class="string">'Sending data'</span> );</span><br><span class="line">  <span class="keyword">const</span> XHR = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  <span class="keyword">let</span> urlEncodedData = <span class="string">""</span>,</span><br><span class="line">      urlEncodedDataPairs = [],</span><br><span class="line">      name;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Turn the data object into an array of URL-encoded key/value pairs.</span></span><br><span class="line">  <span class="keyword">for</span>(name <span class="keyword">in</span> data) {</span><br><span class="line">    urlEncodedDataPairs.push(<span class="built_in">encodeURIComponent</span>(name) + <span class="string">'='</span> + <span class="built_in">encodeURIComponent</span>(data[name]));</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Combine the pairs into a single string and replace all %-encoded spaces to </span></span><br><span class="line">  <span class="comment">// the '+' character; matches the behaviour of browser form submissions.</span></span><br><span class="line">  urlEncodedData = urlEncodedDataPairs.join(<span class="string">'&amp;'</span>).replace(<span class="regexp">/%20/g</span>, <span class="string">'+'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define what happens on successful data submission</span></span><br><span class="line">  XHR.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>{</span><br><span class="line">    alert(<span class="string">'Yeah! Data sent and response loaded.'</span>);</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define what happens in case of error</span></span><br><span class="line">  XHR.addEventListener(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>{</span><br><span class="line">    alert(<span class="string">'Oops! Something goes wrong.'</span>);</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set up our request</span></span><br><span class="line">  XHR.open(<span class="string">'POST'</span>, <span class="string">'https://example.com/cors.php'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the required HTTP header for form data POST requests</span></span><br><span class="line">  XHR.setRequestHeader(<span class="string">'Content-Type'</span>, <span class="string">'application/x-www-form-urlencoded'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Finally, send our data.</span></span><br><span class="line">  XHR.send(urlEncodedData);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>Access to XMLHttpRequest at ‘<a target="_blank" rel="noopener" href="https://example.com/cors.php">https://example.com/cors.php</a>’ from origin ‘…’ has been blocked by CORS policy: No ‘Access-Control-Allow-Origin’ header is present on the requested resource.</p>
</blockquote>
<p><strong>Note:</strong> This use of <code>XMLHttpRequest</code>is subject to the same origin policy if you want to send data to a third party web site. For cross-origin requests, you’ll need <code>CORS and HTTP access control</code>.</p>
<h4 id="using-xmlhttprequest-and-the-formdata-object"><a class="markdownIt-Anchor" href="#using-xmlhttprequest-and-the-formdata-object"></a> Using XMLHttpRequest and the FormData object</h4>
<p>The <code>FormData</code>object can be used to build form data for transmission, or to get the data within a form element to manage how it’s sent. Note that <code>FormData</code> objects are “write only”, which means you can change them, but not retrieve their contents.</p>
<p>here are two examples:</p>
<p><strong>Using a standalone FormData object</strong></p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"sendData({test:'ok'})"</span>&gt;</span>Click Me!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>You should be familiar with that HTML sample.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendData</span>(<span class="params">data</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> XHR = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  <span class="keyword">var</span> FD  = <span class="keyword">new</span> FormData();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Push our data into our FormData object</span></span><br><span class="line">  <span class="keyword">for</span>(name <span class="keyword">in</span> data) {</span><br><span class="line">    FD.append(name, data[name]);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define what happens on successful data submission</span></span><br><span class="line">  XHR.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>{</span><br><span class="line">    alert(<span class="string">'Yeah! Data sent and response loaded.'</span>);</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define what happens in case of error</span></span><br><span class="line">  XHR.addEventListener(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>{</span><br><span class="line">    alert(<span class="string">'Oops! Something went wrong.'</span>);</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set up our request</span></span><br><span class="line">  XHR.open(<span class="string">'POST'</span>, <span class="string">'https://example.com/cors.php'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Send our FormData object; HTTP headers are set automatically</span></span><br><span class="line">  XHR.send(FD);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>Cross-Origin Request Blocked: The Same Origin Policy disallows reading the remote resource at <a target="_blank" rel="noopener" href="https://example.com/cors.php">https://example.com/cors.php</a>. (Reason: CORS header ‘Access-Control-Allow-Origin’ missing).</p>
</blockquote>
<p><strong>Using FormData bound to a form element</strong></p>
<p>You can also bind a <code>FormData</code> object to a form element. This creates a <code>FormData</code> that represents the data contained in the form.</p>
<p>The HTML is typical:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"myForm"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"myName"</span>&gt;</span>Send me your name:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"myName"</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"John"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Send Me!"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>But JavaScript takes over the form:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">"load"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sendData</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">var</span> XHR = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bind the FormData object and the form element</span></span><br><span class="line">    <span class="keyword">var</span> FD = <span class="keyword">new</span> FormData(form);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define what happens on successful data submission</span></span><br><span class="line">    XHR.addEventListener(<span class="string">"load"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>{</span><br><span class="line">      alert(event.target.responseText);</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define what happens in case of error</span></span><br><span class="line">    XHR.addEventListener(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>{</span><br><span class="line">      alert(<span class="string">'Oops! Something went wrong.'</span>);</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set up our request</span></span><br><span class="line">    XHR.open(<span class="string">"POST"</span>, <span class="string">"https://example.com/cors.php"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The data sent is what the user provided in the form</span></span><br><span class="line">    XHR.send(FD);</span><br><span class="line">  }</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Access the form element...</span></span><br><span class="line">  <span class="keyword">var</span> form = <span class="built_in">document</span>.getElementById(<span class="string">"myForm"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...and take over its submit event.</span></span><br><span class="line">  form.addEventListener(<span class="string">"submit"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>{</span><br><span class="line">    event.preventDefault();</span><br><span class="line"></span><br><span class="line">    sendData();</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>Cross-Origin Request Blocked: The Same Origin Policy disallows reading the remote resource at <a target="_blank" rel="noopener" href="https://example.com/cors.php">https://example.com/cors.php</a>. (Reason: CORS header ‘Access-Control-Allow-Origin’ missing)</p>
</blockquote>
<h4 id="building-a-dom-in-a-hidden-iframe"><a class="markdownIt-Anchor" href="#building-a-dom-in-a-hidden-iframe"></a> Building a DOM in a hidden iframe</h4>
<p>The oldest way to asynchronously send form data is building a form with the DOM API, then sending its data into a hidden <code>iframe</code>.</p>
<p><strong>Warning:</strong> <strong>Avoid using this technique.</strong> It’s a security risk with third-party services because it leaves you open to <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Cross-site_scripting">script injection attacks</a>. If you use HTTPS, it can affect <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/JavaScript/Same_origin_policy_for_JavaScript">the same origin policy</a>, which can render the content of an iframe unreachable. However, this method may be your only option if you need to support very old browsers.</p>
<p>Here is an example:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onclick=<span class="string">"sendData({test:'ok'})"</span>&gt;Click Me!&lt;/button&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the iFrame used to send our data</span></span><br><span class="line"><span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>);</span><br><span class="line">iframe.name = <span class="string">"myTarget"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Next, attach the iFrame to the main document</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">"load"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">  iframe.style.display = <span class="string">"none"</span>;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(iframe);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is the function used to actually send the data</span></span><br><span class="line"><span class="comment">// It takes one parameter, which is an object populated with key/value pairs.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendData</span>(<span class="params">data</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> name,</span><br><span class="line">      form = <span class="built_in">document</span>.createElement(<span class="string">"form"</span>),</span><br><span class="line">      node = <span class="built_in">document</span>.createElement(<span class="string">"input"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define what happens when the response loads</span></span><br><span class="line">  iframe.addEventListener(<span class="string">"load"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    alert(<span class="string">"Yeah! Data sent."</span>);</span><br><span class="line">  });</span><br><span class="line">    </span><br><span class="line">  form.action = <span class="string">"http://www.cs.tut.fi/cgi-bin/run/~jkorpela/echo.cgi"</span>;</span><br><span class="line">  form.target = iframe.name;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(name <span class="keyword">in</span> data) {</span><br><span class="line">    node.name  = name;</span><br><span class="line">    node.value = data[name].toString();</span><br><span class="line">    form.appendChild(node.cloneNode());</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// To be sent, the form needs to be attached to the main document.</span></span><br><span class="line">  form.style.display = <span class="string">"none"</span>;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(form);</span><br><span class="line"></span><br><span class="line">  form.submit();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Once the form is sent, remove it.</span></span><br><span class="line">  <span class="built_in">document</span>.body.removeChild(form);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="dealing-with-binary-data"><a class="markdownIt-Anchor" href="#dealing-with-binary-data"></a> Dealing with binary data</h3>
<p>If you use a <code>FormData</code> object with a form that includes <code>&lt;input type="file"&gt;</code> widgets, the data will be processed automatically. But to send binary data by hand, there’s extra work to do.</p>
<p>There are many sources for binary data on the modern Web: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/FileReader"><code>FileReader</code></a>, <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement"><code>Canvas</code></a>, and <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/WebRTC/navigator.getUserMedia">WebRTC</a>, for example. Unfortunately, some legacy browsers can’t access binary data or require complicated workarounds. Those legacy cases are out of this article’s scope. If you want to know more about the <code>FileReader</code> API, read <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications">Using files from web applications</a>.</p>
<p>Sending binary data with support for <code>FormData</code> is straightfoward. Use the <code>append()</code> method and you’re done. If you have to do it by hand, it’s trickier.</p>
<p>In the following example, we use the <code>FileReader</code> API to access binary data and then build the multi-part form data request by hand:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"myForm"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"i1"</span>&gt;</span>text data:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"i1"</span> <span class="attr">name</span>=<span class="string">"myText"</span> <span class="attr">value</span>=<span class="string">"Some text data"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"i2"</span>&gt;</span>file data:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"i2"</span> <span class="attr">name</span>=<span class="string">"myFile"</span> <span class="attr">type</span>=<span class="string">"file"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>Send Me!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>As you see, the HTML is a standard <code>&lt;form&gt;</code>. There’s nothing magical going on. The “magic” is in the JavaScript:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Because we want to access DOM node,</span></span><br><span class="line"><span class="comment">// we initialize our script at page load.</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line"></span><br><span class="line">  <span class="comment">// These variables are used to store the form data</span></span><br><span class="line">  <span class="keyword">var</span> text = <span class="built_in">document</span>.getElementById(<span class="string">"i1"</span>);</span><br><span class="line">  <span class="keyword">var</span> file = {</span><br><span class="line">        dom    : <span class="built_in">document</span>.getElementById(<span class="string">"i2"</span>),</span><br><span class="line">        binary : <span class="literal">null</span></span><br><span class="line">      };</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Use the FileReader API to access file content</span></span><br><span class="line">  <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Because FileReader is asynchronous, store its</span></span><br><span class="line">  <span class="comment">// result when it finishes to read the file</span></span><br><span class="line">  reader.addEventListener(<span class="string">"load"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    file.binary = reader.result;</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// At page load, if a file is already selected, read it.</span></span><br><span class="line">  <span class="keyword">if</span>(file.dom.files[<span class="number">0</span>]) {</span><br><span class="line">    reader.readAsBinaryString(file.dom.files[<span class="number">0</span>]);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If not, read the file once the user selects it.</span></span><br><span class="line">  file.dom.addEventListener(<span class="string">"change"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>{</span><br><span class="line">    <span class="keyword">if</span>(reader.readyState === FileReader.LOADING) {</span><br><span class="line">      reader.abort();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    reader.readAsBinaryString(file.dom.files[<span class="number">0</span>]);</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sendData is our main function</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sendData</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="comment">// If there is a selected file, wait it is read</span></span><br><span class="line">    <span class="comment">// If there is not, delay the execution of the function</span></span><br><span class="line">    <span class="keyword">if</span>(!file.binary &amp;&amp; file.dom.files.length &gt; <span class="number">0</span>) {</span><br><span class="line">      <span class="built_in">setTimeout</span>(sendData, <span class="number">10</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// To construct our multipart form data request,</span></span><br><span class="line">    <span class="comment">// We need an XMLHttpRequest instance</span></span><br><span class="line">    <span class="keyword">var</span> XHR = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We need a separator to define each part of the request</span></span><br><span class="line">    <span class="keyword">var</span> boundary = <span class="string">"blob"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Store our body request in a string.</span></span><br><span class="line">    <span class="keyword">var</span> data = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// So, if the user has selected a file</span></span><br><span class="line">    <span class="keyword">if</span> (file.dom.files[<span class="number">0</span>]) {</span><br><span class="line">      <span class="comment">// Start a new part in our body's request</span></span><br><span class="line">      data += <span class="string">"--"</span> + boundary + <span class="string">"\r\n"</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Describe it as form data</span></span><br><span class="line">      data += <span class="string">'content-disposition: form-data; '</span></span><br><span class="line">      <span class="comment">// Define the name of the form data</span></span><br><span class="line">            + <span class="string">'name="'</span>         + file.dom.name          + <span class="string">'"; '</span></span><br><span class="line">      <span class="comment">// Provide the real name of the file</span></span><br><span class="line">            + <span class="string">'filename="'</span>     + file.dom.files[<span class="number">0</span>].name + <span class="string">'"\r\n'</span>;</span><br><span class="line">      <span class="comment">// And the MIME type of the file</span></span><br><span class="line">      data += <span class="string">'Content-Type: '</span> + file.dom.files[<span class="number">0</span>].type + <span class="string">'\r\n'</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// There's a blank line between the metadata and the data</span></span><br><span class="line">      data += <span class="string">'\r\n'</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Append the binary data to our body's request</span></span><br><span class="line">      data += file.binary + <span class="string">'\r\n'</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Text data is simpler</span></span><br><span class="line">    <span class="comment">// Start a new part in our body's request</span></span><br><span class="line">    data += <span class="string">"--"</span> + boundary + <span class="string">"\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Say it's form data, and name it</span></span><br><span class="line">    data += <span class="string">'content-disposition: form-data; name="'</span> + text.name + <span class="string">'"\r\n'</span>;</span><br><span class="line">    <span class="comment">// There's a blank line between the metadata and the data</span></span><br><span class="line">    data += <span class="string">'\r\n'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Append the text data to our body's request</span></span><br><span class="line">    data += text.value + <span class="string">"\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Once we are done, "close" the body's request</span></span><br><span class="line">    data += <span class="string">"--"</span> + boundary + <span class="string">"--"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define what happens on successful data submission</span></span><br><span class="line">    XHR.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>{</span><br><span class="line">      alert(<span class="string">'Yeah! Data sent and response loaded.'</span>);</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define what happens in case of error</span></span><br><span class="line">    XHR.addEventListener(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>{</span><br><span class="line">      alert(<span class="string">'Oops! Something went wrong.'</span>);</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set up our request</span></span><br><span class="line">    XHR.open(<span class="string">'POST'</span>, <span class="string">'https://example.com/cors.php'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add the required HTTP header to handle a multipart form data POST request</span></span><br><span class="line">    XHR.setRequestHeader(<span class="string">'Content-Type'</span>,<span class="string">'multipart/form-data; boundary='</span> + boundary);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// And finally, send our data.</span></span><br><span class="line">    XHR.send(data);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Access our form...</span></span><br><span class="line">  <span class="keyword">var</span> form = <span class="built_in">document</span>.getElementById(<span class="string">"myForm"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...to take over the submit event</span></span><br><span class="line">  form.addEventListener(<span class="string">'submit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>{</span><br><span class="line">    event.preventDefault();</span><br><span class="line">    sendData();</span><br><span class="line">  });</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>Access to XMLHttpRequest at ‘<a target="_blank" rel="noopener" href="https://example.com/cors.php">https://example.com/cors.php</a>’ from origin ‘…’ has been blocked by CORS policy: No ‘Access-Control-Allow-Origin’ header is present on the requested resource.</p>
</blockquote>
<h2 id="references"><a class="markdownIt-Anchor" href="#references"></a> REFERENCES</h2>
<p>For a lot more detail on these subjects, try the following articles:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Client-side_web_APIs/Fetching_data">https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Client-side_web_APIs/Fetching_data</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/HTML/Forms/Sending_forms_through_JavaScript">https://developer.mozilla.org/en-US/docs/Learn/HTML/Forms/Sending_forms_through_JavaScript</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Glossary/Ajax">https://developer.mozilla.org/en-US/docs/Glossary/Ajax</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/AJAX">https://developer.mozilla.org/en-US/docs/AJAX</a>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/AJAX/Getting_Started">https://developer.mozilla.org/en-US/docs/AJAX/Getting_Started</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API</a>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch">https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/Server-side">https://developer.mozilla.org/en-US/docs/Learn/Server-side</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Client-side_web_APIs/Fetching_data">https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Client-side_web_APIs/Fetching_data</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement.elements#Accessing_the_element_list's_contents">Accessing the element list’s contents</a> in <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement.elements">HTMLFormElement.elements</a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/3120320">This gist</a> polyfills <code>FormData</code> with <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers"><code>Web Workers</code></a>.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/francois2metz/html5-formdata">HTML5-formdata</a> attempts to polyfill the <code>FormData</code> object, but it requires the <a target="_blank" rel="noopener" href="http://www.w3.org/TR/FileAPI/">File API</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jimmywarting/FormData">This polyfill</a> provides most of the new methods FormData has (entries, keys, values, and support of <code>for...of</code>)</li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Joaxin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://u.pinsflora.com/web/js/web_js_ajax/">https://u.pinsflora.com/web/js/web_js_ajax/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/AJAX/">AJAX</a></div><div class="post_share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_wechat"></a><a class="a2a_button_sina_weibo"></a><a class="a2a_button_facebook_messenger"></a><a class="a2a_button_email"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a></div></div><script async="async" src="https://static.addtoany.com/menu/page.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/web/js/web_json/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover_posts/js/JSON.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">JSON</div></div></a></div><div class="next-post pull-right"><a href="/web/html/web_html_intro/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_erol-ahmed-unsplash.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">HTML Introduction</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div></div></div></div></article></main><footer id="footer" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2020 By Joaxin</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Refine, the Life</div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    $.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js', function () {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="fasle"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/fae45343.js","daovoice")
</script><script>var isChatBtn = true
daovoice('init', {
  app_id: 'fae45343',},{
  launcher: { 
     disableLauncherIcon: isChatBtn // 悬浮 ICON 是否显示
  },
});
daovoice('update');

if (isChatBtn) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      daovoice('show')
    });
  }
  chatBtnFn()
} else {
  if (true) {
    function chatBtnHide () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: true // 悬浮 ICON 是否显示
        },
      });
    }
    function chatBtnShow () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: false // 悬浮 ICON 是否显示
        },
      });
    }
  }
}</script></div></body></html>