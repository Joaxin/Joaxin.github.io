<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>JS asynchronous programming - Promise Async Await | Pinsflora</title><meta name="keywords" content="Javascript"><meta name="author" content="Joaxin"><meta name="copyright" content="Joaxin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Important concepts relating to asynchronous programming.">
<meta property="og:type" content="article">
<meta property="og:title" content="JS asynchronous programming - Promise Async Await">
<meta property="og:url" content="https://u.pinsflora.xyz/Web/js/web_js_async/index.html">
<meta property="og:site_name" content="Pinsflora">
<meta property="og:description" content="Important concepts relating to asynchronous programming.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_books3.jpg">
<meta property="article:published_time" content="2017-12-20T16:00:00.000Z">
<meta property="article:modified_time" content="2019-08-31T16:00:00.000Z">
<meta property="article:author" content="Joaxin">
<meta property="article:tag" content="Javascript">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_books3.jpg"><link rel="shortcut icon" href="/img/favicon-32x32.png"><link rel="canonical" href="https://u.pinsflora.xyz/Web/js/web_js_async/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-177831205-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-177831205-1');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":600,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2019-09-01 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="Pinsflora" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://avatars2.githubusercontent.com/u/8346164?s=460&amp;v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">340</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">110</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">34</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Galleries"><i class="fa-fw /gallery/"></i><span> 0</span></a></li><li><a class="site-page child" href="/Movie"><i class="fa-fw /movies/"></i><span> 1</span></a></li><li><a class="site-page child" href="/Games"><i class="fa-fw /games/"></i><span> 2</span></a></li><li><a class="site-page child" href="/Tools"><i class="fa-fw /tools/"></i><span> 3</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_books3.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Pinsflora</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Galleries"><i class="fa-fw /gallery/"></i><span> 0</span></a></li><li><a class="site-page child" href="/Movie"><i class="fa-fw /movies/"></i><span> 1</span></a></li><li><a class="site-page child" href="/Games"><i class="fa-fw /games/"></i><span> 2</span></a></li><li><a class="site-page child" href="/Tools"><i class="fa-fw /tools/"></i><span> 3</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">JS asynchronous programming - Promise Async Await</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2017-12-20T16:00:00.000Z" title="Created 2017-12-21 00:00:00">2017-12-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2019-08-31T16:00:00.000Z" title="Updated 2019-09-01 00:00:00">2019-09-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/">Web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/JS/">JS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">14.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>90min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="JS asynchronous programming - Promise Async Await"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="concepts"><a class="markdownIt-Anchor" href="#concepts"></a> Concepts</h2>
<p>Normally, a given program’s code runs straight along, with only one thing happening at once. If a function relies on the result of another function, it has to wait for the other function to finish and return, and until that happens, the entire program is essentially stopped from the perspective of the user.</p>
<h3 id="blocking-code"><a class="markdownIt-Anchor" href="#blocking-code"></a> Blocking code</h3>
<p>Asynchronous techniques are very useful, particularly in web programming. When a web app runs in a browser and it executes an intensive chunk of code without returning control to the browser, the browser can appear to be frozen. This is called <strong>blocking</strong>; the browser is blocked from continuing to handle user input and perform other tasks until the web app returns control of the processor.</p>
<p>In this example, we simulate something slightly more realistic that you might come across on a real page. We block user interactivity with rendering of the UI. In this example, we have two buttons:</p>
<ul>
<li>A “Fill canvas” button that when clicked fills the available <code>canvas</code> with 1 million blue circles.</li>
<li>A “Click me for alert” button that when clicked shows an alert message.</li>
</ul>
<p><a href="web/js/async/intro/web_js_async_test.html" target="_blank">See Live Here</a></p>
<p>If you click the first button and then quickly click the second one, you’ll see that the alert does not appear until the circles have finished being rendered. The first operation blocks the second one until it has finished running.</p>
<p>Why is this? The answer is because JavaScript, generally speaking, is <strong>single threaded</strong>. At this point we need to introduce the concept of <strong>threads</strong>.</p>
<h3 id="threads"><a class="markdownIt-Anchor" href="#threads"></a> Threads</h3>
<p>A <strong>thread</strong> is basically a single process that a program can use to complete tasks. Each thread can only do a single task at once:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Task A --&gt; Task B --&gt; Task C</span><br></pre></td></tr></tbody></table></figure>
<p>Each task will be run sequentially; a task has to complete before the next one can be started.</p>
<p>As we said earlier, many computers now have multiple cores, so can do multiple things at once. Programming languages that can support multiple threads can use multiple cores to complete multiple tasks simultaneously:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thread 1: Task A --&gt; Task B</span><br><span class="line">Thread 2: Task C --&gt; Task D</span><br></pre></td></tr></tbody></table></figure>
<h3 id="javascript-is-single-threaded"><a class="markdownIt-Anchor" href="#javascript-is-single-threaded"></a> JavaScript is single threaded</h3>
<p>JavaScript is traditionally single-threaded. Even with multiple cores, you could only get it to run tasks on a single thread, called the <strong>main thread</strong>. Our example from above is run like this:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Main thread: Render circles to canvas --&gt; Display alert()</span><br></pre></td></tr></tbody></table></figure>
<p>After some time, JavaScript gained some tools to help with such problems. <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API">Web workers</a> allow you to send some of the JavaScript processing off to a separate thread, called a worker, so that you can run multiple JavaScript chunks simultaneously. You’d generally use a worker to run expensive processes off the main thread so that user interaction is not blocked.</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Main thread: Task A --&gt; Task C</span><br><span class="line">Worker thread: Expensive task B</span><br></pre></td></tr></tbody></table></figure>
<p>With this in mind, have a look at <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/introducing/simple-sync-worker.html">simple-sync-worker.html</a> (<a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/introducing/simple-sync-worker.html">see it running live</a>), again with your browser’s JavaScript console open. This is a rewrite of our previous example that calculates the 10 million dates in a separate worker thread. Now when you click the button, the browser is able to display the paragraph before the dates have finished calculating. The first operation no longer blocks the second.</p>
<h3 id="asynchronous-code"><a class="markdownIt-Anchor" href="#asynchronous-code"></a> Asynchronous code</h3>
<p>Web workers are pretty useful, but they do have their limitations. A major one is they are not able to access the DOM — you can’t get a worker to directly do anything to update the UI. We couldn’t render our 1 million blue circles inside our worker; it can basically just do number crunching.</p>
<p>The second problem is that although code run in a worker is not blocking, it is still basically synchronous. This becomes a problem when a function relies on the results of multiple previous processes to function. Consider the following thread diagrams:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Main thread: Task A --&gt; Task B</span><br></pre></td></tr></tbody></table></figure>
<p>In this case, let’s say Task A is doing something like fetching an image from the server and Task B then does something to the image like applying a filter to it. If you start Task A running and then immediately try to run Task B, you’ll get an error, because the image won’t be available yet.</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Main thread: Task A --&gt; Task B --&gt; |Task D|</span><br><span class="line">Worker thread: Task C -----------&gt; |      |</span><br></pre></td></tr></tbody></table></figure>
<p>In this case, let’s say Task D makes use of the results of both Task B and Task C. If we can guarantee that these results will both be available at the same time, then we might be OK, but this is unlikely. If Task D tries to run when one of its inputs is not yet available, it will throw an error.</p>
<p>To fix such problems, browsers allow us to run certain operations asynchronously. Features like <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promises</a> allow you to set an operation running (e.g. the fetching of an image from the server), and then wait until the result has returned before running another operation:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Main thread: Task A                   Task B</span><br><span class="line">    Promise:      |__async operation__|</span><br></pre></td></tr></tbody></table></figure>
<p>Since the operation is happening somewhere else, the main thread is not blocked while the async operation is being processed.</p>
<p>We’ll start to look at how we can write asynchronous code in the next article. Exciting stuff, huh? Keep reading!</p>
<h3 id="synchronous-javascript"><a class="markdownIt-Anchor" href="#synchronous-javascript"></a> Synchronous JavaScript</h3>
<p>Let’s look at a simple synchronous example (<a href="web/js/async/intro/web_js_async_intro_basic_example.html" target="_blank">See Live Here</a>).</p>
<p>While each operation is being processed, nothing else can happen — rendering is paused. This is because only one thing can happen at a time, on a single main thread, and everything else is blocked until an operation completes.</p>
<p>So in the example above, after you’ve clicked the button the paragraph won’t appear until after the OK button is pressed in the alert box. You can try it for yourself:</p>
<blockquote>
<p><strong>Note</strong>: It is important to remember that <code>alert()</code>, while being very useful for demonstrating a synchronous blocking operation, but it is terrible for use in real world applications.</p>
</blockquote>
<h3 id="asynchronous-javascript"><a class="markdownIt-Anchor" href="#asynchronous-javascript"></a> Asynchronous JavaScript</h3>
<p>For reasons illustrated earlier (e.g. related to blocking), many Web API features now use asynchronous code to run, especially those that access or fetch some kind of resource from an external device, such as fetching a file from the network, accessing a database and returning data from it, accessing a video stream from a webcam, or broadcasting the display to a VR headset.</p>
<p>Why is this difficult to get to work using synchronous code? Let’s look at a quick example. When you fetch an image from a server, you can’t return the result immediately. That means that the following (pseudocode) wouldn’t work:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> response = fetch(<span class="string">'myImage.png'</span>);</span><br><span class="line"><span class="keyword">let</span> blob = response.blob();</span><br><span class="line"><span class="comment">// display your image blob in the UI somehow</span></span><br></pre></td></tr></tbody></table></figure>
<p>That’s because you don’t know how long the image will take to download, so when you come to run the second line it will throw an error (possibly intermittently, possibly every time) because the <code>response</code> is not yet available. Instead, you need your code to wait until the <code>response</code> is returned before it tries to do anything else to it.</p>
<h3 id="async-callbacks"><a class="markdownIt-Anchor" href="#async-callbacks"></a> Async callbacks</h3>
<p>Async callbacks are functions that are specified as arguments when calling a function which will start executing code in the background. When the background code finishes running, it calls the callback function to let you know the work is done, or to let you know that something of interest has happened. Using callbacks is slightly old-fashioned now, but you’ll still see them in use in a number of older-but-still-commonly-used APIs.</p>
<p>An example of an async callback is the second parameter of the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener"><code>addEventListener()</code></a> method (as we saw in action above):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">btn.addEventListener(<span class="string">'click'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  alert(<span class="string">'You clicked me!'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> pElem = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>);</span><br><span class="line">  pElem.textContent = <span class="string">'This is a newly-added paragraph.'</span>;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(pElem);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>The first parameter is the type of event to be listened for, and the second parameter is a callback function that is invoked when the event is fired.</p>
<p>When we pass a callback function as an argument to another function, we are only passing the function’s reference as an argument, i.e, the callback function is <strong>not</strong> executed immediately. It is “called back” (hence the name) asynchronously somewhere inside the containing function’s body. The containing function is responsible for executing the callback function when the time comes.</p>
<p>You can write your own function containing a callback easily enough. Let’s look at another example that loads a resource via the <code>XMLHttpRequest</code> API :</p>
<p><a href="web/js/async/intro/web_js_async_xhr-async-callback.html" target="_blank">See The Page Here</a></p>
<blockquote>
<p><strong>Note</strong>: For security reasons, you can’t <code>fetch()</code> files from your local filesystem (or run other such operations locally); to run the above example locally you’ll have to run the example through a local webserver.</p>
<p>Access to XMLHttpRequest at ‘…coffee.jpg’ from origin ‘null’ has been blocked by CORS policy: Cross origin requests are only supported for protocol schemes: http, data, chrome, chrome-extension, chrome-untrusted, https.<br>
coffee.jpg:1 Failed to load resource: net::ERR_FAILED</p>
</blockquote>
<p>Callbacks are versatile — not only do they allow you to control the order in which functions are run and what data is passed between them, they also allow you to pass data to different functions depending on circumstance. So you could have different actions to run on the response downloaded, such as <code>processJSON()</code>, <code>displayText()</code>, etc.</p>
<h2 id="introduction"><a class="markdownIt-Anchor" href="#introduction"></a> Introduction</h2>
<p>For a long time, the web platform has made available to JavaScript programmers a number of functions that allow you to asynchronously execute code after a certain time interval has elapsed, and to repeatedly execute a block of code asynchronously until you tell it to stop. These are:</p>
<ul>
<li>
<p><code>setTimeout()</code></p>
<p>Execute a specified block of code once after a specified time has elapsed.</p>
</li>
<li>
<p><code>setInterval()</code></p>
<p>Execute a specified block of code repeatedly with a fixed time delay between each call.</p>
</li>
<li>
<p><code>requestAnimationFrame()</code></p>
<p>The modern version of <code>setInterval()</code>; executes a specified block of code before the browser next repaints the display, allowing an animation to be run at a suitable framerate regardless of the environment it is being run in.</p>
</li>
</ul>
<p>The asynchronous code set up by these functions actually runs on the main thread, but you are able to run other code between iterations to a more or less efficient degree, depending on how processor intensive these operations are. In any case, these functions are used for running constant animations and other background processing on a web site or application. In the following sections we will show you how they can be used.</p>
<h3 id="settimeout"><a class="markdownIt-Anchor" href="#settimeout"></a> setTimeout()</h3>
<p>As we said before, <code>setTimeout()</code> executes a particular block of code once after a specified time has elapsed. It takes the following parameters:</p>
<ul>
<li>A function to run, or a reference to function defined elsewhere.</li>
<li>A number representing the time interval in milliseconds (so 1000 equals one second) to wait before executing the code. If you specify a value of 0 (or omit this value altogether), the function will run immediately. More on why you might want to do this later.</li>
<li>Zero or more values that represent any parameters you want to pass to the function when it is run.</li>
</ul>
<p><strong>Note:</strong> Because timeout callbacks are executed cooperatively, there’s no guarantee that they will be called after <em>exactly</em> the specified amount of time. Instead, they will be called after <em>at least</em> that much time has elapsed. Timeout handlers can’t be run until the main thread reaches the point in its execution where it goes through these handlers to find the ones that need to be run.</p>
<p>In the following example, the browser will wait two seconds before executing the anonymous function, then will display the alert message (<a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/simple-settimeout.html">see it running live</a>, and <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/simple-settimeout.html">see the source code</a>):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myGreeting = <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">  alert(<span class="string">'Hello, Mr. Universe!'</span>);</span><br><span class="line">}, <span class="number">2000</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>The functions we specify don’t have to be anonymous. We can give our function a name, and can even define it somewhere else and pass a function reference to the <code>setTimeout()</code>. The following two versions of our code snippet are equivalent to the first one:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// With a named function</span></span><br><span class="line"><span class="keyword">let</span> myGreeting = <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> <span class="title">sayHi</span>(<span class="params"></span>) </span>{</span><br><span class="line">  alert(<span class="string">'Hello, Mr. Universe!'</span>);</span><br><span class="line">}, <span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// With a function defined separately</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHi</span>(<span class="params"></span>) </span>{</span><br><span class="line">  alert(<span class="string">'Hello Mr. Universe!'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myGreeting = <span class="built_in">setTimeout</span>(sayHi, <span class="number">2000</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>That can be useful if we have a function that needs to be called both from a timeout and in response to an event, for example. But it can also just help keep your code tidy, especially if the timeout callback is more than a few lines of code.</p>
<p><code>setTimeout()</code> returns an identifier value that can be used to refer to the timeout later, such as when you want to stop it. See <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Clearing_timeouts">Clearing timeouts</a> below to learn how to do that.</p>
<h3 id="passing-parameters-to-a-settimeout-functionsection"><a class="markdownIt-Anchor" href="#passing-parameters-to-a-settimeout-functionsection"></a> Passing parameters to a setTimeout() function<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Passing_parameters_to_a_setTimeout()_function">Section</a></h3>
<p>Any parameters that we want to pass to the function being run inside the <code>setTimeout()</code> have to be passed to it as additional parameters at the end of the list. For example, we could refactor our previous function so that it will say hi to whatever person’s name is passed to it:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHi</span>(<span class="params">who</span>) </span>{</span><br><span class="line">  alert(<span class="string">'Hello '</span> + who + <span class="string">'!'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The name of the person to say hello to can then be passed into the <code>setTimeout()</code> call as a third parameter:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myGreeting = <span class="built_in">setTimeout</span>(sayHi, <span class="number">2000</span>, <span class="string">'Mr. Universe'</span>);</span><br></pre></td></tr></tbody></table></figure>
<h3 id="clearing-timeoutssection"><a class="markdownIt-Anchor" href="#clearing-timeoutssection"></a> Clearing timeouts<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Clearing_timeouts">Section</a></h3>
<p>Finally, if a timeout has been created, you can cancel it before the specified time has elapsed by calling <code>clearTimeout()</code>, passing it the identifier of the <code>setTimeout()</code> call as a parameter. So to cancel our above timeout, you’d do this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">clearTimeout</span>(myGreeting);</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Note</strong>: See <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/greeter-app.html">greeter-app.html</a> for a slightly more involved demo that allows you to set the name of the person to say hello to in a form, and cancel the greeting using a separate button (<a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/greeter-app.html">see the source code also</a>).</p>
<h3 id="setinterval"><a class="markdownIt-Anchor" href="#setinterval"></a> setInterval()</h3>
<p><code>setTimeout()</code> works perfectly when we need to run the code once after a set period of time. But what happens when we need to run the code over and over again, for example in the case of an animation?</p>
<p>This is where <code>setInterval()</code> comes in. This works in a very similar way to <code>setTimeout()</code>, except that the function you pass to it as the first parameter is executed repeatedly at no less than the number of milliseconds given by the second parameter apart, rather than at once. You can also pass any parameters required by the function being executed in as subsequent parameters of the <code>setInterval()</code> call.</p>
<p>Let’s look at an example. The following function creates a new <code>Date()</code> object, extracts a time string out of it using <code>toLocaleTimeString()</code>, and then displays it in the UI. We then run the function once per second using <code>setInterval()</code>, creating the effect of a digital clock that updates once per second (<a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/setinterval-clock.html">see this live</a>, and also <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/setinterval-clock.html">see the source</a>):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">displayTime</span>(<span class="params"></span>) </span>{</span><br><span class="line">   <span class="keyword">let</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">   <span class="keyword">let</span> time = date.toLocaleTimeString();</span><br><span class="line">   <span class="built_in">document</span>.getElementById(<span class="string">'demo'</span>).textContent = time;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createClock = <span class="built_in">setInterval</span>(displayTime, <span class="number">1000</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Just like <code>setTimeout()</code>, <code>setInterval()</code> returns an identifying value you can use later when you need to clear the interval.</p>
<h3 id="clearing-intervalssection"><a class="markdownIt-Anchor" href="#clearing-intervalssection"></a> Clearing intervals<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Clearing_intervals">Section</a></h3>
<p><code>setInterval()</code> keeps running a task forever, unless we do something about it — we may well want a way to stop such tasks, otherwise we may end up getting errors when the browser can’t complete any further versions of the task, or if the animation being handled by the task has finished. We can do this in the same sort of way as we stopped timeouts — by passing the identifier returned by the <code>setInterval()</code> call to the <code>clearInterval()</code> function:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myInterval = <span class="built_in">setInterval</span>(myFunction, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">clearInterval</span>(myInterval);</span><br></pre></td></tr></tbody></table></figure>
<h4 id="active-learning-creating-your-own-stopwatch"><a class="markdownIt-Anchor" href="#active-learning-creating-your-own-stopwatch"></a> Active learning: Creating your own stopwatch!</h4>
<p>With this all said, we’ve got a challenge for you. Take a copy of our <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/setinterval-clock.html">setInterval-clock.html</a>example, and modify it to create your own simple stopwatch.</p>
<p>You need to display a time as before, but in this example, you need:</p>
<ul>
<li>A “Start” button to start the stopwatch running.</li>
<li>A “Stop” button to pause/stop it.</li>
<li>A “Reset” button to reset the time back to 0.</li>
<li>The time display to show the number of seconds elapsed, rather than the actual time.</li>
</ul>
<p>Here’s a few hints for you:</p>
<ul>
<li>You can structure and style the button markup however you like; just make sure you use semantic HTML, with hooks to allow you to grab the button references using JavaScript.</li>
<li>You probably want to create a variable that starts at 0, then increments by one every second using a constant loop.</li>
<li>It is easier to create this example without using a <code>Date()</code> object, like we’ve done in our version, but less accurate — you can’t guarantee that the callback will fire after exactly 1000ms. A more accurate way would be to run <code>startTime = Date.now()</code> to get a timestamp of exactly when the user clicked the start button, and then do <code>Date.now() - startTime</code> to get the number of milliseconds after the start button was clicked.</li>
<li>You also want to calculate the number of hours, minutes, and seconds as separate values, and then show them together in a string after each loop iteration. From the second counter, you can work out each of these.</li>
<li>How would you calculate them? Have a think about it:
<ul>
<li>The number of seconds in an hour is 3600.</li>
<li>The number of minutes will be the amount of seconds left over when all of the hours have been removed, divided by 60.</li>
<li>The number of seconds will be the amount of seconds left over when all of the minutes have been removed.</li>
</ul>
</li>
<li>You’ll want to include a leading zero on your display values if the amount is less than 10, so it looks more like a traditional clock/watch.</li>
<li>To pause the stopwatch, you’ll want to clear the interval. To reset it, you’ll want to set the counter back to 0 and then immediately update the display.</li>
<li>You probably ought to disable the start button after pressing it once, and enable it again after you’ve stopped it. Otherwise multiple presses of the start button will apply multiple <code>setInterval()</code>s to the clock, leading to wrong behavior.</li>
</ul>
<p><strong>Note</strong>: If you get stuck, you can <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/setinterval-stopwatch.html">find our version here</a> (see the <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/setinterval-stopwatch.html">source code</a> also).</p>
<h3 id="things-to-keep-in-mind-about-settimeout-and-setinterval"><a class="markdownIt-Anchor" href="#things-to-keep-in-mind-about-settimeout-and-setinterval"></a> Things to keep in mind about setTimeout() and setInterval()</h3>
<p>There are a few things to keep in mind when working with <code>setTimeout()</code> and <code>setInterval()</code>. Let’s review these now.</p>
<h3 id="recursive-timeoutssection"><a class="markdownIt-Anchor" href="#recursive-timeoutssection"></a> Recursive timeouts<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Recursive_timeouts">Section</a></h3>
<p>There is another way we can use <code>setTimeout()</code>: We can call it recursively to run the same code repeatedly, instead of using <code>setInterval()</code>.</p>
<p>The below example uses a recursive <code>setTimeout()</code> to run the passed function every 100 milliseconds:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(i);</span><br><span class="line">  i++;</span><br><span class="line">  <span class="built_in">setTimeout</span>(run, <span class="number">100</span>);</span><br><span class="line">}, <span class="number">100</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Compare the above example to the following one — this uses <code>setInterval()</code> to accomplish the same effect:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(i);</span><br><span class="line">  i++</span><br><span class="line">}, <span class="number">100</span>);</span><br></pre></td></tr></tbody></table></figure>
<h4 id="how-do-recursive-settimeout-and-setinterval-differ"><a class="markdownIt-Anchor" href="#how-do-recursive-settimeout-and-setinterval-differ"></a> How do recursive <code>setTimeout()</code> and <code>setInterval()</code> differ?</h4>
<p>The difference between the two versions of the above code is a subtle one.</p>
<ul>
<li>Recursive <code>setTimeout()</code> guarantees the same delay between the executions, so for example 100ms in the above case. The code will run and then wait 100 milliseconds before it runs again, so the interval will be the same regardless of how long the code takes to run.</li>
<li>The example using <code>setInterval()</code> does things somewhat differently. The interval we choose <em>includes</em> the time taken to execute the code we want to run in. Let’s say that the code takes 40 milliseconds to run — the interval then ends up being only 60 milliseconds.</li>
<li>When using <code>setTimeout()</code> recursively, each iteration can calculate a different delay before running the next iteration. In other words, the value of the second parameter can specify a different time in milliseconds to wait before running the code again.</li>
</ul>
<p>When your code has the potential to take longer to run than the time interval you’ve assigned, it’s better to use recursive <code>setTimeout()</code> — this will keep the time interval constant between executions regardless of how long the code takes to execute, and you won’t get errors.</p>
<h3 id="immediate-timeoutssection"><a class="markdownIt-Anchor" href="#immediate-timeoutssection"></a> Immediate timeouts<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Immediate_timeouts">Section</a></h3>
<p>Using 0 as the value for <code>setTimeout()</code> schedules the execution of the specified callback function as soon as possible but only after the main code thread has been run.</p>
<p>For instance, the code below (<a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/zero-settimeout.html">see it live</a>) outputs an alert containing “Hello”, then an alert containing “World” as soon as you click OK on the first alert.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">  alert(<span class="string">'World'</span>);</span><br><span class="line">}, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">alert(<span class="string">'Hello'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>This can be useful in cases where you want to set a block of code to run as soon as all of the main thread has finished running — put it on the async event loop, so it will run straight afterwards.</p>
<h3 id="clearing-with-cleartimeout-or-clearintervalsection"><a class="markdownIt-Anchor" href="#clearing-with-cleartimeout-or-clearintervalsection"></a> Clearing with clearTimeout() or clearInterval()<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Clearing_with_clearTimeout()_or_clearInterval()">Section</a></h3>
<p><code>clearTimeout()</code> and <code>clearInterval()</code> both use the same list of entries to clear from. Interestingly enough, this means that you can use either method to clear a <code>setTimeout()</code> or <code>setInterval()</code>.</p>
<p>For consistency, you should use <code>clearTimeout()</code> to clear <code>setTimeout()</code> entries and <code>clearInterval()</code> to clear <code>setInterval()</code> entries. This will help to avoid confusion.</p>
<h3 id="requestanimationframe"><a class="markdownIt-Anchor" href="#requestanimationframe"></a> requestAnimationFrame()</h3>
<p><code>requestAnimationFrame()</code> is a specialized looping function created for running animations efficiently in the browser. It is basically the modern version of <code>setInterval()</code> — it executes a specified block of code before the browser next repaints the display, allowing an animation to be run at a suitable frame rate regardless of the environment it is being run in.</p>
<p>It was created in response to perceived problems with <code>setInterval()</code>, which for example doesn’t run at a frame rate optimized for the device, sometimes drops frames, continues to run even if the tab is not the active tab or the animation is scrolled off the page, etc. <a target="_blank" rel="noopener" href="http://creativejs.com/resources/requestanimationframe/index.html">Read more about this on CreativeJS</a>.</p>
<p><strong>Note</strong>: You can find examples of using <code>requestAnimationFrame()</code> elsewhere in the course — see for example <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Client-side_web_APIs/Drawing_graphics">Drawing graphics</a>, and <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/Object_building_practice">Object building practice</a>.</p>
<p>The method takes as an argument a callback to be invoked before the repaint. This is the general pattern you’ll see it used in:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">draw</span>(<span class="params"></span>) </span>{</span><br><span class="line">   <span class="comment">// Drawing code goes here</span></span><br><span class="line">   requestAnimationFrame(draw);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">draw();</span><br></pre></td></tr></tbody></table></figure>
<p>The idea is that you define a function in which your animation is updated (e.g. your sprites are moved, score is updated, data is refreshed, or whatever), then you call it to start the process off. At the end of the function block you call <code>requestAnimationFrame()</code> with the function reference passed as the parameter, and this instructs the browser to call the function again on the next display repaint. This is then run continuously, as we are calling <code>requestAnimationFrame()</code> recursively.</p>
<p><strong>Note</strong>: If you want to perform some kind of simple constant DOM animation, <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Animations">CSS Animations</a>are probably faster as they are calculated directly by the browser’s internal code rather than JavaScript. If however you are doing something more complex and involving objects that are not directly accessible inside the DOM (such as <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API">2D Canvas API</a> or <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API">WebGL</a> objects), <code>requestAnimationFrame()</code> is the better option in most cases.</p>
<h3 id="how-fast-does-your-animation-runsection"><a class="markdownIt-Anchor" href="#how-fast-does-your-animation-runsection"></a> How fast does your animation run?<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#How_fast_does_your_animation_run">Section</a></h3>
<p>The smoothness of your animation is directly dependent on your animation’s frame rate and it is measured in frames per second (fps). The higher this number is, the smoother your animation will look, to a point.</p>
<p>Since most screens have a refresh rate of 60Hz, the fastest frame rate you can aim for is 60 frames per second (FPS) when working with web browsers. However, more frames means more processing, which can often cause stuttering and skipping — also known as <em>dropping frames</em>, or <em>jank</em>.</p>
<p>If you have a monitor with a 60Hz refresh rate and you want to achieve 60 FPS you have about 16.7 milliseconds (1000 / 60) to execute your animation code to render each frame. This is a reminder that we need to be mindful of the amount of code that we try to run for each pass through the animation loop.</p>
<p><code>requestAnimationFrame()</code> always tries to get as close to this magic 60 FPS value as possible, although sometimes it isn’t possible — if you have a really complex animation and you are running it on a slow computer, your frame rate will be less. <code>requestAnimationFrame()</code> will always do the best it can with what it has available.</p>
<h3 id="how-does-requestanimationframe-differ-from-setinterval-and-settimeoutsection"><a class="markdownIt-Anchor" href="#how-does-requestanimationframe-differ-from-setinterval-and-settimeoutsection"></a> How does requestAnimationFrame() differ from setInterval() and setTimeout()?<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#How_does_requestAnimationFrame()_differ_from_setInterval()_and_setTimeout()">Section</a></h3>
<p>Let’s talk a little bit more about how the <code>requestAnimationFrame()</code> method differs from the other methods we looked at earlier. Looking at our code from above:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">draw</span>(<span class="params"></span>) </span>{</span><br><span class="line">   <span class="comment">// Drawing code goes here</span></span><br><span class="line">   requestAnimationFrame(draw);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">draw();</span><br></pre></td></tr></tbody></table></figure>
<p>Let’s now see how we’d do the same thing using <code>setInterval()</code>:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">draw</span>(<span class="params"></span>) </span>{</span><br><span class="line">   <span class="comment">// Drawing code goes here</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(draw, <span class="number">17</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>As we said before, we don’t specify a time interval for <code>requestAnimationFrame()</code>; it just runs it as quickly and smoothly as possible in the current conditions. The browser also doesn’t waste time running it if the animation is offscreen for some reason, etc.</p>
<p><code>setInterval()</code> on the other hand requires an interval to be specified. We arrived at our final value of 17 via the formula <em>1000 milliseconds / 60Hz</em>, and then rounded it up. Rounding up is a good idea, as if you rounded down the browser might try to run the animation faster than 60fps, and it wouldn’t make any difference to the smoothness of the animation anyway. As we said before, 60Hz is the standard refresh rate.</p>
<h3 id="including-a-timestampsection"><a class="markdownIt-Anchor" href="#including-a-timestampsection"></a> Including a timestamp<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Including_a_timestamp">Section</a></h3>
<p>The actual callback passed to the <code>requestAnimationFrame()</code> function can be given a parameter too — a timestamp value that represents the time since the <code>requestAnimationFrame()</code> started running. This is useful as it allows you to run things at specific times and at a constant pace, regardless of how fast or slow your device might be. The general pattern you’d use looks something like this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> startTime = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">draw</span>(<span class="params">timestamp</span>) </span>{</span><br><span class="line">    <span class="keyword">if</span>(!startTime) {</span><br><span class="line">      startTime = timestamp;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">   currentTime = timestamp - startTime;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Do something based on current time</span></span><br><span class="line"></span><br><span class="line">   requestAnimationFrame(draw);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">draw();</span><br></pre></td></tr></tbody></table></figure>
<h3 id="browser-supportsection"><a class="markdownIt-Anchor" href="#browser-supportsection"></a> Browser support<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Browser_support">Section</a></h3>
<p><code>requestAnimationFrame()</code> is supported in slightly more recent browsers than <code>setInterval()</code>/<code>setTimeout()</code> — most interestingly it is available in Internet Explorer 10 and above. So unless you need to support older versions of IE with your code, there is little reason to not use <code>requestAnimationFrame()</code>.</p>
<h3 id="a-simple-examplesection"><a class="markdownIt-Anchor" href="#a-simple-examplesection"></a> A simple example<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#A_simple_example">Section</a></h3>
<p>Enough with the theory; let’s go through and build our own <code>requestAnimationFrame()</code>example. We’re going to create a simple “spinner animation”, the kind you might see displayed in an app when it is busy connecting to the server, etc.</p>
<p><strong>Note</strong>: In a real world example, you should probably use CSS animations to run this kind of simple animation. However, this kind of example is very useful to demonstrate <code>requestAnimationFrame()</code> usage, and you’d be more like to use this kind of technique when doing something more complex such as updating the display of a game on each frame.</p>
<ol>
<li>
<p>First of all, grab a basic HTML template <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/html/introduction-to-html/getting-started/index.html">such as this one</a>.</p>
</li>
<li>
<p>Put an empty <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/body"><code>](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/div) element inside the [</code></a>, then add a ↻ character inside it. This is a circular arrow character that will act as our spinner for this simple example.</p>
</li>
<li>
<p>Apply the following CSS to the HTML template in whatever way you prefer. This sets a red background on the page, sets the <code>&lt;body&gt;</code> height to <code>100%</code> of the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/html">``</a> height, and centers the <code>&lt;div&gt;</code> inside the <code>&lt;body&gt;</code>, horizontally and vertically.</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">html</span> {</span><br><span class="line">  <span class="attribute">background-color</span>: white;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span> {</span><br><span class="line">  <span class="attribute">height</span>: inherit;</span><br><span class="line">  <span class="attribute">background-color</span>: red;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span> {</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">10rem</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>Insert a <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script">``</a> element just above the <code>&lt;/body&gt;</code> tag.</p>
</li>
<li>
<p>Insert the following JavaScript inside your <code>&lt;script&gt;</code> element. Here we’re storing a reference to the <code>&lt;div&gt;</code> inside a constant, setting a <code>rotateCount</code> variable to 0, setting an uninitialized variable that will later be used to contain a reference to the <code>requestAnimationFrame()</code> call, and setting a <code>startTime</code> variable to <code>null</code>, which will later be used to store the start time of the <code>requestAnimationFrame()</code>.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> spinner = <span class="built_in">document</span>.querySelector(<span class="string">'div'</span>);</span><br><span class="line"><span class="keyword">let</span> rotateCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> startTime = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> rAF;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>Below the previous code, insert a <code>draw()</code> function that will be used to contain our animation code, which includes the <code>timestamp</code> parameter:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">draw</span>(<span class="params">timestamp</span>) </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>Inside <code>draw()</code>, add the following lines. Here we define the start time if it is not defined already (this will only happen on the first loop iteration), and set the <code>rotateCount</code> to a value to rotate the spinner by (the current timestamp, take the starting timestamp, divided by three so it doesn’t go too fast):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!startTime) {</span><br><span class="line">   startTime = timestamp;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  rotateCount = (timestamp - startTime) / <span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>Below the previous line inside <code>draw()</code>, add the following block — this checks to see if the value of <code>rotateCount</code> is above <code>359</code> (e.g. <code>360</code>, a full circle). If so, it sets the value to its modulo of 360 (i.e. the remainder left over when the value is divided by 360) so the circle animation can continue uninterrupted, at a sensible, low value. Note that this isn’t strictly necessary, but it is easier to work with values of 0-359 degrees than values like “128000 degrees”.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (rotateCount &gt; <span class="number">359</span>) {</span><br><span class="line">  rotateCount %= <span class="number">360</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>Next, below the previous block add the following line to actually rotate the spinner:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spinner.style.transform = <span class="string">'rotate('</span> + rotateCount + <span class="string">'deg)'</span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>At the very bottom inside the <code>draw()</code> function, insert the following line. This is the key to the whole operation — we are setting the variable we defined earlier to an active <code>requestAnimation()</code> call that takes the <code>draw()</code> function as its parameter. This starts the animation off, constantly running the <code>draw()</code> function at a rate of as close to 60 FPS as possible.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rAF = requestAnimationFrame(draw);</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<p><strong>Note</strong>: You can find this <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/simple-raf-spinner.html">example live on GitHub</a> (see the <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/simple-raf-spinner.html">source code</a> also).</p>
<h3 id="clearing-a-requestanimationframe-callsection"><a class="markdownIt-Anchor" href="#clearing-a-requestanimationframe-callsection"></a> Clearing a requestAnimationFrame() call<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Clearing_a_requestAnimationFrame()_call">Section</a></h3>
<p>Clearing a <code>requestAnimationFrame()</code> call can be done by calling the corresponding <code>cancelAnimationFrame()</code> method (note, “cancel” not “clear” as with the “set…” methods), passing it the value returned by the <code>requestAnimationFrame()</code> call to cancel, which we stored in a variable called <code>rAF</code>:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cancelAnimationFrame(rAF);</span><br></pre></td></tr></tbody></table></figure>
<h3 id="active-learning-starting-and-stopping-our-spinnersection"><a class="markdownIt-Anchor" href="#active-learning-starting-and-stopping-our-spinnersection"></a> Active learning: Starting and stopping our spinner<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Active_learning_Starting_and_stopping_our_spinner">Section</a></h3>
<p>In this exercise, we’d like you to test out the <code>cancelAnimationFrame()</code> method by taking our previous example and updating it, adding an event listener to start and stop the spinner when the mouse is clicked anywhere on the page.</p>
<p>Some hints:</p>
<ul>
<li>A <code>click</code> event handler can be added to most elements, including the document <code>&lt;body&gt;</code>. It makes more sense to put it on the <code>&lt;body&gt;</code> element if you want to maximize the clickable area — the event bubbles up to its child elements.</li>
<li>You’ll want to add a tracking variable to check whether the spinner is spinning or not, clearing the animation frame if it is, and calling it again if it isn’t.</li>
</ul>
<p><strong>Note</strong>: Try this yourself first; if you get really stuck, check out of our <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/start-and-stop-spinner.html">live example</a> and <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/start-and-stop-spinner.html">source code</a>.</p>
<h3 id="throttling-a-requestanimationframe-animationsection"><a class="markdownIt-Anchor" href="#throttling-a-requestanimationframe-animationsection"></a> Throttling a requestAnimationFrame() animation<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Throttling_a_requestAnimationFrame()_animation">Section</a></h3>
<p>One limitation of <code>requestAnimationFrame()</code> is that you can’t choose your frame rate. This isn’t a problem most of the time, as generally you want your animation to run as smoothly as possible, but what about when you want to create an old school, 8-bit-style animation?</p>
<p>This was a problem for example in the Monkey Island-inspired walking animation from our <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Client-side_web_APIs/Drawing_graphics">Drawing Graphics</a> article:</p>
<p>In this example we have to animate both the position of the character on the screen, and the sprite being shown. There are only 6 frames in the sprite’s animation; if we showed a different sprite frame for every frame displayed on the screen by <code>requestAnimationFrame()</code>, Guybrush would move his limbs too fast and the animation would look ridiculous. We therefore throttled the rate at which the sprite cycles its frames using the following code:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (posX % <span class="number">13</span> === <span class="number">0</span>) {</span><br><span class="line">  <span class="keyword">if</span> (sprite === <span class="number">5</span>) {</span><br><span class="line">    sprite = <span class="number">0</span>;</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    sprite++;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>So we are only cycling a sprite once every 13 animation frames. OK, so it’s actually about every 6.5 frames, as we update <code>posX</code> (character’s position on the screen) by two each frame:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(posX &gt; width/<span class="number">2</span>) {</span><br><span class="line">  newStartPos = -((width/<span class="number">2</span>) + <span class="number">102</span>);</span><br><span class="line">  posX = <span class="built_in">Math</span>.ceil(newStartPos / <span class="number">13</span>) * <span class="number">13</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(posX);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">  posX += <span class="number">2</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>This is the code that works out how to update the position in each animation frame.</p>
<p>The method you use to throttle your animation will depend on your particular code. For example, in our spinner example we could make it appear to move slower by only increasing our <code>rotateCount</code> by one on each frame instead of two.</p>
<h3 id="active-learning-a-reaction-game"><a class="markdownIt-Anchor" href="#active-learning-a-reaction-game"></a> Active learning: a reaction game</h3>
<p>For our final section of this article, we’ll create a 2-player reaction game. Here we have two players, one of whom controls the game using the A key, and the other with the L key.</p>
<p>When the <em>Start</em> button is pressed, a spinner like the one we saw earlier is displayed for a random amount of time between 5 and 10 seconds. After that time, a message will appear saying “PLAYERS GO!!” — once this happens, the first player to press their control button will win the game.</p>
<p>Let’s work through this.</p>
<ol>
<li>
<p>First of all, download the <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/reaction-game-starter.html">starter file for the app</a> — this contains the finished HTML structure and CSS styling, giving us a game board that shows the two players’ information (as seen above), but with the spinner and results paragraph displayed on top of one another. We just have to write the JavaScript code.</p>
</li>
<li>
<p>Inside the empty <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script">``</a> element on your page, start by adding the following lines of code that define some constants and variables we’ll need in the rest of the code:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> spinner = <span class="built_in">document</span>.querySelector(<span class="string">'.spinner p'</span>);</span><br><span class="line"><span class="keyword">const</span> spinnerContainer = <span class="built_in">document</span>.querySelector(<span class="string">'.spinner'</span>);</span><br><span class="line"><span class="keyword">let</span> rotateCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> startTime = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> rAF;</span><br><span class="line"><span class="keyword">const</span> btn = <span class="built_in">document</span>.querySelector(<span class="string">'button'</span>);</span><br><span class="line"><span class="keyword">const</span> result = <span class="built_in">document</span>.querySelector(<span class="string">'.result'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>In order, these are:</p>
<ol>
<li>A reference to our spinner, so we can animate it.</li>
<li>A reference to the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/div">``</a> element that contains the spinner, used for showing and hiding it.</li>
<li>A rotate count — how much we want to show the spinner rotated on each frame of the animation.</li>
<li>A null start time — will be populated with a start time when the spinner starts spinning.</li>
<li>An uninitialized variable to later store the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame"><code>requestAnimationFrame()</code></a> call that animates the spinner.</li>
<li>A reference to the Start button.</li>
<li>A reference to the results paragraph.</li>
</ol>
</li>
<li>
<p>Next, below the previous lines of code, add the following function. This simply takes two numerical inputs and returns a random number between the two. We’ll need this to generate a random timeout interval later on.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random</span>(<span class="params">min,max</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> num = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*(max-min)) + min;</span><br><span class="line">  <span class="keyword">return</span> num;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>Next add in the <code>draw()</code> function, which animates the spinner. This is exactly the same as the version seen in the simple spinner example we looked at earlier:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">draw</span>(<span class="params">timestamp</span>) </span>{</span><br><span class="line">    <span class="keyword">if</span>(!startTime) {</span><br><span class="line">     startTime = timestamp;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> rotateCount = (timestamp - startTime) / <span class="number">3</span>;</span><br><span class="line">    spinner.style.transform = <span class="string">'rotate('</span> + rotateCount + <span class="string">'deg)'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(rotateCount &gt; <span class="number">359</span>) {</span><br><span class="line">      rotateCount -= <span class="number">360</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    rAF = requestAnimationFrame(draw);</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>Now it is time to set up the initial state of the app when the page first loads. Add the following two lines, which simply hide the results paragraph and spinner container using <code>display: none;</code>.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result.style.display = <span class="string">'none'</span>;</span><br><span class="line">spinnerContainer.style.display = <span class="string">'none'</span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>We’ll also define a <code>reset()</code> function, which sets the app back to the original state required to start the game again after it has been played. Add the following at the bottom of your code:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reset</span>(<span class="params"></span>) </span>{</span><br><span class="line">  btn.style.display = <span class="string">'block'</span>;</span><br><span class="line">  result.textContent = <span class="string">''</span>;</span><br><span class="line">  result.style.display = <span class="string">'none'</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>OK, enough preparation.  Let’s make the game playable! Add the following block to your code. The <code>start()</code> function calls <code>draw()</code> to start the spinner spinning and display it in the UI, hides the <em>Start</em> button so we can’t mess up the game by starting it multiple times concurrently, and runs a <code>setTimeout()</code> call that runs a <code>setEndgame()</code> function after a random interval between 5 and 10 seconds has passed. We also add an event listener to our button to run the <code>start()</code> function when it is clicked.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">btn.addEventListener(<span class="string">'click'</span>, start);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>) </span>{</span><br><span class="line">  draw();</span><br><span class="line">  spinnerContainer.style.display = <span class="string">'block'</span>;</span><br><span class="line">  btn.style.display = <span class="string">'none'</span>;</span><br><span class="line">  <span class="built_in">setTimeout</span>(setEndgame, random(<span class="number">5000</span>,<span class="number">10000</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Note</strong>: You’ll see that in this example we are calling <code>setTimeout()</code> without storing the return value (so not <code>let myTimeout = setTimeout(functionName, interval)</code>). This works and is fine, as long as you don’t need to clear your interval/timeout at any point. If you do, you’ll need to save the returned identifier.</p>
<p>The net result of the previous code is that when the <em>Start</em> button is pressed, the spinner is shown and the players are made to wait a random amount of time before they are then asked to press their button. This last part is handled by the <code>setEndgame()</code> function, which we should define next.</p>
</li>
<li>
<p>So add the following function to your code next:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setEndgame</span>(<span class="params"></span>) </span>{</span><br><span class="line">  cancelAnimationFrame(rAF);</span><br><span class="line">  spinnerContainer.style.display = <span class="string">'none'</span>;</span><br><span class="line">  result.style.display = <span class="string">'block'</span>;</span><br><span class="line">  result.textContent = <span class="string">'PLAYERS GO!!'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">document</span>.addEventListener(<span class="string">'keydown'</span>, keyHandler);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">keyHandler</span>(<span class="params">e</span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(e.key);</span><br><span class="line">    <span class="keyword">if</span>(e.key === <span class="string">'a'</span>) {</span><br><span class="line">      result.textContent = <span class="string">'Player 1 won!!'</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span>(e.key === <span class="string">'l'</span>) {</span><br><span class="line">      result.textContent = <span class="string">'Player 2 won!!'</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">document</span>.removeEventListener(<span class="string">'keydown'</span>, keyHandler);</span><br><span class="line">    <span class="built_in">setTimeout</span>(reset, <span class="number">5000</span>);</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Stepping through this:</p>
<ol>
<li>First we cancel the spinner animation with <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/cancelAnimationFrame"><code>cancelAnimationFrame()</code></a> (it is always good to clean up unneeded processes), and hide the spinner container.</li>
<li>Next we display the results paragraph and set its text content to “PLAYERS GO!!” to signal to the players that they can now press their button to win.</li>
<li>We then attach a <code>keydown</code> event listener to our document — when any button is pressed down, the <code>keyHandler()</code> function is run.</li>
<li>Inside <code>keyHandler()</code>, we include the event object as a parameter (represented by <code>e</code>) — its <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent/key"><code>key</code></a> property contains the key that was just pressed, and we can use this to respond to specific key presses with specific actions.</li>
<li>We first log <code>e.key</code> to the console, which is a useful way of finding out the <code>key</code> value of different keys you are pressing.</li>
<li>When <code>e.key</code> is “a”, we display a message to say that Player 1 won, and when <code>e.key</code> is “l”, we display a message to say Player 2 won. Note that this will only work with lowercase a and l — if an uppercase A or L is submitted (the key plus Shift), it is counted as a different key.</li>
<li>Regardless of which one of the player control keys was pressed, we remove the <code>keydown</code> event listener using <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/removeEventListener"><code>removeEventListener()</code></a> so that once the winning press has happened, no more keyboard input is possible to mess up the final game result. We also use <code>setTimeout()</code> to call <code>reset()</code> after 5 seconds — as we explained earlier, this function resets the game back to its original state so that a new game can be started.</li>
</ol>
</li>
</ol>
<p>That’s it, you’re all done.</p>
<p><strong>Note</strong>: If you get stuck, check out <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/reaction-game.html">our version of the reaction game</a> (see the <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/reaction-game.html">source code</a>also).</p>
<h2 id="promises"><a class="markdownIt-Anchor" href="#promises"></a> Promises</h2>
<h3 id="what-are-promises"><a class="markdownIt-Anchor" href="#what-are-promises"></a> What are promises?</h3>
<p><strong>Promises</strong> are a comparatively new feature of the JavaScript language that allow you to defer further actions until after a previous action has completed, or respond to its failure. This is really useful for setting up a sequence of async operations to work correctly.</p>
<p>Let’s consider a hypothetical video chat application. The application has a window with a list of the user’s friends, and clicking on a button next to a user starts a video call to that user.</p>
<p>That button’s handler calls <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia"><code>getUserMedia()</code></a> in order to get access to the user’s camera and microphone. Since <code>getUserMedia()</code> has to ensure that the user has permission to use those devices <em>and</em> ask the user which microphone to use and which camera to use (or whether to be a voice only call, among other possible options), it can block until not only all of those decisions are made, but also the camera and microphone have been engaged. In addition, the user may not respond immediately to these permission requests. This can potentially take a long time.</p>
<p>Since the call to <code>getUserMedia()</code> is made from the browser’s main thread, the entire browser is blocked until <code>getUserMedia()</code> returns! Obviously, that’s not an acceptable option; without promises, everything in the browser becomes unusable until the user decides what to do about the camera and microphone. So instead of waiting for the user, getting the chosen devices enabled, and directly returning the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/MediaStream"><code>MediaStream</code></a> for the stream created from the selected sources, <code>getUserMedia()</code> returns a <code>promise</code> which is resolved with the <code>MediaStream</code> once it’s available.</p>
<p>The code that the video chat application would use might look something like this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleCallButton</span>(<span class="params">evt</span>) </span>{</span><br><span class="line">  setStatusMessage(<span class="string">"Calling..."</span>);</span><br><span class="line">  navigator.mediaDevices.getUserMedia({<span class="attr">video</span>: <span class="literal">true</span>, <span class="attr">audio</span>: <span class="literal">true</span>})</span><br><span class="line">    .then(<span class="function"><span class="params">chatStream</span> =&gt;</span> {</span><br><span class="line">      selfViewElem.srcObject = chatStream;</span><br><span class="line">      chatStream.getTracks().forEach(<span class="function"><span class="params">track</span> =&gt;</span> myPeerConnection.addTrack(track, chatStream));</span><br><span class="line">      setStatusMessage(<span class="string">"Connected"</span>);</span><br><span class="line">    }).catch(<span class="function"><span class="params">err</span> =&gt;</span> {</span><br><span class="line">      setStatusMessage(<span class="string">"Failed to connect"</span>);</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>This function starts by using a function called <code>setStatusMessage()</code> to update a status display with the message “Calling…”, indicating that a call is being attempted. It then calls <code>getUserMedia()</code>, asking for a stream that has both video and audio tracks, then once that’s been obtained, sets up a video element to show the stream coming from the camera as a “self view,” then takes each of the stream’s tracks and adds them to the [WebRTC](RTCPeerConnection] representing a connection to another user. After that, the status display is updated to say “Connected”.</p>
<p>If <code>getUserMedia()</code> fails, the <code>catch</code> block runs. This uses <code>setStatusMessage()</code> to update the status box to indicate that an error occurred.</p>
<p>The important thing here is that the <code>getUserMedia()</code> call returns almost immediately, even if the camera stream hasn’t been obtained yet. Even if the <code>handleCallButton()</code> function has already returned to the code that called it, when <code>getUserMedia()</code> has finished working, it calls the handler you provide. As long as the app doesn’t assume that streaming has begun, it can just keep on running.</p>
<h3 id="the-trouble-with-callbacks"><a class="markdownIt-Anchor" href="#the-trouble-with-callbacks"></a> The trouble with callbacks</h3>
<p>To fully understand why promises are a good thing, it helps to think back to old-style callbacks, and to appreciate why they are problematic.</p>
<p>Let’s talk about ordering pizza as an analogy. There are certain steps that you have to take for your order to be successful, which don’t really make sense to try to execute out of order, or in order but before each previous step has quite finished:</p>
<ol>
<li>You choose what toppings you want. This can take a while if you are indecisive, and may fail if you just can’t make up your mind, or decide to get a curry instead.</li>
<li>You then place your order. This can take a while to return a pizza, and may fail if the restaurant does not have the required ingredients to cook it.</li>
<li>You then collect your pizza and eat. This might fail if, say, you forgot your wallet so can’t pay for the pizza!</li>
</ol>
<p>With old-style callbacks, a pseudo-code representation of the above functionality might look something like this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chooseToppings(<span class="function"><span class="keyword">function</span>(<span class="params">toppings</span>) </span>{</span><br><span class="line">  placeOrder(toppings, <span class="function"><span class="keyword">function</span>(<span class="params">order</span>) </span>{</span><br><span class="line">    collectOrder(order, <span class="function"><span class="keyword">function</span>(<span class="params">pizza</span>) </span>{</span><br><span class="line">      eatPizza(pizza);</span><br><span class="line">    }, failureCallback);</span><br><span class="line">  }, failureCallback);</span><br><span class="line">}, failureCallback);</span><br></pre></td></tr></tbody></table></figure>
<p>This is messy and hard to read (often referred to as “callback hell”), requires the <code>failureCallback()</code> to be called multiple times (once for each nested function), with other issues besides.</p>
<p><strong>Promises</strong> make situations like the above much easier to write, parse, and run. If we represented the above pseudo-code using asynchronous promises instead, we’d end up with something like this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">chooseToppings()</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">toppings</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> placeOrder(toppings);</span><br><span class="line">})</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">order</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> collectOrder(order);</span><br><span class="line">})</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">pizza</span>) </span>{</span><br><span class="line">  eatPizza(pizza);</span><br><span class="line">})</span><br><span class="line">.catch(failureCallback);</span><br></pre></td></tr></tbody></table></figure>
<p>This is much better — it is easier to see what is going on, we only need a single <code>.catch()</code>block to handle all the errors, it doesn’t block the main thread (so we can keep playing video games while we wait for the pizza to be ready to collect), and each operation is guaranteed to wait for previous operations to complete before running. We’re able to chain multiple asynchronous actions to occur one after another this way because each <code>.then()</code> block returns a new promise that resolves when the <code>.then()</code> block is done running. Clever, right?</p>
<p>Using arrow functions, you can simplify the code even further:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chooseToppings()</span><br><span class="line">.then(<span class="function"><span class="params">toppings</span> =&gt;</span> placeOrder(toppings))</span><br><span class="line">.then(<span class="function"><span class="params">order</span> =&gt;</span> collectOrder(order))</span><br><span class="line">.then(<span class="function"><span class="params">pizza</span> =&gt;</span> eatPizza(pizza))</span><br><span class="line">.catch(failureCallback);</span><br></pre></td></tr></tbody></table></figure>
<p>You could even do this, since the functions just pass their arguments directly, so there isn’t any need for that extra layer of functions:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chooseToppings().then(placeOrder).then(collectOrder).then(eatPizza).catch(failureCallback);</span><br></pre></td></tr></tbody></table></figure>
<p>This is not quite as easy to read, however, and this syntax might not be usable if your blocks are more complex than what we’ve shown here.</p>
<blockquote>
<p><strong>Note</strong>: You can make further improvements with <code>async</code>/<code>await</code> syntax, which we’ll dig into in the next article.</p>
</blockquote>
<p>At their most basic, promises are similar to event listeners, but with a few differences:</p>
<ul>
<li>A promise can only succeed or fail once. It cannot succeed or fail twice and it cannot switch from success to failure or vice versa once the operation has completed.</li>
<li>If a promise has succeeded or failed and you later add a success/failure callback, the correct callback will be called, even though the event took place earlier.</li>
</ul>
<p>Promises are the new style of async code that you’ll see used in modern Web APIs. A good example is the <code>fetch()</code> API, which is basically like a modern, more efficient version of <code>XMLHttpRequest</code>:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">'products.json'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> response.json();</span><br><span class="line">}).then(<span class="function"><span class="keyword">function</span>(<span class="params">json</span>) </span>{</span><br><span class="line">  products = json;</span><br><span class="line">  initialize();</span><br><span class="line">}).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Fetch problem: '</span> + err.message);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>Here we see <code>fetch</code> taking a single parameter — the URL of a resource you want to fetch from the network — and returning a promise.</p>
<p>The promise is an object representing the completion or failure of the async operation. It represents an intermediate state, as it were. In essence, it’s the browser’s way of saying “I promise to get back to you with the answer as soon as I can,” hence the name “promise.”</p>
<p>This concept can take practice to get used to; it feels a little like [Schrödinger’s cat](<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Schr%C3%B6dinger's">https://en.wikipedia.org/wiki/Schrödinger’s</a> cat) in action. Neither of the possible outcomes have happened yet, so the fetch operation is currently waiting on the result of the browser trying to complete the operation at some point in the future.</p>
<h3 id="promises-versus-callbacks"><a class="markdownIt-Anchor" href="#promises-versus-callbacks"></a> Promises versus callbacks</h3>
<p>Promises have some similarities to old-style callbacks. They are essentially a returned object to which you attach callback functions, rather than having to pass callbacks into a function.</p>
<p>However, promises are specifically made for handling async operations, and have many advantages over old-style callbacks:</p>
<ul>
<li>You can chain multiple async operations together using multiple <code>.then()</code> operations, passing the result of one into the next one as an input. This is much harder to do with callbacks, which often ends up with a messy “pyramid of doom” (also known as <a target="_blank" rel="noopener" href="http://callbackhell.com/">callback hell</a>).</li>
<li>Promise callbacks are always called in the strict order they are placed in the event queue.</li>
<li>Error handling is much better — all errors are handled by a single <code>.catch()</code> block at the end of the block, rather than being individually handled in each level of the “pyramid”.</li>
<li>Promises avoid inversion of control, unlike old-style callbacks, which lose full control of how the function will be executed when passing a callback to a third-party library.</li>
</ul>
<h3 id="a-real-example"><a class="markdownIt-Anchor" href="#a-real-example"></a> A real example</h3>
<p>Promises are important to understand because most modern Web APIs use them for functions that perform potentially lengthy tasks.</p>
<p>In this example, we’ll use the <code>fetch()</code> method to fetch an image from the web, the <code>blob()</code>method to transform the fetch response’s raw body contents into a <code>Blob</code> object, and then display that blob inside an img element.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Call the fetch() method to fetch the image, and store it in a variable</span></span><br><span class="line"><span class="keyword">let</span> promise = fetch(<span class="string">'coffee.jpg'</span>);</span><br><span class="line"><span class="comment">// Use a then() block to respond to the promise's successful completion</span></span><br><span class="line"><span class="comment">// by taking the returned response and running blob() on it to transform it into a blob</span></span><br><span class="line"><span class="keyword">let</span> promise2 = promise.then(<span class="function"><span class="params">response</span> =&gt;</span> response.blob());</span><br><span class="line"></span><br><span class="line"><span class="comment">// blob() also returns a promise; when it successfully completes it returns</span></span><br><span class="line"><span class="comment">// The blob object in the callback</span></span><br><span class="line"><span class="keyword">let</span> promise3 = promise2.then(<span class="function"><span class="params">myBlob</span> =&gt;</span> {</span><br><span class="line">    <span class="comment">// Create an object URL that points to the blob object</span></span><br><span class="line">    <span class="keyword">let</span> objectURL = URL.createObjectURL(myBlob);</span><br><span class="line">    <span class="comment">// Create an &lt;img&gt; element to display the blob (it's an image)</span></span><br><span class="line">    <span class="keyword">let</span> image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">    <span class="comment">// Set the src of the &lt;img&gt; to the object URL so the image displays it</span></span><br><span class="line">    image.src = objectURL;</span><br><span class="line">    <span class="comment">// Append the &lt;img&gt; element to the DOM</span></span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">})</span><br><span class="line"></span><br><span class="line"><span class="comment">// If there is a problem, log a useful error message to the console</span></span><br><span class="line"><span class="keyword">let</span> errorCase = promise3.catch(<span class="function"><span class="params">e</span> =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'There has been a problem with your fetch operation: '</span> + e.message);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Note</strong>: You will probably notice that these examples are somewhat contrived. You could just do away with the whole <code>fetch()</code> and <code>blob()</code> chain, and just create an <code>&lt;img&gt;</code> element and set its <code>src</code> attribute value to the URL of the image file, <code>coffee.jpg</code>. We did however pick this example because it demonstrates promises in a nice simple fashion, rather than for its real world appropriateness.</p>
<p>This is a very longhand way of writing this out; we’ve deliberately done this to help you understand what is going on clearly. As shown earlier on in the article, you can chain together <code>.then()</code> blocks (and also <code>.catch()</code> blocks).</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Call the fetch() method to fetch the image, and store it in a variable</span></span><br><span class="line">fetch(<span class="string">'coffee.jpg'</span>)</span><br><span class="line"><span class="comment">// Use a then() block to respond to the promise's successful completion</span></span><br><span class="line"><span class="comment">// by taking the returned response and running blob() on it to transform it into a blob</span></span><br><span class="line">    .then(<span class="function"><span class="params">response</span> =&gt;</span> response.blob())</span><br><span class="line"><span class="comment">// blob() also returns a promise; when it successfully completes it returns</span></span><br><span class="line"><span class="comment">// The blob object in the callback</span></span><br><span class="line">    .then(<span class="function"><span class="params">myBlob</span> =&gt;</span> {</span><br><span class="line">    <span class="comment">// Create an object URL that points to the blob object</span></span><br><span class="line">    <span class="keyword">let</span> objectURL = URL.createObjectURL(myBlob);</span><br><span class="line">    <span class="comment">// Create an &lt;img&gt; element to display the blob (it's an image)</span></span><br><span class="line">    <span class="keyword">let</span> image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">    <span class="comment">// Set the src of the &lt;img&gt; to the object URL so the image displays it</span></span><br><span class="line">    image.src = objectURL;</span><br><span class="line">    <span class="comment">// Append the &lt;img&gt; element to the DOM</span></span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">})</span><br><span class="line"><span class="comment">// If there is a problem, log a useful error message to the console</span></span><br><span class="line">    .catch(<span class="function"><span class="params">e</span> =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'There has been a problem with your fetch operation: '</span> + e.message);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<h3 id="the-nature-of-asynchronous-code"><a class="markdownIt-Anchor" href="#the-nature-of-asynchronous-code"></a> The nature of asynchronous code</h3>
<p>Let’s explore an example that further illustrates the nature of async code, showing what can happen when we are not fully aware of code execution order and the problems of trying to treat asynchronous code like synchronous code.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log (<span class="string">'Starting'</span>);</span><br><span class="line"><span class="keyword">let</span> image;</span><br><span class="line"></span><br><span class="line">fetch(<span class="string">'coffee.jpg'</span>).then(<span class="function">(<span class="params">response</span>) =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'It worked :)'</span>)</span><br><span class="line">  <span class="keyword">return</span> response.blob();</span><br><span class="line">}).then(<span class="function">(<span class="params">myBlob</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">let</span> objectURL = URL.createObjectURL(myBlob);</span><br><span class="line">  image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  image.src = objectURL;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">}).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'There has been a problem with your fetch operation: '</span> + error.message);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log (<span class="string">'All done!'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p><a href="web/js/async/introducing/web_js_async_async-sync.html" target="_blank">See Live Here</a></p>
<p>The browser will begin executing the code, see the first <code>console.log()</code> statement (<code>Starting</code>) and execute it, and then create the <code>image</code> variable.</p>
<p>It will then move to the next line and begin executing the <code>fetch()</code> block but, because <code>fetch()</code> executes asynchronously without blocking, code execution continues after the promise-related code, thereby reaching the final <code>console.log()</code> statement (<code>All done!</code>) and outputting it to the console.</p>
<p>Only once the <code>fetch()</code> block has completely finished running and delivering its result through the <code>.then()</code> blocks will we finally see the second <code>console.log()</code> message (<code>It worked :)</code>) appear. So the messages have appeared in a different order to what you might expect:</p>
<ul>
<li>Starting</li>
<li>All done!</li>
<li>It worked 😃</li>
</ul>
<p>In a less trivial code example, this kind of setup could cause a problem — you can’t include an async code block that returns a result, which you then rely on later in a sync code block. You just can’t guarantee that the async function will return before the browser has processed the sync block.</p>
<p>To see this in action, changing the fourth <code>console.log()</code> call to the following:</p>
<p><a href="web/js/async/introducing/web_js_async_async-sync.html" target="_blank">See Live Here</a></p>
<p>You should now get an error in your console instead of the third message:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: image is undefined; can't access its "src" property</span><br></pre></td></tr></tbody></table></figure>
<p>This is because at the time the browser tries to run the third <code>console.log()</code> statement, the <code>fetch()</code> block has not finished running so the <code>image</code> variable has not been given a value.</p>
<p>To fix the problematic <code>fetch()</code> example and make the three <code>console.log()</code> statements appear in the desired order, you could make the third <code>console.log()</code> statement run async as well. This can be done by moving it inside another <code>.then()</code> block chained onto the end of the second one, or by simply moving it inside the second <code>then()</code> block.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log (<span class="string">'Starting'</span>);</span><br><span class="line"><span class="keyword">let</span> image;</span><br><span class="line"></span><br><span class="line">fetch(<span class="string">'coffee.jpg'</span>).then(<span class="function">(<span class="params">response</span>) =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'It worked :)'</span>)</span><br><span class="line">    <span class="keyword">return</span> response.blob();</span><br><span class="line">}).then(<span class="function">(<span class="params">myBlob</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">let</span> objectURL = URL.createObjectURL(myBlob);</span><br><span class="line">    image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">    image.src = objectURL;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">}).then(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log (<span class="string">'All done! '</span> + image.src + <span class="string">' displayed.'</span>);</span><br><span class="line">}).catch(<span class="function">(<span class="params">err</span>) =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'There has been a problem with your fetch operation: '</span> + err.message);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<h3 id="running-code-in-response-to-multiple-promises-fulfilling"><a class="markdownIt-Anchor" href="#running-code-in-response-to-multiple-promises-fulfilling"></a> Running code in response to multiple promises fulfilling</h3>
<p>The above example showed us some of the real basics of using promises. Now let’s look at some more advanced features. For a start, chaining processes to occur one after the other is all fine, but what if you want to run some code only after a whole bunch of promises have <em>all</em> fulfilled?</p>
<p>You can do this with the ingeniously named <code>Promise.all()</code> static method. This takes an array of promises as an input parameter and returns a new <code>Promise</code> object that will fulfill only if and when <em>all</em> promises in the array fulfill. It looks something like this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.all([a, b, c]).then(<span class="function"><span class="params">values</span> =&gt;</span> {</span><br><span class="line">  ...</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>If they all fulfill, then chained <code>.then()</code> block’s executor function will be passed an array containing all those results as a parameter. If any of the promises passed to <code>Promise.all()</code>reject, the whole block will reject.</p>
<p>This can be very useful. Imagine that we’re fetching information to dynamically populate a UI feature on our page with content. In many cases, it makes sense to receive all the data and only then show the complete content, rather than displaying partial information.</p>
<p>Let’s build another example to show this in action.</p>
<p>We could just do something like:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = fetch(url1);</span><br><span class="line"><span class="keyword">let</span> b = fetch(url2);</span><br><span class="line"><span class="keyword">let</span> c = fetch(url3);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.all([a, b, c]).then(<span class="function"><span class="params">values</span> =&gt;</span> {</span><br><span class="line">  ...</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>When the promise is fulfilled, the <code>values</code> passed into the fullfillment handler would contain three <code>Response</code> objects, one for each of the <code>fetch()</code> operations that have completed.</p>
<p>However, we don’t want to do this. Our code doesn’t care when the <code>fetch()</code> operations are done. Instead, what we want is the loaded data. That means we want to run the <code>Promise.all()</code> block when we get back usable blobs representing the images, and a usable text string. We can write a function that does this; add the following inside your <code>&lt;script&gt;</code> element:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetchAndDecode</span>(<span class="params">url, type</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> fetch(url).then(<span class="function"><span class="params">response</span> =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">'blob'</span>) {</span><br><span class="line">      <span class="keyword">return</span> response.blob();</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'text'</span>) {</span><br><span class="line">      <span class="keyword">return</span> response.text();</span><br><span class="line">    }</span><br><span class="line">  })</span><br><span class="line">  .catch(<span class="function"><span class="params">e</span> =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'There has been a problem with your fetch operation: '</span> + e.message);</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The code inside the function body is async and promise-based, therefore in effect the entire function acts like a promise — convenient.</p>
<p>Next, we call our function three times to begin the process of fetching and decoding the images and text, and store each of the returned promises in a variable. Add the following below your previous code:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> coffee = fetchAndDecode(<span class="string">'coffee.jpg'</span>, <span class="string">'blob'</span>);</span><br><span class="line"><span class="keyword">let</span> tea = fetchAndDecode(<span class="string">'tea.jpg'</span>, <span class="string">'blob'</span>);</span><br><span class="line"><span class="keyword">let</span> description = fetchAndDecode(<span class="string">'description.txt'</span>, <span class="string">'text'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Next, we will define a <code>Promise.all()</code> block to run some code only when all three of the promises stored above have successfully fulfilled. To begin with, add a block with an empty executor inside the <code>.then()</code> call, like so:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.all([coffee, tea, description]).then(<span class="function"><span class="params">values</span> =&gt;</span> {</span><br><span class="line"></span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>You can see that it takes an array containing the promises as a parameter. The executor will only run when all three promises resolve; when that happens, it will be passed an array containing the results from the individual promises (i.e. the decoded response bodies), kind of like [coffee-results, tea-results, description-results].</p>
<p>Last of all, add the following inside the executor. Here we use some fairly simple sync code to store the results in separate variables (creating object URLs from the blobs), then display the images and text on the page.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(values);</span><br><span class="line"><span class="comment">// Store each value returned from the promises in separate variables; create object URLs from the blobs</span></span><br><span class="line"><span class="keyword">let</span> objectURL1 = URL.createObjectURL(values[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">let</span> objectURL2 = URL.createObjectURL(values[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">let</span> descText = values[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Display the images in &lt;img&gt; elements</span></span><br><span class="line"><span class="keyword">let</span> image1 = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line"><span class="keyword">let</span> image2 = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">image1.src = objectURL1;</span><br><span class="line">image2.src = objectURL2;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(image1);</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(image2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Display the text in a paragraph</span></span><br><span class="line"><span class="keyword">let</span> para = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>);</span><br><span class="line">para.textContent = descText;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(para);</span><br></pre></td></tr></tbody></table></figure>
<p><a href="web/js/async/intro/web_js_async_promise-all.html" target="_blank">See the finished Here</a></p>
<p>The code we provided here for displaying the items is fairly rudimentary, but works as an explainer for now.</p>
<h3 id="running-some-final-code-after-a-promise-fulfillsrejects"><a class="markdownIt-Anchor" href="#running-some-final-code-after-a-promise-fulfillsrejects"></a> Running some final code after a promise fulfills/rejects</h3>
<p>There will be cases where you want to run a final block of code after a promise completes, regardless of whether it fulfilled or rejected. Previously you’d have to include the same code in both the <code>.then()</code> and <code>.catch()</code> callbacks, for example:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">myPromise</span><br><span class="line">.then(<span class="function"><span class="params">response</span> =&gt;</span> {</span><br><span class="line">  doSomething(response);</span><br><span class="line">  runFinalCode();</span><br><span class="line">})</span><br><span class="line">.catch(<span class="function"><span class="params">e</span> =&gt;</span> {</span><br><span class="line">  returnError(e);</span><br><span class="line">  runFinalCode();</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>In more recent modern browsers, the <code>.finally()</code> method is available, which can be chained onto the end of your regular promise chain allowing you to cut down on code repetition and do things more elegantly. The above code can now be written as follows:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">myPromise</span><br><span class="line">.then(<span class="function"><span class="params">response</span> =&gt;</span> {</span><br><span class="line">  doSomething(response);</span><br><span class="line">})</span><br><span class="line">.catch(<span class="function"><span class="params">e</span> =&gt;</span> {</span><br><span class="line">  returnError(e);</span><br><span class="line">})</span><br><span class="line">.finally(<span class="function">() =&gt;</span> {</span><br><span class="line">  runFinalCode();</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>This works exactly the same as the <code>Promise.all()</code> demo we looked at in the above section, except that in the <code>fetchAndDecode()</code> function we chain a <code>finally()</code> call on to the end of the chain:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetchAndDecode</span>(<span class="params">url, type</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> fetch(url).then(<span class="function"><span class="params">response</span> =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span>(type === <span class="string">'blob'</span>) {</span><br><span class="line">      <span class="keyword">return</span> response.blob();</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span>(type === <span class="string">'text'</span>) {</span><br><span class="line">      <span class="keyword">return</span> response.text();</span><br><span class="line">    }</span><br><span class="line">  })</span><br><span class="line">  .catch(<span class="function"><span class="params">e</span> =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`There has been a problem with your fetch operation for resource "<span class="subst">${url}</span>": `</span> + e.message);</span><br><span class="line">  })</span><br><span class="line">  .finally(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`fetch attempt for "<span class="subst">${url}</span>" finished.`</span>);</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>This logs a simple message to the console to tell us when each fetch attempt has finished.</p>
<p><strong>Note</strong>: <code>finally()</code> allows you to write async equivalents to try/catch/finally in async code.</p>
<p><a href="web/js/async/intro/web_js_async_promise-finally.html" target="_blank">See the finished Here</a></p>
<h3 id="using-the-promise-constructor"><a class="markdownIt-Anchor" href="#using-the-promise-constructor"></a> Using the Promise() constructor</h3>
<p>It is possible to build your own promises using the <code>Promise()</code> constructor. The main situation in which you’ll want to do this is when you’ve got code based on an an old-school asynchronous API that is not promise-based, which you want to promis-ify. This comes in handy when you need to use existing, older project code, libraries, or frameworks along with modern promise-based code.</p>
<p>Let’s have a look at a simple example to get you started — here we wrap a <code>setTimeout()</code> call with a promise — this runs a function after two seconds that resolves the promise (using the passed <code>resolve()</code> call) with a string of “Success!”.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> timeoutPromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">    resolve(<span class="string">'Success!'</span>);</span><br><span class="line">  }, <span class="number">2000</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p><code>resolve()</code> and <code>reject()</code> are functions that you call to fulfill or reject the newly-created promise. In this case, the promise fulfills with a string of “Success!”.</p>
<p>So when you call this promise, you can chain a <code>.then()</code> block onto the end of it and it will be passed a string of “Success!”. In the below code we simply alert that message:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">timeoutPromise</span><br><span class="line">.then(<span class="function">(<span class="params">message</span>) =&gt;</span> {</span><br><span class="line">   alert(message);</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>
<p>or even just</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timeoutPromise.then(alert);</span><br></pre></td></tr></tbody></table></figure>
<p>Let’s extend the previous example to have some <code>reject()</code> conditions as well as allowing different messages to be passed upon success.</p>
<p>Replace the existing <code>timeoutPromise()</code> definition with this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">timeoutPromise</span>(<span class="params">message, interval</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span> (message === <span class="string">''</span> || <span class="keyword">typeof</span> message !== <span class="string">'string'</span>) {</span><br><span class="line">      reject(<span class="string">'Message is empty or not a string'</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (interval &lt; <span class="number">0</span> || <span class="keyword">typeof</span> interval !== <span class="string">'number'</span>) {</span><br><span class="line">      reject(<span class="string">'Interval is negative or not a number'</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        resolve(message);</span><br><span class="line">      }, interval);</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>Here we are passing two arguments into a custom function — a message to do something with, and the time interval to pass before doing the thing. Inside the function we then return a new <code>Promise</code> object — invoking the function will return the promise we want to use.</p>
<p>Inside the Promise constructor, we do a number of checks inside <code>if ... else</code> structures:</p>
<ol>
<li>First of all we check to see if the message is appropriate for being alerted. If it is an empty string or not a string at all, we reject the promise with a suitable error message.</li>
<li>Next, we check to see if the interval is an appropriate interval value. If it is negative or not a number, we reject the promise with a suitable error message.</li>
<li>Finally, if the parameters both look OK, we resolve the promise with the specified message after the specified interval has passed using <code>setTimeout()</code>.</li>
</ol>
<p>Since the <code>timeoutPromise()</code> function returns a <code>Promise</code>, we can chain <code>.then()</code>, <code>.catch()</code>, etc. onto it to make use of its functionality. Let’s use it now — replace the previous <code>timeoutPromise</code> usage with this one:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">timeoutPromise(<span class="string">'Hello there!'</span>, <span class="number">1000</span>)</span><br><span class="line">.then(<span class="function"><span class="params">message</span> =&gt;</span> {</span><br><span class="line">   alert(message);</span><br><span class="line">})</span><br><span class="line">.catch(<span class="function"><span class="params">e</span> =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Error: '</span> + e);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>When you save and run the code as is, after one second you’ll get the message alerted. Now try setting the message to an empty string or the interval to a negative number, for example, and you’ll be able to see the promise reject with the appropriate error messages! You could also try doing something else with the resolved message rather than just alerting it.</p>
<p><a href="web/js/async/intro/web_js_async_custom-promise2.html" target="_blank">See Live Here</a></p>
<h3 id="a-more-real-world-example"><a class="markdownIt-Anchor" href="#a-more-real-world-example"></a> A more real-world example</h3>
<p>The above example was kept deliberately simple to make the concepts easy to understand, but it is not really very async. The asynchronous nature is basically faked using <code>setTimeout()</code>, although it does still show that promises are useful for creating a custom function with sensible flow of operations, good error handling, etc.</p>
<p>One example we’d like to invite you to study, which does show a useful async application of the <code>Promise()</code> constructor, is <a target="_blank" rel="noopener" href="https://github.com/jakearchibald/idb/">Jake Archibald’s idb library</a>. This takes the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API">IndexedDB API</a>, which is an old-style callback-based API for storing and retrieving data on the client-side, and allows you to use it with promises. If you look at the <a target="_blank" rel="noopener" href="https://github.com/jakearchibald/idb/blob/master/lib/idb.js">main library file</a> you’ll see the same kind of techniques we discussed above being used there. The following block converts the basic request model used by many IndexedDB methods to use promises:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">promisifyRequest</span>(<span class="params">request</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>{</span><br><span class="line">    request.onsuccess = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">      resolve(request.result);</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    request.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">      reject(request.error);</span><br><span class="line">    };</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>This works by adding a couple of event handlers that fulfill and reject the promise at appropriate times:</p>
<ul>
<li>When the <code>request</code>'s <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBRequest/success_event"><code>success</code> event</a> fires, the <code>onsuccess</code> handler fulfills the promise with the request <code>result</code>.</li>
<li>When the <code>request</code>'s <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBRequest/error_event"><code>error</code> event</a> fires, the <code>onerror</code> handler rejects the promise with the request <code>error</code>.</li>
</ul>
<h2 id="asyncawait"><a class="markdownIt-Anchor" href="#asyncawait"></a> Async/await</h2>
<h3 id="the-async-keyword"><a class="markdownIt-Anchor" href="#the-async-keyword"></a> The async keyword</h3>
<p>First of all we have the <code>async</code> keyword, which you put in front of a function declaration to turn it into an async function. An async function is a function which knows how to expect the possibility of the <code>await</code> keyword being used to invoke asynchronous code.</p>
<p>Try typing the following lines into your browser’s JS console:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>) </span>{ <span class="keyword">return</span> <span class="string">"Hello"</span> };</span><br><span class="line">hello();</span><br></pre></td></tr></tbody></table></figure>
<p>The function returns “Hello” — nothing special, right?</p>
<p>But what if we turn this into an async function? Try the following:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>) </span>{ <span class="keyword">return</span> <span class="string">"Hello"</span> };</span><br><span class="line">hello();</span><br></pre></td></tr></tbody></table></figure>
<p>Ah. Invoking the function now returns a promise. This is one of the traits of async functions — it turns any function into a promise.</p>
<p>You can also create an async function expression, like so:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> hello = <span class="keyword">async</span> () =&gt; { <span class="keyword">return</span> <span class="string">"Hello"</span> };</span><br><span class="line">hello();</span><br></pre></td></tr></tbody></table></figure>
<p>These all do basically the same thing.</p>
<p>To actually consume the value returned when the promise fulfills, since it is returning a promise, we could use a <code>.then()</code> block:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello().then(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="built_in">console</span>.log(value))</span><br></pre></td></tr></tbody></table></figure>
<p>or even just shorthand such as</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello().then(<span class="built_in">console</span>.log)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="the-await-keyword"><a class="markdownIt-Anchor" href="#the-await-keyword"></a> The await keyword</h3>
<p>The real advantage of async functions becomes apparent when you combine it with the await keyword. This can be put in front of any async promise-based function to pause your code on that line until the promise fulfills, then return the resulting value. In the meantime, other code that may be waiting for a chance to execute gets to do so.</p>
<p>You can use <code>await</code> when calling any function that returns a Promise, including web API functions.</p>
<p>Here is a trivial example:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> greeting = <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(<span class="string">"Hello"</span>);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">hello().then(alert);</span><br></pre></td></tr></tbody></table></figure>
<p>Of course, the above example is not very useful, although it does serve to illustrate the syntax. Let’s move on and look at a real example.</p>
<h3 id="rewriting-promise-code-with-asyncawait"><a class="markdownIt-Anchor" href="#rewriting-promise-code-with-asyncawait"></a> Rewriting promise code with async/await</h3>
<p>Let’s look back at a simple fetch example that we saw in the previous article:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">'coffee.jpg'</span>)</span><br><span class="line">.then(<span class="function"><span class="params">response</span> =&gt;</span> response.blob())</span><br><span class="line">.then(<span class="function"><span class="params">myBlob</span> =&gt;</span> {</span><br><span class="line">  <span class="keyword">let</span> objectURL = URL.createObjectURL(myBlob);</span><br><span class="line">  <span class="keyword">let</span> image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  image.src = objectURL;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">})</span><br><span class="line">.catch(<span class="function"><span class="params">e</span> =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'There has been a problem with your fetch operation: '</span> + e.message);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>By now, you should have a reasonable understanding of promises and how they work, but let’s convert this to use async/await to see how much simpler it makes things:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">myFetch</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> response = <span class="keyword">await</span> fetch(<span class="string">'coffee.jpg'</span>);</span><br><span class="line">  <span class="keyword">let</span> myBlob = <span class="keyword">await</span> response.blob();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> objectURL = URL.createObjectURL(myBlob);</span><br><span class="line">  <span class="keyword">let</span> image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  image.src = objectURL;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">myFetch();</span><br></pre></td></tr></tbody></table></figure>
<p>It makes code much simpler and easier to understand — no more <code>.then()</code> blocks everywhere!</p>
<p>Since an <code>async</code> keyword turns a function into a promise, you could refactor your code to use a hybrid approach of promises and await, bringing the second half of the function out into a new block to make it more flexible:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">myFetch</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> response = <span class="keyword">await</span> fetch(<span class="string">'coffee.jpg'</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> response.blob();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">myFetch().then(<span class="function">(<span class="params">blob</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">let</span> objectURL = URL.createObjectURL(blob);</span><br><span class="line">  <span class="keyword">let</span> image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  image.src = objectURL;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p><a href="web/js/async/intro/web_js_async_simple-fetch-async-await.html" target="_blank">See Live Here</a></p>
<h3 id="adding-error-handling"><a class="markdownIt-Anchor" href="#adding-error-handling"></a> Adding error handling</h3>
<p>And if you want to add error handling, you’ve got a couple of options.</p>
<p>You can use a synchronous <code>try...catch</code> structure with <code>async</code>/<code>await</code>. This example expands on the first version of the code we showed above:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">myFetch</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">let</span> response = <span class="keyword">await</span> fetch(<span class="string">'coffee.jpg'</span>);</span><br><span class="line">    <span class="keyword">let</span> myBlob = <span class="keyword">await</span> response.blob();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> objectURL = URL.createObjectURL(myBlob);</span><br><span class="line">    <span class="keyword">let</span> image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">    image.src = objectURL;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">  } <span class="keyword">catch</span>(e) {</span><br><span class="line">    <span class="built_in">console</span>.log(e);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">myFetch();</span><br></pre></td></tr></tbody></table></figure>
<p>The <code>catch() {}</code> block is passed an error object, which we’ve called <code>e</code>; we can now log that to the console, and it will give us a detailed error message showing where in the code the error was thrown.</p>
<p>If you wanted to use the second (refactored) version of the code that we showed above, you would be better off just continuing the hybrid approach and chaining a <code>.catch()</code> block onto the end of the <code>.then()</code> call, like this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">myFetch</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> response = <span class="keyword">await</span> fetch(<span class="string">'coffee.jpg'</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> response.blob();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">myFetch().then(<span class="function">(<span class="params">blob</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">let</span> objectURL = URL.createObjectURL(blob);</span><br><span class="line">  <span class="keyword">let</span> image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  image.src = objectURL;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">})</span><br><span class="line">.catch(<span class="function">(<span class="params">e</span>) =&gt;</span></span><br><span class="line">  <span class="built_in">console</span>.log(e)</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>
<p>This is because the <code>.catch()</code> block will catch errors occurring in both the async function call and the promise chain. If you used the <code>try</code>/<code>catch</code> block here, you might still get unhandled errors in the <code>myFetch()</code> function when it’s called.</p>
<p>You can find both of these examples on GitHub:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/async-await/simple-fetch-async-await-try-catch.html">simple-fetch-async-await-try-catch.html</a> (see <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/async-await/simple-fetch-async-await-try-catch.html">source code</a>)</li>
<li><a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/async-await/simple-fetch-async-await-promise-catch.html">simple-fetch-async-await-promise-catch.html</a> (see <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/async-await/simple-fetch-async-await-promise-catch.html">source code</a>)</li>
</ul>
<h3 id="awaiting-a-promiseall"><a class="markdownIt-Anchor" href="#awaiting-a-promiseall"></a> Awaiting a Promise.all()</h3>
<p>async/await is built on top of <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">promises</a>, so it’s compatible with all the features offered by promises. This includes <code>Promise.all()</code> — you can quite happily await a <code>Promise.all()</code> call to get all the results returned into a variable in a way that looks like simple synchronous code. Again, let’s return to <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/promises/promise-all.html">an example we saw in our previous article</a>. Keep it open in a separate tab so you can compare and contrast with the new version shown below.</p>
<p>Converting this to async/await (see <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/async-await/promise-all-async-await.html">live demo</a> and <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/async-await/promise-all-async-await.html">source code</a>), this now looks like so:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchAndDecode</span>(<span class="params">url, type</span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> response = <span class="keyword">await</span> fetch(url);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> content;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(type === <span class="string">'blob'</span>) {</span><br><span class="line">    content = <span class="keyword">await</span> response.blob();</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span>(type === <span class="string">'text'</span>) {</span><br><span class="line">    content = <span class="keyword">await</span> response.text();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> content;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">displayContent</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> coffee = fetchAndDecode(<span class="string">'coffee.jpg'</span>, <span class="string">'blob'</span>);</span><br><span class="line">  <span class="keyword">let</span> tea = fetchAndDecode(<span class="string">'tea.jpg'</span>, <span class="string">'blob'</span>);</span><br><span class="line">  <span class="keyword">let</span> description = fetchAndDecode(<span class="string">'description.txt'</span>, <span class="string">'text'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> values = <span class="keyword">await</span> <span class="built_in">Promise</span>.all([coffee, tea, description]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> objectURL1 = URL.createObjectURL(values[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">let</span> objectURL2 = URL.createObjectURL(values[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">let</span> descText = values[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> image1 = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  <span class="keyword">let</span> image2 = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  image1.src = objectURL1;</span><br><span class="line">  image2.src = objectURL2;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image1);</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image2);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> para = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>);</span><br><span class="line">  para.textContent = descText;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(para);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">displayContent()</span><br><span class="line">.catch(<span class="function">(<span class="params">e</span>) =&gt;</span></span><br><span class="line">  <span class="built_in">console</span>.log(e)</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>
<p>You’ll see that the <code>fetchAndDecode()</code> function has been converted easily into an async function with just a few changes. See the <code>Promise.all()</code> line:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> values = <span class="keyword">await</span> <span class="built_in">Promise</span>.all([coffee, tea, description]);</span><br></pre></td></tr></tbody></table></figure>
<p>By using <code>await</code> here we are able to get all the results of the three promises returned into the <code>values</code> array, when they are all available, in a way that looks very much like sync code. We’ve had to wrap all the code in a new async function, <code>displayContent()</code>, and we’ve not reduced the code by a lot of lines, but being able to move the bulk of the code out of the <code>.then()</code> block provides a nice, useful simplification, leaving us with a much more readable program.</p>
<p>For error handling, we’ve included a <code>.catch()</code> block on our <code>displayContent()</code> call; this will handle errors ocurring in both functions.</p>
<p><strong>Note</strong>: It is also possible to use a sync <code>finally</code> block within an async function, in place of a <code>.finally()</code> async block, to show a final report on how the operation went — you can see this in action in our <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/async-await/promise-finally-async-await.html">promise-finally-async-await.html</a> example.</p>
<h3 id="the-downsides-of-asyncawait"><a class="markdownIt-Anchor" href="#the-downsides-of-asyncawait"></a> The downsides of async/await</h3>
<p>Async/await is really useful to know about, but there are a couple of downsides to consider.</p>
<p>Async/await makes your code look synchronous, and in a way it makes it behave more synchronously. The <code>await</code> keyword blocks execution of all the code that follows until the promise fulfills, exactly as it would with a synchronous operation. It does allow other tasks to continue to run in the meantime, but your own code is blocked.</p>
<p>This means that your code could be slowed down by a significant number of awaited promises happening straight after one another. Each <code>await</code> will wait for the previous one to finish, whereas actually what you want is for the promises to begin processing simultaneously, like they would do if we weren’t using async/await.</p>
<p>There is a pattern that can mitigate this problem — setting off all the promise processes by storing the <code>Promise</code> objects in variables, and then awaiting them all afterwards. Let’s have a look at some examples that prove the concept.</p>
<p>We’ve got two examples available — <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/async-await/slow-async-await.html">slow-async-await.html</a> (see <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/async-await/slow-async-await.html">source code</a>) and <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/async-await/fast-async-await.html">fast-async-await.html</a> (see <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/async-await/fast-async-await.html">source code</a>). Both of them start off with a custom promise function that fakes an async process with a <code>setTimeout()</code> call:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">timeoutPromise</span>(<span class="params">interval</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">      resolve(<span class="string">"done"</span>);</span><br><span class="line">    }, interval);</span><br><span class="line">  });</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>Then each one includes a <code>timeTest()</code> async function that awaits three <code>timeoutPromise()</code>calls:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">timeTest</span>(<span class="params"></span>) </span>{</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Each one ends by recording a start time, seeing how long the <code>timeTest()</code> promise takes to fulfill, then recording an end time and reporting how long the operation took in total:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> startTime = <span class="built_in">Date</span>.now();</span><br><span class="line">timeTest().then(<span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="keyword">let</span> finishTime = <span class="built_in">Date</span>.now();</span><br><span class="line">  <span class="keyword">let</span> timeTaken = finishTime - startTime;</span><br><span class="line">  alert(<span class="string">"Time taken in milliseconds: "</span> + timeTaken);</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>
<p>It is the <code>timeTest()</code> function that differs in each case.</p>
<p>In the <code>slow-async-await.html</code> example, <code>timeTest()</code> looks like this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">timeTest</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">await</span> timeoutPromise(<span class="number">3000</span>);</span><br><span class="line">  <span class="keyword">await</span> timeoutPromise(<span class="number">3000</span>);</span><br><span class="line">  <span class="keyword">await</span> timeoutPromise(<span class="number">3000</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Here we simply await all three <code>timeoutPromise()</code> calls directly, making each one alert for 3 seconds. Each subsequent one is forced to wait until the last one finished — if you run the first example, you’ll see the alert box reporting a total run time of around 9 seconds.</p>
<p>In the <code>fast-async-await.html</code> example, <code>timeTest()</code> looks like this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">timeTest</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">const</span> timeoutPromise1 = timeoutPromise(<span class="number">3000</span>);</span><br><span class="line">  <span class="keyword">const</span> timeoutPromise2 = timeoutPromise(<span class="number">3000</span>);</span><br><span class="line">  <span class="keyword">const</span> timeoutPromise3 = timeoutPromise(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> timeoutPromise1;</span><br><span class="line">  <span class="keyword">await</span> timeoutPromise2;</span><br><span class="line">  <span class="keyword">await</span> timeoutPromise3;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Here we store the three <code>Promise</code> objects in variables, which has the effect of setting off their associated processes all running simultaneously.</p>
<p>Next, we await their results — because the promises all started processing at essentially the same time, the promises will all fulfill at the same time; when you run the second example, you’ll see the alert box reporting a total run time of just over 3 seconds!</p>
<p>You’ll have to test your code carefully, and bear this in mind if performance starts to suffer.</p>
<p>Another minor inconvenience is that you have to wrap your awaited promises inside an async function.</p>
<h3 id="asyncawait-class-methods"><a class="markdownIt-Anchor" href="#asyncawait-class-methods"></a> Async/await class methods</h3>
<p>As a final note before we move on, you can even add <code>async</code> in front of class/object methods to make them return promises, and <code>await</code> promises inside them. Take a look at the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/Inheritance#ECMAScript_2015_Classes">ES class code we saw in our object-oriented JavaScript article</a>, and then look at our modified version with an <code>async</code> method:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>{</span><br><span class="line">  <span class="keyword">constructor</span>(first, last, age, gender, interests) {</span><br><span class="line">    <span class="built_in">this</span>.name = {</span><br><span class="line">      first,</span><br><span class="line">      last</span><br><span class="line">    };</span><br><span class="line">    <span class="built_in">this</span>.age = age;</span><br><span class="line">    <span class="built_in">this</span>.gender = gender;</span><br><span class="line">    <span class="built_in">this</span>.interests = interests;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> greeting() {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(<span class="string">`Hi! I'm <span class="subst">${<span class="built_in">this</span>.name.first}</span>`</span>);</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  farewell() {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">${<span class="built_in">this</span>.name.first}</span> has left the building. Bye for now!`</span>);</span><br><span class="line">  };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> han = <span class="keyword">new</span> Person(<span class="string">'Han'</span>, <span class="string">'Solo'</span>, <span class="number">25</span>, <span class="string">'male'</span>, [<span class="string">'Smuggling'</span>]);</span><br></pre></td></tr></tbody></table></figure>
<p>The first class method could now be used something like this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">han.greeting().then(<span class="built_in">console</span>.log);</span><br></pre></td></tr></tbody></table></figure>
<h2 id="asynchronous"><a class="markdownIt-Anchor" href="#asynchronous"></a> Asynchronous</h2>
<h3 id="asynchronous-callbacks"><a class="markdownIt-Anchor" href="#asynchronous-callbacks"></a> Asynchronous callbacks</h3>
<p>Generally found in old-style APIs, involves a function being passed into another function as a parameter, which is then invoked when an asynchronous operation has been completed, so that the callback can in turn do something with the result. This is the precursor to promises; it’s not as efficient or flexible. Use only when necessary.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Single delayed operation</th>
<th style="text-align:left">Repeating operation</th>
<th style="text-align:left">Multiple sequential operations</th>
<th style="text-align:left">Multiple simultaneous operations</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">No</td>
<td style="text-align:left">Yes (recursive callbacks)</td>
<td style="text-align:left">Yes (nested callbacks)</td>
<td style="text-align:left">No</td>
</tr>
</tbody>
</table>
<p>An example that loads a resource via the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest"><code>XMLHttpRequest</code> API</a> (<a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/introducing/xhr-async-callback.html">run it live</a>, and <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/introducing/xhr-async-callback.html">see the source</a>):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadAsset</span>(<span class="params">url, type, callback</span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  xhr.open(<span class="string">'GET'</span>, url);</span><br><span class="line">  xhr.responseType = type;</span><br><span class="line"></span><br><span class="line">  xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">    callback(xhr.response);</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  xhr.send();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">displayImage</span>(<span class="params">blob</span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> objectURL = URL.createObjectURL(blob);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  image.src = objectURL;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">loadAsset(<span class="string">'coffee.jpg'</span>, <span class="string">'blob'</span>, displayImage);</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Pitfalls</strong></p>
<ul>
<li>Nested callbacks can be cumbersome and hard to read (i.e. “callback hell”).</li>
<li>Failure callbacks need to be called once for each level of nesting, whereas with promises you can just use a single <code>.catch()</code> block to handle the errors for the entire chain.</li>
<li>Async callbacks just aren’t very graceful.</li>
<li>Promise callbacks are always called in the strict order they are placed in the event queue; async callbacks aren’t.</li>
</ul>
<h3 id="settimeout-2"><a class="markdownIt-Anchor" href="#settimeout-2"></a> setTimeout()</h3>
<p><code>setTimeout()</code> is a method that allows you to run a function after an arbitrary amount of time has passed.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Single delayed operation</th>
<th style="text-align:left">Repeating operation</th>
<th style="text-align:left">Multiple sequential operations</th>
<th style="text-align:left">Multiple simultaneous operations</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Yes</td>
<td style="text-align:left">Yes (recursive timeouts)</td>
<td style="text-align:left">Yes (nested timeouts)</td>
<td style="text-align:left">No</td>
</tr>
</tbody>
</table>
<p>Here the browser will wait two seconds before executing the anonymous function, then will display the alert message (<a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/simple-settimeout.html">see it running live</a>, and <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/simple-settimeout.html">see the source code</a>):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myGreeting = <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">  alert(<span class="string">'Hello, Mr. Universe!'</span>);</span><br><span class="line">}, <span class="number">2000</span>)</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Pitfalls</strong></p>
<p>You can use recursive <code>setTimeout()</code> calls to run a function repeatedly in a similar fashion to <code>setInterval()</code>, using code like this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(i);</span><br><span class="line">  i++;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">setTimeout</span>(run, <span class="number">100</span>);</span><br><span class="line">}, <span class="number">100</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>There is a difference between recursive <code>setTimeout()</code> and <code>setInterval()</code>:</p>
<ul>
<li>Recursive <code>setTimeout()</code> guarantees at least the specified amount of time (100ms in this example) will elapse between the executions; the code will run and then wait 100 milliseconds before it runs again. The interval will be the same regardless of how long the code takes to run.</li>
<li>With <code>setInterval()</code>, the interval we choose <em>includes</em> the time taken to execute the code we want to run in. Let’s say that the code takes 40 milliseconds to run — the interval then ends up being only 60 milliseconds.</li>
</ul>
<p>When your code has the potential to take longer to run than the time interval you’ve assigned, it’s better to use recursive <code>setTimeout()</code> — this will keep the time interval constant between executions regardless of how long the code takes to execute, and you won’t get errors.</p>
<h3 id="setinterval-2"><a class="markdownIt-Anchor" href="#setinterval-2"></a> setInterval()</h3>
<p><code>setInterval()</code> is a method that allows you to run a function repeatedly with a set interval of time between each execution. Not as efficient as <code>requestAnimationFrame()</code>, but allows you to choose a running rate/frame rate.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Single delayed operation</th>
<th style="text-align:left">Repeating operation</th>
<th style="text-align:left">Multiple sequential operations</th>
<th style="text-align:left">Multiple simultaneous operations</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">No</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">No (unless it is the same one)</td>
<td style="text-align:left">No</td>
</tr>
</tbody>
</table>
<p>The following function creates a new <code>Date()</code> object, extracts a time string out of it using <code>toLocaleTimeString()</code>, and then displays it in the UI. We then run it once per second using <code>setInterval()</code>, creating the effect of a digital clock that updates once per second (<a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/setinterval-clock.html">see this live</a>, and also <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/setinterval-clock.html">see the source</a>):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">displayTime</span>(<span class="params"></span>) </span>{</span><br><span class="line">   <span class="keyword">let</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">   <span class="keyword">let</span> time = date.toLocaleTimeString();</span><br><span class="line">   <span class="built_in">document</span>.getElementById(<span class="string">'demo'</span>).textContent = time;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createClock = <span class="built_in">setInterval</span>(displayTime, <span class="number">1000</span>);</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Pitfalls</strong></p>
<ul>
<li>The frame rate isn’t optimized for the system the animation is running on, and can be somewhat inefficient. Unless you need to choose a specific (slower) framerate, it is generally better to use <code>requestAnimationFrame()</code>.</li>
</ul>
<h3 id="requestanimationframe-2"><a class="markdownIt-Anchor" href="#requestanimationframe-2"></a> requestAnimationFrame()</h3>
<p><code>requestAnimationFrame()</code> is a method that allows you to run a function repeatedly, and efficiently, at the best framerate available given the current browser/system. You should, if at all possible, use this instead of <code>setInterval()</code>/recursive <code>setTimeout()</code>, unless you need a specific framerate.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Single delayed operation</th>
<th style="text-align:left">Repeating operation</th>
<th style="text-align:left">Multiple sequential operations</th>
<th style="text-align:left">Multiple simultaneous operations</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">No</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">No (unless it is the same one)</td>
<td style="text-align:left">No</td>
</tr>
</tbody>
</table>
<p>A simple animated spinner; you can find this <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/simple-raf-spinner.html">example live on GitHub</a> (see the <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/simple-raf-spinner.html">source code</a>also):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> spinner = <span class="built_in">document</span>.querySelector(<span class="string">'div'</span>);</span><br><span class="line"><span class="keyword">let</span> rotateCount = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> startTime = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> rAF;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">draw</span>(<span class="params">timestamp</span>) </span>{</span><br><span class="line">  <span class="keyword">if</span>(!startTime) {</span><br><span class="line">    startTime = timestamp;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> rotateCount = (timestamp - startTime) / <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">  spinner.style.transform = <span class="string">'rotate('</span> + rotateCount + <span class="string">'deg)'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(rotateCount &gt; <span class="number">359</span>) {</span><br><span class="line">    rotateCount = <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line"> </span><br><span class="line">  rAF = requestAnimationFrame(draw);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">draw();</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Pitfalls</strong></p>
<ul>
<li>You can’t choose a specific framerate with <code>requestAnimationFrame()</code>. If you need to run your animation at a slower framerate, you’ll need to use <code>setInterval()</code> or recursive <code>setTimeout()</code>.</li>
</ul>
<h3 id="promises-2"><a class="markdownIt-Anchor" href="#promises-2"></a> Promises</h3>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promises</a> are a JavaScript feature that allows you to run asynchronous operations and wait until it is definitely complete before running another operation based on its result. Promises are the backbone of modern asynchronous JavaScript.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Single delayed operation</th>
<th style="text-align:left">Repeating operation</th>
<th style="text-align:left">Multiple sequential operations</th>
<th style="text-align:left">Multiple simultaneous operations</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">No</td>
<td style="text-align:left">No</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">See <code>Promise.all()</code>, below</td>
</tr>
</tbody>
</table>
<p>The following code fetches an image from the server and displays it inside an <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/img">``</a> element; <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/promises/simple-fetch-chained.html">see it live also</a>, and see also <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/promises/simple-fetch-chained.html">the source code</a>:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">'coffee.jpg'</span>)</span><br><span class="line">.then(<span class="function"><span class="params">response</span> =&gt;</span> response.blob())</span><br><span class="line">.then(<span class="function"><span class="params">myBlob</span> =&gt;</span> {</span><br><span class="line">  <span class="keyword">let</span> objectURL = URL.createObjectURL(myBlob);</span><br><span class="line">  <span class="keyword">let</span> image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  image.src = objectURL;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">})</span><br><span class="line">.catch(<span class="function"><span class="params">e</span> =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'There has been a problem with your fetch operation: '</span> + e.message);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Pitfalls</strong></p>
<p>Promise chains can be complex and hard to parse. If you nest a number of promises, you can end up with similar troubles to callback hell. For example:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">remotedb.allDocs({</span><br><span class="line">  include_docs: <span class="literal">true</span>,</span><br><span class="line">  attachments: <span class="literal">true</span></span><br><span class="line">}).then(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>{</span><br><span class="line">  <span class="keyword">var</span> docs = result.rows;</span><br><span class="line">  docs.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">element</span>) </span>{</span><br><span class="line">    localdb.put(element.doc).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>{</span><br><span class="line">      alert(<span class="string">"Pulled doc with id "</span> + element.doc._id + <span class="string">" and added to local db."</span>);</span><br><span class="line">    }).catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>{</span><br><span class="line">      <span class="keyword">if</span> (err.name == <span class="string">'conflict'</span>) {</span><br><span class="line">        localdb.get(element.doc._id).then(<span class="function"><span class="keyword">function</span> (<span class="params">resp</span>) </span>{</span><br><span class="line">          localdb.remove(resp._id, resp._rev).then(<span class="function"><span class="keyword">function</span> (<span class="params">resp</span>) </span>{</span><br><span class="line"><span class="comment">// et cetera...</span></span><br></pre></td></tr></tbody></table></figure>
<p>It is better to use the chaining power of promises to go with a flatter, easier to parse structure:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">remotedb.allDocs(...).then(<span class="function"><span class="keyword">function</span> (<span class="params">resultOfAllDocs</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> localdb.put(...);</span><br><span class="line">}).then(<span class="function"><span class="keyword">function</span> (<span class="params">resultOfPut</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> localdb.get(...);</span><br><span class="line">}).then(<span class="function"><span class="keyword">function</span> (<span class="params">resultOfGet</span>) </span>{</span><br><span class="line">  <span class="keyword">return</span> localdb.put(...);</span><br><span class="line">}).catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>or even:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">remotedb.allDocs(...)</span><br><span class="line">.then(<span class="function"><span class="params">resultOfAllDocs</span> =&gt;</span> {</span><br><span class="line">  <span class="keyword">return</span> localdb.put(...);</span><br><span class="line">})</span><br><span class="line">.then(<span class="function"><span class="params">resultOfPut</span> =&gt;</span> {</span><br><span class="line">  <span class="keyword">return</span> localdb.get(...);</span><br><span class="line">})</span><br><span class="line">.then(<span class="function"><span class="params">resultOfGet</span> =&gt;</span> {</span><br><span class="line">  <span class="keyword">return</span> localdb.put(...);</span><br><span class="line">})</span><br><span class="line">.catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err));</span><br></pre></td></tr></tbody></table></figure>
<p>That covers a lot of the basics. For a much more complete treatment, see the excellent <a target="_blank" rel="noopener" href="https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html">We have a problem with promises</a>, by Nolan Lawson.</p>
<h3 id="promiseall"><a class="markdownIt-Anchor" href="#promiseall"></a> Promise.all()</h3>
<p>A JavaScript feature that allows you wait for multiple promises to complete before then running a further operation based on the results of all the other promises.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Single delayed operation</th>
<th style="text-align:left">Repeating operation</th>
<th style="text-align:left">Multiple sequential operations</th>
<th style="text-align:left">Multiple simultaneous operations</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">No</td>
<td style="text-align:left">No</td>
<td style="text-align:left">No</td>
<td style="text-align:left">Yes</td>
</tr>
</tbody>
</table>
<p>The following example fetches several resources from the server, and uses <code>Promise.all()</code> to wait for all of them to be available before then displaying all of them — <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/promises/promise-all.html">see it live</a>, and see the <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/promises/promise-all.html">source code</a>:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetchAndDecode</span>(<span class="params">url, type</span>) </span>{</span><br><span class="line">  <span class="comment">// Returning the top level promise, so the result of the entire chain is returned out of the function</span></span><br><span class="line">  <span class="keyword">return</span> fetch(url).then(<span class="function"><span class="params">response</span> =&gt;</span> {</span><br><span class="line">    <span class="comment">// Depending on what type of file is being fetched, use the relevant function to decode its contents</span></span><br><span class="line">    <span class="keyword">if</span>(type === <span class="string">'blob'</span>) {</span><br><span class="line">      <span class="keyword">return</span> response.blob();</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span>(type === <span class="string">'text'</span>) {</span><br><span class="line">      <span class="keyword">return</span> response.text();</span><br><span class="line">    }</span><br><span class="line">  })</span><br><span class="line">  .catch(<span class="function"><span class="params">e</span> =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`There has been a problem with your fetch operation for resource "<span class="subst">${url}</span>": `</span> + e.message);</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Call the fetchAndDecode() method to fetch the images and the text, and store their promises in variables</span></span><br><span class="line"><span class="keyword">let</span> coffee = fetchAndDecode(<span class="string">'coffee.jpg'</span>, <span class="string">'blob'</span>);</span><br><span class="line"><span class="keyword">let</span> tea = fetchAndDecode(<span class="string">'tea.jpg'</span>, <span class="string">'blob'</span>);</span><br><span class="line"><span class="keyword">let</span> description = fetchAndDecode(<span class="string">'description.txt'</span>, <span class="string">'text'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use Promise.all() to run code only when all three function calls have resolved</span></span><br><span class="line"><span class="built_in">Promise</span>.all([coffee, tea, description]).then(<span class="function"><span class="params">values</span> =&gt;</span> {</span><br><span class="line">  <span class="built_in">console</span>.log(values);</span><br><span class="line">  <span class="comment">// Store each value returned from the promises in separate variables; create object URLs from the blobs</span></span><br><span class="line">  <span class="keyword">let</span> objectURL1 = URL.createObjectURL(values[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">let</span> objectURL2 = URL.createObjectURL(values[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">let</span> descText = values[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Display the images in &lt;img&gt; elements</span></span><br><span class="line">  <span class="keyword">let</span> image1 = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  <span class="keyword">let</span> image2 = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  image1.src = objectURL1;</span><br><span class="line">  image2.src = objectURL2;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image1);</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Display the text in a paragraph</span></span><br><span class="line">  <span class="keyword">let</span> para = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>);</span><br><span class="line">  para.textContent = descText;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(para);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Pitfalls</strong></p>
<ul>
<li>If a <code>Promise.all()</code> rejects, then one or more of the promises you are feeding into it inside its array parameter must be rejecting, or might not be returning promises at all. You need to check each one to see what they returned.</li>
</ul>
<h3 id="asyncawait-2"><a class="markdownIt-Anchor" href="#asyncawait-2"></a> Async/await</h3>
<p>Syntactic sugar built on top of promises that allows you to run asynchronous operations using syntax that’s more like writing synchronous callback code.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Single delayed operation</th>
<th style="text-align:left">Repeating operation</th>
<th style="text-align:left">Multiple sequential operations</th>
<th style="text-align:left">Multiple simultaneous operations</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">No</td>
<td style="text-align:left">No</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">Yes (in combination with <code>Promise.all()</code>)</td>
</tr>
</tbody>
</table>
<p>The following example is a refactor of the simple promise example we saw earlier that fetches and displays an image, writing using async/await (<a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/async-await/simple-refactored-fetch.html">see it live</a>, and see the <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/async-await/simple-refactored-fetch.html">source code</a>):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">myFetch</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="keyword">let</span> response = <span class="keyword">await</span> fetch(<span class="string">'coffee.jpg'</span>);</span><br><span class="line">  <span class="keyword">let</span> myBlob = <span class="keyword">await</span> response.blob();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> objectURL = URL.createObjectURL(myBlob);</span><br><span class="line">  <span class="keyword">let</span> image = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  image.src = objectURL;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(image);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">myFetch();</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Pitfalls</strong></p>
<ul>
<li>You can’t use the <code>await</code> operator inside a non-<code>async</code> function, or in the top level context of your code. This can sometimes result in an extra function wrapper needing to be created, which can be slightly frustrating in some circumstances. But it is worth it most of the time.</li>
<li>Browser support for async/await is not as good as that for promises. If you want to use async/await but are concerned about older browser support, you could consider using the <a target="_blank" rel="noopener" href="https://babeljs.io/">BabelJS</a> library — this allows you to write your applications using the latest JavaScript and let Babel figure out what changes if any are needed for your user’s browsers.</li>
</ul>
<h2 id="references"><a class="markdownIt-Anchor" href="#references"></a> REFERENCES</h2>
<ul>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Body">https://developer.mozilla.org/en-US/docs/Web/API/Body</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Body/blob">https://developer.mozilla.org/en-US/docs/Web/API/Body/blob</a></li>
</ul>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html">https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html</a> by Nolan Lawson</p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous">https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Concepts">https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Concepts</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Introducing">https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Introducing</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Loops_and_intervals">https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Loops_and_intervals</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Promises">https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Promises</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/promise">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/promise</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Async_await">https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Async_await</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Choosing_the_right_approach">https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Choosing_the_right_approach</a></li>
</ul>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API">https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection">https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Signaling_and_video_calling">https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Signaling_and_video_calling</a></li>
</ul>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals">Cooperative asynchronous JavaScript: Timeouts and intervals</a>, in particular <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#setTimeout()">setTimeout()</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout">setTimeout() reference</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals">Cooperative asynchronous JavaScript: Timeouts and intervals</a>, in particular <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval">setInterval()</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval">setInterval() reference</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals">Cooperative asynchronous JavaScript: Timeouts and intervals</a>, in particular <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#requestAnimationFrame()">requestAnimationFrame()</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame">requestAnimationFrame() reference</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Promises">Graceful asynchronous programming with Promises</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises">Using promises</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise reference</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Promises#Running_code_in_response_to_multiple_promises_fulfilling">Running code in response to multiple promises fulfilling</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">Promise.all() reference</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Async_await">Making asynchronous programming easier with async and await</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">Async function reference</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await">Await operator reference</a></p>
</li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Joaxin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://u.pinsflora.xyz/Web/js/web_js_async/">https://u.pinsflora.xyz/Web/js/web_js_async/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Javascript/">Javascript</a></div><div class="post_share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_wechat"></a><a class="a2a_button_sina_weibo"></a><a class="a2a_button_facebook_messenger"></a><a class="a2a_button_email"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a></div></div><script async="async" src="https://static.addtoany.com/menu/page.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/Web/js/web_js_validation/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_tree_dawnlights.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">JavaScript Forms validation</div></div></a></div><div class="next-post pull-right"><a href="/Pysnista/Crawler/py_Crawler06_requests/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover_posts/crawler/requests.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Python Web Crawler Pt.6 - Requests &amp; PyQuery</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/Web/html/web_html_Drag_ Drop/" title="HTML Drag & Drop"><img class="cover" src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_books2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-05-21</div><div class="title">HTML Drag & Drop</div></div></a></div><div><a href="/Web/js/WEB_js_pos/" title="JS Sizes and Scrolling"><img class="cover" src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_erol-ahmed-unsplash.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-09-01</div><div class="title">JS Sizes and Scrolling</div></div></a></div><div><a href="/Web/js/WEB_js_window/" title="BROWSER 对象"><img class="cover" src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_writing-letters-french.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-09-01</div><div class="title">BROWSER 对象</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://avatars2.githubusercontent.com/u/8346164?s=460&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Joaxin</div><div class="author-info__description">When I close my eyes, I'm in my own ♡cean 🐟aves.</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">340</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">110</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">34</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/joaxin"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/joaxin" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:lotility@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">感謝訪問本站，若喜歡請收藏 ^_^</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#concepts"><span class="toc-number">1.</span> <span class="toc-text"> Concepts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#blocking-code"><span class="toc-number">1.1.</span> <span class="toc-text"> Blocking code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#threads"><span class="toc-number">1.2.</span> <span class="toc-text"> Threads</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#javascript-is-single-threaded"><span class="toc-number">1.3.</span> <span class="toc-text"> JavaScript is single threaded</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#asynchronous-code"><span class="toc-number">1.4.</span> <span class="toc-text"> Asynchronous code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#synchronous-javascript"><span class="toc-number">1.5.</span> <span class="toc-text"> Synchronous JavaScript</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#asynchronous-javascript"><span class="toc-number">1.6.</span> <span class="toc-text"> Asynchronous JavaScript</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#async-callbacks"><span class="toc-number">1.7.</span> <span class="toc-text"> Async callbacks</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#introduction"><span class="toc-number">2.</span> <span class="toc-text"> Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#settimeout"><span class="toc-number">2.1.</span> <span class="toc-text"> setTimeout()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#passing-parameters-to-a-settimeout-functionsection"><span class="toc-number">2.2.</span> <span class="toc-text"> Passing parameters to a setTimeout() functionSection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clearing-timeoutssection"><span class="toc-number">2.3.</span> <span class="toc-text"> Clearing timeoutsSection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setinterval"><span class="toc-number">2.4.</span> <span class="toc-text"> setInterval()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clearing-intervalssection"><span class="toc-number">2.5.</span> <span class="toc-text"> Clearing intervalsSection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#active-learning-creating-your-own-stopwatch"><span class="toc-number">2.5.1.</span> <span class="toc-text"> Active learning: Creating your own stopwatch!</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#things-to-keep-in-mind-about-settimeout-and-setinterval"><span class="toc-number">2.6.</span> <span class="toc-text"> Things to keep in mind about setTimeout() and setInterval()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#recursive-timeoutssection"><span class="toc-number">2.7.</span> <span class="toc-text"> Recursive timeoutsSection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#how-do-recursive-settimeout-and-setinterval-differ"><span class="toc-number">2.7.1.</span> <span class="toc-text"> How do recursive setTimeout() and setInterval() differ?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#immediate-timeoutssection"><span class="toc-number">2.8.</span> <span class="toc-text"> Immediate timeoutsSection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clearing-with-cleartimeout-or-clearintervalsection"><span class="toc-number">2.9.</span> <span class="toc-text"> Clearing with clearTimeout() or clearInterval()Section</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#requestanimationframe"><span class="toc-number">2.10.</span> <span class="toc-text"> requestAnimationFrame()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#how-fast-does-your-animation-runsection"><span class="toc-number">2.11.</span> <span class="toc-text"> How fast does your animation run?Section</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#how-does-requestanimationframe-differ-from-setinterval-and-settimeoutsection"><span class="toc-number">2.12.</span> <span class="toc-text"> How does requestAnimationFrame() differ from setInterval() and setTimeout()?Section</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#including-a-timestampsection"><span class="toc-number">2.13.</span> <span class="toc-text"> Including a timestampSection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#browser-supportsection"><span class="toc-number">2.14.</span> <span class="toc-text"> Browser supportSection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#a-simple-examplesection"><span class="toc-number">2.15.</span> <span class="toc-text"> A simple exampleSection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clearing-a-requestanimationframe-callsection"><span class="toc-number">2.16.</span> <span class="toc-text"> Clearing a requestAnimationFrame() callSection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#active-learning-starting-and-stopping-our-spinnersection"><span class="toc-number">2.17.</span> <span class="toc-text"> Active learning: Starting and stopping our spinnerSection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#throttling-a-requestanimationframe-animationsection"><span class="toc-number">2.18.</span> <span class="toc-text"> Throttling a requestAnimationFrame() animationSection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#active-learning-a-reaction-game"><span class="toc-number">2.19.</span> <span class="toc-text"> Active learning: a reaction game</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#promises"><span class="toc-number">3.</span> <span class="toc-text"> Promises</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#what-are-promises"><span class="toc-number">3.1.</span> <span class="toc-text"> What are promises?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-trouble-with-callbacks"><span class="toc-number">3.2.</span> <span class="toc-text"> The trouble with callbacks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#promises-versus-callbacks"><span class="toc-number">3.3.</span> <span class="toc-text"> Promises versus callbacks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#a-real-example"><span class="toc-number">3.4.</span> <span class="toc-text"> A real example</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-nature-of-asynchronous-code"><span class="toc-number">3.5.</span> <span class="toc-text"> The nature of asynchronous code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#running-code-in-response-to-multiple-promises-fulfilling"><span class="toc-number">3.6.</span> <span class="toc-text"> Running code in response to multiple promises fulfilling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#running-some-final-code-after-a-promise-fulfillsrejects"><span class="toc-number">3.7.</span> <span class="toc-text"> Running some final code after a promise fulfills&#x2F;rejects</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#using-the-promise-constructor"><span class="toc-number">3.8.</span> <span class="toc-text"> Using the Promise() constructor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#a-more-real-world-example"><span class="toc-number">3.9.</span> <span class="toc-text"> A more real-world example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#asyncawait"><span class="toc-number">4.</span> <span class="toc-text"> Async&#x2F;await</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#the-async-keyword"><span class="toc-number">4.1.</span> <span class="toc-text"> The async keyword</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-await-keyword"><span class="toc-number">4.2.</span> <span class="toc-text"> The await keyword</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewriting-promise-code-with-asyncawait"><span class="toc-number">4.3.</span> <span class="toc-text"> Rewriting promise code with async&#x2F;await</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#adding-error-handling"><span class="toc-number">4.4.</span> <span class="toc-text"> Adding error handling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#awaiting-a-promiseall"><span class="toc-number">4.5.</span> <span class="toc-text"> Awaiting a Promise.all()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#the-downsides-of-asyncawait"><span class="toc-number">4.6.</span> <span class="toc-text"> The downsides of async&#x2F;await</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#asyncawait-class-methods"><span class="toc-number">4.7.</span> <span class="toc-text"> Async&#x2F;await class methods</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#asynchronous"><span class="toc-number">5.</span> <span class="toc-text"> Asynchronous</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#asynchronous-callbacks"><span class="toc-number">5.1.</span> <span class="toc-text"> Asynchronous callbacks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#settimeout-2"><span class="toc-number">5.2.</span> <span class="toc-text"> setTimeout()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setinterval-2"><span class="toc-number">5.3.</span> <span class="toc-text"> setInterval()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#requestanimationframe-2"><span class="toc-number">5.4.</span> <span class="toc-text"> requestAnimationFrame()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#promises-2"><span class="toc-number">5.5.</span> <span class="toc-text"> Promises</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#promiseall"><span class="toc-number">5.6.</span> <span class="toc-text"> Promise.all()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#asyncawait-2"><span class="toc-number">5.7.</span> <span class="toc-text"> Async&#x2F;await</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#references"><span class="toc-number">6.</span> <span class="toc-text"> REFERENCES</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/Lang/es/duo_es/" title="No title"><img src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_seeds.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/Lang/es/duo_es/" title="No title">No title</a><time datetime="2020-06-29T03:44:49.224Z" title="Created 2020-06-29 11:44:49">2020-06-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Lang/kl/duo_kl001_intro/" title="Klingon- Vol.1 - Introduction"><img src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_little_girl_phone.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Klingon- Vol.1 - Introduction"/></a><div class="content"><a class="title" href="/Lang/kl/duo_kl001_intro/" title="Klingon- Vol.1 - Introduction">Klingon- Vol.1 - Introduction</a><time datetime="2020-06-26T16:00:00.000Z" title="Created 2020-06-27 00:00:00">2020-06-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Life/apps/life_apps_android_list/" title="安卓 | 装机必备清单及习惯步骤"><img src="https://i.postimg.cc/KYPmhV8w/android-new-logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="安卓 | 装机必备清单及习惯步骤"/></a><div class="content"><a class="title" href="/Life/apps/life_apps_android_list/" title="安卓 | 装机必备清单及习惯步骤">安卓 | 装机必备清单及习惯步骤</a><time datetime="2020-06-20T04:29:10.462Z" title="Created 2020-06-20 12:29:10">2020-06-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Pysnista/Intro/files/py_pillow/" title="Python - 操作图像"><img src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_little_girl_phone.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python - 操作图像"/></a><div class="content"><a class="title" href="/Pysnista/Intro/files/py_pillow/" title="Python - 操作图像">Python - 操作图像</a><time datetime="2020-05-02T16:00:00.000Z" title="Created 2020-05-03 00:00:00">2020-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Pysnista/Intro/files/py_files_pdf_word/" title="Python - PDF &amp; Word"><img src="https://i.loli.net/2020/07/09/6ALoRXnITgcuvy2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python - PDF &amp; Word"/></a><div class="content"><a class="title" href="/Pysnista/Intro/files/py_files_pdf_word/" title="Python - PDF &amp; Word">Python - PDF &amp; Word</a><time datetime="2020-04-12T16:00:00.000Z" title="Created 2020-04-13 00:00:00">2020-04-13</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_books3.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Joaxin</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Refine, the Life</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="Increase font size"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="Decrease font size"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="fasle"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/fae45343.js","daovoice")
</script><script>var isChatBtn = true
daovoice('init', {
  app_id: 'fae45343',},{
  launcher: { 
     disableLauncherIcon: isChatBtn // 悬浮 ICON 是否显示
  },
});
daovoice('update');

if (isChatBtn) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      daovoice('show')
    });
  }
  chatBtnFn()
} else {
  if (true) {
    function chatBtnHide () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: true // 悬浮 ICON 是否显示
        },
      });
    }
    function chatBtnShow () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: false // 悬浮 ICON 是否显示
        },
      });
    }
  }
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>