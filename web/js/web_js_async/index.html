<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>JS asynchronous programming - Promise Async Await | Pinsflora</title><meta name="keywords" content="Javascript"><meta name="author" content="Joaxin"><meta name="copyright" content="Joaxin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Important concepts relating to asynchronous programming.">
<meta property="og:type" content="article">
<meta property="og:title" content="JS asynchronous programming - Promise Async Await">
<meta property="og:url" content="https://u.pinsflora.xyz/Web/js/web_js_async/index.html">
<meta property="og:site_name" content="Pinsflora">
<meta property="og:description" content="Important concepts relating to asynchronous programming.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_sea_stairs.jpg">
<meta property="article:published_time" content="2017-12-20T16:00:00.000Z">
<meta property="article:modified_time" content="2019-08-31T16:00:00.000Z">
<meta property="article:author" content="Joaxin">
<meta property="article:tag" content="Javascript">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_sea_stairs.jpg"><link rel="shortcut icon" href="/img/favicon-32x32.png"><link rel="canonical" href="https://u.pinsflora.xyz/Web/js/web_js_async/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-177831205-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-177831205-1');
</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2019-09-01 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}const fontSizeVal = saveToLocal.get('global-font-size')
if (fontSizeVal !== undefined) {
  document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
}})()</script><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="Pinsflora" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://avatars2.githubusercontent.com/u/8346164?s=460&amp;v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">333</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">110</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">34</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-file-image-o"></i><span> Galleries</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> Games</span></a></li><li><a class="site-page" href="/tools/"><i class="fa-fw fas fa-wrench"></i><span> Tools</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_sea_stairs.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Pinsflora</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-file-image-o"></i><span> Galleries</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-film"></i><span> Movie</span></a></li><li><a class="site-page" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> Games</span></a></li><li><a class="site-page" href="/tools/"><i class="fa-fw fas fa-wrench"></i><span> Tools</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">JS asynchronous programming - Promise Async Await</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2017-12-20T16:00:00.000Z" title="Created 2017-12-21 00:00:00">2017-12-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2019-08-31T16:00:00.000Z" title="Updated 2019-09-01 00:00:00">2019-09-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/">Web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/JS/">JS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">14.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>90min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="concepts"><a class="markdownIt-Anchor" href="#concepts"></a> Concepts</h2>
<p>Normally, a given program’s code runs straight along, with only one thing happening at once. If a function relies on the result of another function, it has to wait for the other function to finish and return, and until that happens, the entire program is essentially stopped from the perspective of the user.</p>
<h3 id="blocking-code"><a class="markdownIt-Anchor" href="#blocking-code"></a> Blocking code</h3>
<p>Asynchronous techniques are very useful, particularly in web programming. When a web app runs in a browser and it executes an intensive chunk of code without returning control to the browser, the browser can appear to be frozen. This is called <strong>blocking</strong>; the browser is blocked from continuing to handle user input and perform other tasks until the web app returns control of the processor.</p>
<p>In this example, we simulate something slightly more realistic that you might come across on a real page. We block user interactivity with rendering of the UI. In this example, we have two buttons:</p>
<ul>
<li>A “Fill canvas” button that when clicked fills the available <code>canvas</code> with 1 million blue circles.</li>
<li>A “Click me for alert” button that when clicked shows an alert message.</li>
</ul>
<p><a href="web/js/async/intro/web_js_async_test.html" target="_blank">See Live Here</a></p>
<p>If you click the first button and then quickly click the second one, you’ll see that the alert does not appear until the circles have finished being rendered. The first operation blocks the second one until it has finished running.</p>
<p>Why is this? The answer is because JavaScript, generally speaking, is <strong>single threaded</strong>. At this point we need to introduce the concept of <strong>threads</strong>.</p>
<h3 id="threads"><a class="markdownIt-Anchor" href="#threads"></a> Threads</h3>
<p>A <strong>thread</strong> is basically a single process that a program can use to complete tasks. Each thread can only do a single task at once:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Task A --&gt; Task B --&gt; Task C</span><br></pre></td></tr></tbody></table></figure>
<p>Each task will be run sequentially; a task has to complete before the next one can be started.</p>
<p>As we said earlier, many computers now have multiple cores, so can do multiple things at once. Programming languages that can support multiple threads can use multiple cores to complete multiple tasks simultaneously:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thread 1: Task A --&gt; Task B</span><br><span class="line">Thread 2: Task C --&gt; Task D</span><br></pre></td></tr></tbody></table></figure>
<h3 id="javascript-is-single-threaded"><a class="markdownIt-Anchor" href="#javascript-is-single-threaded"></a> JavaScript is single threaded</h3>
<p>JavaScript is traditionally single-threaded. Even with multiple cores, you could only get it to run tasks on a single thread, called the <strong>main thread</strong>. Our example from above is run like this:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Main thread: Render circles to canvas --&gt; Display alert()</span><br></pre></td></tr></tbody></table></figure>
<p>After some time, JavaScript gained some tools to help with such problems. <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API">Web workers</a> allow you to send some of the JavaScript processing off to a separate thread, called a worker, so that you can run multiple JavaScript chunks simultaneously. You’d generally use a worker to run expensive processes off the main thread so that user interaction is not blocked.</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Main thread: Task A --&gt; Task C</span><br><span class="line">Worker thread: Expensive task B</span><br></pre></td></tr></tbody></table></figure>
<p>With this in mind, have a look at <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/introducing/simple-sync-worker.html">simple-sync-worker.html</a> (<a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/introducing/simple-sync-worker.html">see it running live</a>), again with your browser’s JavaScript console open. This is a rewrite of our previous example that calculates the 10 million dates in a separate worker thread. Now when you click the button, the browser is able to display the paragraph before the dates have finished calculating. The first operation no longer blocks the second.</p>
<h3 id="asynchronous-code"><a class="markdownIt-Anchor" href="#asynchronous-code"></a> Asynchronous code</h3>
<p>Web workers are pretty useful, but they do have their limitations. A major one is they are not able to access the DOM — you can’t get a worker to directly do anything to update the UI. We couldn’t render our 1 million blue circles inside our worker; it can basically just do number crunching.</p>
<p>The second problem is that although code run in a worker is not blocking, it is still basically synchronous. This becomes a problem when a function relies on the results of multiple previous processes to function. Consider the following thread diagrams:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Main thread: Task A --&gt; Task B</span><br></pre></td></tr></tbody></table></figure>
<p>In this case, let’s say Task A is doing something like fetching an image from the server and Task B then does something to the image like applying a filter to it. If you start Task A running and then immediately try to run Task B, you’ll get an error, because the image won’t be available yet.</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Main thread: Task A --&gt; Task B --&gt; |Task D|</span><br><span class="line">Worker thread: Task C -----------&gt; |      |</span><br></pre></td></tr></tbody></table></figure>
<p>In this case, let’s say Task D makes use of the results of both Task B and Task C. If we can guarantee that these results will both be available at the same time, then we might be OK, but this is unlikely. If Task D tries to run when one of its inputs is not yet available, it will throw an error.</p>
<p>To fix such problems, browsers allow us to run certain operations asynchronously. Features like <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promises</a> allow you to set an operation running (e.g. the fetching of an image from the server), and then wait until the result has returned before running another operation:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Main thread: Task A                   Task B</span><br><span class="line">    Promise:      |__async operation__|</span><br></pre></td></tr></tbody></table></figure>
<p>Since the operation is happening somewhere else, the main thread is not blocked while the async operation is being processed.</p>
<p>We’ll start to look at how we can write asynchronous code in the next article. Exciting stuff, huh? Keep reading!</p>
<h3 id="synchronous-javascript"><a class="markdownIt-Anchor" href="#synchronous-javascript"></a> Synchronous JavaScript</h3>
<p>Let’s look at a simple synchronous example (<a href="web/js/async/intro/web_js_async_intro_basic_example.html" target="_blank">See Live Here</a>).</p>
<p>While each operation is being processed, nothing else can happen — rendering is paused. This is because only one thing can happen at a time, on a single main thread, and everything else is blocked until an operation completes.</p>
<p>So in the example above, after you’ve clicked the button the paragraph won’t appear until after the OK button is pressed in the alert box. You can try it for yourself:</p>
<blockquote>
<p><strong>Note</strong>: It is important to remember that <code>alert()</code>, while being very useful for demonstrating a synchronous blocking operation, but it is terrible for use in real world applications.</p>
</blockquote>
<h3 id="asynchronous-javascript"><a class="markdownIt-Anchor" href="#asynchronous-javascript"></a> Asynchronous JavaScript</h3>
<p>For reasons illustrated earlier (e.g. related to blocking), many Web API features now use asynchronous code to run, especially those that access or fetch some kind of resource from an external device, such as fetching a file from the network, accessing a database and returning data from it, accessing a video stream from a webcam, or broadcasting the display to a VR headset.</p>
<p>Why is this difficult to get to work using synchronous code? Let’s look at a quick example. When you fetch an image from a server, you can’t return the result immediately. That means that the following (pseudocode) wouldn’t work:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> response = fetch(<span class="string">'myImage.png'</span>);</span><br><span class="line"><span class="keyword">let</span> blob = response.blob();</span><br><span class="line"><span class="comment">// display your image blob in the UI somehow</span></span><br></pre></td></tr></tbody></table></figure>
<p>That’s because you don’t know how long the image will take to download, so when you come to run the second line it will throw an error (possibly intermittently, possibly every time) because the <code>response</code> is not yet available. Instead, you need your code to wait until the <code>response</code> is returned before it tries to do anything else to it.</p>
<h3 id="async-callbacks"><a class="markdownIt-Anchor" href="#async-callbacks"></a> Async callbacks</h3>
<p>Async callbacks are functions that are specified as arguments when calling a function which will start executing code in the background. When the background code finishes running, it calls the callback function to let you know the work is done, or to let you know that something of interest has happened. Using callbacks is slightly old-fashioned now, but you’ll still see them in use in a number of older-but-still-commonly-used APIs.</p>
<p>An example of an async callback is the second parameter of the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener"><code>addEventListener()</code></a> method (as we saw in action above):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">btn.addEventListener(<span class="string">'click'</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  alert(<span class="string">'You clicked me!'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> pElem = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>);</span><br><span class="line">  pElem.textContent = <span class="string">'This is a newly-added paragraph.'</span>;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(pElem);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>The first parameter is the type of event to be listened for, and the second parameter is a callback function that is invoked when the event is fired.</p>
<p>When we pass a callback function as an argument to another function, we are only passing the function’s reference as an argument, i.e, the callback function is <strong>not</strong> executed immediately. It is “called back” (hence the name) asynchronously somewhere inside the containing function’s body. The containing function is responsible for executing the callback function when the time comes.</p>
<p>You can write your own function containing a callback easily enough. Let’s look at another example that loads a resource via the <code>XMLHttpRequest</code> API :</p>
<p><a href="web/js/async/intro/web_js_async_xhr-async-callback.html" target="_blank">See The Page Here</a></p>
<blockquote>
<p><strong>Note</strong>: For security reasons, you can’t <code>fetch()</code> files from your local filesystem (or run other such operations locally); to run the above example locally you’ll have to run the example through a local webserver.</p>
<p>Access to XMLHttpRequest at ‘…coffee.jpg’ from origin ‘null’ has been blocked by CORS policy: Cross origin requests are only supported for protocol schemes: http, data, chrome, chrome-extension, chrome-untrusted, https.<br>
coffee.jpg:1 Failed to load resource: net::ERR_FAILED</p>
</blockquote>
<p>Callbacks are versatile — not only do they allow you to control the order in which functions are run and what data is passed between them, they also allow you to pass data to different functions depending on circumstance. So you could have different actions to run on the response downloaded, such as <code>processJSON()</code>, <code>displayText()</code>, etc.</p>
<h2 id="introduction"><a class="markdownIt-Anchor" href="#introduction"></a> Introduction</h2>
<p>For a long time, the web platform has made available to JavaScript programmers a number of functions that allow you to asynchronously execute code after a certain time interval has elapsed, and to repeatedly execute a block of code asynchronously until you tell it to stop. These are:</p>
<ul>
<li>
<p><code>setTimeout()</code></p>
<p>Execute a specified block of code once after a specified time has elapsed.</p>
</li>
<li>
<p><code>setInterval()</code></p>
<p>Execute a specified block of code repeatedly with a fixed time delay between each call.</p>
</li>
<li>
<p><code>requestAnimationFrame()</code></p>
<p>The modern version of <code>setInterval()</code>; executes a specified block of code before the browser next repaints the display, allowing an animation to be run at a suitable framerate regardless of the environment it is being run in.</p>
</li>
</ul>
<p>The asynchronous code set up by these functions actually runs on the main thread, but you are able to run other code between iterations to a more or less efficient degree, depending on how processor intensive these operations are. In any case, these functions are used for running constant animations and other background processing on a web site or application. In the following sections we will show you how they can be used.</p>
<h3 id="settimeout"><a class="markdownIt-Anchor" href="#settimeout"></a> setTimeout()</h3>
<p>As we said before, <code>setTimeout()</code> executes a particular block of code once after a specified time has elapsed. It takes the following parameters:</p>
<ul>
<li>A function to run, or a reference to function defined elsewhere.</li>
<li>A number representing the time interval in milliseconds (so 1000 equals one second) to wait before executing the code. If you specify a value of 0 (or omit this value altogether), the function will run immediately. More on why you might want to do this later.</li>
<li>Zero or more values that represent any parameters you want to pass to the function when it is run.</li>
</ul>
<p><strong>Note:</strong> Because timeout callbacks are executed cooperatively, there’s no guarantee that they will be called after <em>exactly</em> the specified amount of time. Instead, they will be called after <em>at least</em> that much time has elapsed. Timeout handlers can’t be run until the main thread reaches the point in its execution where it goes through these handlers to find the ones that need to be run.</p>
<p>In the following example, the browser will wait two seconds before executing the anonymous function, then will display the alert message (<a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/simple-settimeout.html">see it running live</a>, and <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/simple-settimeout.html">see the source code</a>):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myGreeting = <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">  alert(<span class="string">'Hello, Mr. Universe!'</span>);</span><br><span class="line">}, <span class="number">2000</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>The functions we specify don’t have to be anonymous. We can give our function a name, and can even define it somewhere else and pass a function reference to the <code>setTimeout()</code>. The following two versions of our code snippet are equivalent to the first one:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// With a named function</span></span><br><span class="line"><span class="keyword">let</span> myGreeting = <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> <span class="title">sayHi</span>(<span class="params"></span>) </span>{</span><br><span class="line">  alert(<span class="string">'Hello, Mr. Universe!'</span>);</span><br><span class="line">}, <span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// With a function defined separately</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHi</span>(<span class="params"></span>) </span>{</span><br><span class="line">  alert(<span class="string">'Hello Mr. Universe!'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myGreeting = <span class="built_in">setTimeout</span>(sayHi, <span class="number">2000</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>That can be useful if we have a function that needs to be called both from a timeout and in response to an event, for example. But it can also just help keep your code tidy, especially if the timeout callback is more than a few lines of code.</p>
<p><code>setTimeout()</code> returns an identifier value that can be used to refer to the timeout later, such as when you want to stop it. See <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Clearing_timeouts">Clearing timeouts</a> below to learn how to do that.</p>
<h3 id="passing-parameters-to-a-settimeout-functionsection"><a class="markdownIt-Anchor" href="#passing-parameters-to-a-settimeout-functionsection"></a> Passing parameters to a setTimeout() function<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Passing_parameters_to_a_setTimeout()_function">Section</a></h3>
<p>Any parameters that we want to pass to the function being run inside the <code>setTimeout()</code> have to be passed to it as additional parameters at the end of the list. For example, we could refactor our previous function so that it will say hi to whatever person’s name is passed to it:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHi</span>(<span class="params">who</span>) </span>{</span><br><span class="line">  alert(<span class="string">'Hello '</span> + who + <span class="string">'!'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The name of the person to say hello to can then be passed into the <code>setTimeout()</code> call as a third parameter:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myGreeting = <span class="built_in">setTimeout</span>(sayHi, <span class="number">2000</span>, <span class="string">'Mr. Universe'</span>);</span><br></pre></td></tr></tbody></table></figure>
<h3 id="clearing-timeoutssection"><a class="markdownIt-Anchor" href="#clearing-timeoutssection"></a> Clearing timeouts<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Clearing_timeouts">Section</a></h3>
<p>Finally, if a timeout has been created, you can cancel it before the specified time has elapsed by calling <code>clearTimeout()</code>, passing it the identifier of the <code>setTimeout()</code> call as a parameter. So to cancel our above timeout, you’d do this:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">clearTimeout</span>(myGreeting);</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Note</strong>: See <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/greeter-app.html">greeter-app.html</a> for a slightly more involved demo that allows you to set the name of the person to say hello to in a form, and cancel the greeting using a separate button (<a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/greeter-app.html">see the source code also</a>).</p>
<h3 id="setinterval"><a class="markdownIt-Anchor" href="#setinterval"></a> setInterval()</h3>
<p><code>setTimeout()</code> works perfectly when we need to run the code once after a set period of time. But what happens when we need to run the code over and over again, for example in the case of an animation?</p>
<p>This is where <code>setInterval()</code> comes in. This works in a very similar way to <code>setTimeout()</code>, except that the function you pass to it as the first parameter is executed repeatedly at no less than the number of milliseconds given by the second parameter apart, rather than at once. You can also pass any parameters required by the function being executed in as subsequent parameters of the <code>setInterval()</code> call.</p>
<p>Let’s look at an example. The following function creates a new <code>Date()</code> object, extracts a time string out of it using <code>toLocaleTimeString()</code>, and then displays it in the UI. We then run the function once per second using <code>setInterval()</code>, creating the effect of a digital clock that updates once per second (<a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/setinterval-clock.html">see this live</a>, and also <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/setinterval-clock.html">see the source</a>):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">displayTime</span>(<span class="params"></span>) </span>{</span><br><span class="line">   <span class="keyword">let</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">   <span class="keyword">let</span> time = date.toLocaleTimeString();</span><br><span class="line">   <span class="built_in">document</span>.getElementById(<span class="string">'demo'</span>).textContent = time;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createClock = <span class="built_in">setInterval</span>(displayTime, <span class="number">1000</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Just like <code>setTimeout()</code>, <code>setInterval()</code> returns an identifying value you can use later when you need to clear the interval.</p>
<h3 id="clearing-intervalssection"><a class="markdownIt-Anchor" href="#clearing-intervalssection"></a> Clearing intervals<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Clearing_intervals">Section</a></h3>
<p><code>setInterval()</code> keeps running a task forever, unless we do something about it — we may well want a way to stop such tasks, otherwise we may end up getting errors when the browser can’t complete any further versions of the task, or if the animation being handled by the task has finished. We can do this in the same sort of way as we stopped timeouts — by passing the identifier returned by the <code>setInterval()</code> call to the <code>clearInterval()</code> function:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myInterval = <span class="built_in">setInterval</span>(myFunction, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">clearInterval</span>(myInterval);</span><br></pre></td></tr></tbody></table></figure>
<h4 id="active-learning-creating-your-own-stopwatch"><a class="markdownIt-Anchor" href="#active-learning-creating-your-own-stopwatch"></a> Active learning: Creating your own stopwatch!</h4>
<p>With this all said, we’ve got a challenge for you. Take a copy of our <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/setinterval-clock.html">setInterval-clock.html</a>example, and modify it to create your own simple stopwatch.</p>
<p>You need to display a time as before, but in this example, you need:</p>
<ul>
<li>A “Start” button to start the stopwatch running.</li>
<li>A “Stop” button to pause/stop it.</li>
<li>A “Reset” button to reset the time back to 0.</li>
<li>The time display to show the number of seconds elapsed, rather than the actual time.</li>
</ul>
<p>Here’s a few hints for you:</p>
<ul>
<li>You can structure and style the button markup however you like; just make sure you use semantic HTML, with hooks to allow you to grab the button references using JavaScript.</li>
<li>You probably want to create a variable that starts at 0, then increments by one every second using a constant loop.</li>
<li>It is easier to create this example without using a <code>Date()</code> object, like we’ve done in our version, but less accurate — you can’t guarantee that the callback will fire after exactly 1000ms. A more accurate way would be to run <code>startTime = Date.now()</code> to get a timestamp of exactly when the user clicked the start button, and then do <code>Date.now() - startTime</code> to get the number of milliseconds after the start button was clicked.</li>
<li>You also want to calculate the number of hours, minutes, and seconds as separate values, and then show them together in a string after each loop iteration. From the second counter, you can work out each of these.</li>
<li>How would you calculate them? Have a think about it:
<ul>
<li>The number of seconds in an hour is 3600.</li>
<li>The number of minutes will be the amount of seconds left over when all of the hours have been removed, divided by 60.</li>
<li>The number of seconds will be the amount of seconds left over when all of the minutes have been removed.</li>
</ul>
</li>
<li>You’ll want to include a leading zero on your display values if the amount is less than 10, so it looks more like a traditional clock/watch.</li>
<li>To pause the stopwatch, you’ll want to clear the interval. To reset it, you’ll want to set the counter back to 0 and then immediately update the display.</li>
<li>You probably ought to disable the start button after pressing it once, and enable it again after you’ve stopped it. Otherwise multiple presses of the start button will apply multiple <code>setInterval()</code>s to the clock, leading to wrong behavior.</li>
</ul>
<p><strong>Note</strong>: If you get stuck, you can <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/asynchronous/loops-and-intervals/setinterval-stopwatch.html">find our version here</a> (see the <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/asynchronous/loops-and-intervals/setinterval-stopwatch.html">source code</a> also).</p>
<h3 id="things-to-keep-in-mind-about-settimeout-and-setinterval"><a class="markdownIt-Anchor" href="#things-to-keep-in-mind-about-settimeout-and-setinterval"></a> Things to keep in mind about setTimeout() and setInterval()</h3>
<p>There are a few things to keep in mind when working with <code>setTimeout()</code> and <code>setInterval()</code>. Let’s review these now.</p>
<h3 id="recursive-timeoutssection"><a class="markdownIt-Anchor" href="#recursive-timeoutssection"></a> Recursive timeouts<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Asynchronous/Timeouts_and_intervals#Recursive_timeouts">Section</a></h3>
<p>There is another way we can use <code>setTimeout()</code>: We can call it recursively to run the same code repeatedly, instead of using <code>setInterval()</code>.</p>
<p>The below example uses a recursive <code>setTimeout()</code> to run the passed function every 100 milliseconds:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(i);</span><br><span class="line">  i++;</span><br><span class="line">  <span class="built_in">setTimeout</span>(run, <span class="number">100</span>);</span><br><span class="line">}, <span class="number">100</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Compare the above example to the following one — this uses <code>setInterval()</code> to accomplish the same effect:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(i);</span><br><span class="line">  i++</span><br><span class="line">}, <span class="number">100</span>);</span><br></pre></td></tr></tbody></table></figure>
<h4 id="how-do-recursive-settimeout-and-setinterval-differ"><a class="m