<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>HTML5 Web Storage | Pinsflora</title><meta name="author" content="Joaxin"><meta name="copyright" content="Joaxin"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Note: This section must invovled in some JS prerequistes for better understanding.  Most major modern web sites are dynamic — they store data on the server using some kind of database (server-side st">
<meta property="og:type" content="article">
<meta property="og:title" content="HTML5 Web Storage">
<meta property="og:url" content="https://u.pinsflora.xyz/Web/html/web_html_storage/index.html">
<meta property="og:site_name" content="Pinsflora">
<meta property="og:description" content="Note: This section must invovled in some JS prerequistes for better understanding.  Most major modern web sites are dynamic — they store data on the server using some kind of database (server-side st">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_sea_stairs.jpg">
<meta property="article:published_time" content="2017-11-01T16:00:00.000Z">
<meta property="article:modified_time" content="2018-05-20T16:00:00.000Z">
<meta property="article:author" content="Joaxin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_sea_stairs.jpg"><link rel="shortcut icon" href="/img/favicon-32x32.png"><link rel="canonical" href="https://u.pinsflora.xyz/Web/html/web_html_storage/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-177831205-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-177831205-1');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":600,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2018-05-21 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="Pinsflora" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://avatars2.githubusercontent.com/u/8346164?s=460&amp;v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">340</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">110</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">34</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Galleries"><i class="fa-fw /gallery/"></i><span> 0</span></a></li><li><a class="site-page child" href="/Movie"><i class="fa-fw /movies/"></i><span> 1</span></a></li><li><a class="site-page child" href="/Games"><i class="fa-fw /games/"></i><span> 2</span></a></li><li><a class="site-page child" href="/Tools"><i class="fa-fw /tools/"></i><span> 3</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_sea_stairs.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Pinsflora</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Galleries"><i class="fa-fw /gallery/"></i><span> 0</span></a></li><li><a class="site-page child" href="/Movie"><i class="fa-fw /movies/"></i><span> 1</span></a></li><li><a class="site-page child" href="/Games"><i class="fa-fw /games/"></i><span> 2</span></a></li><li><a class="site-page child" href="/Tools"><i class="fa-fw /tools/"></i><span> 3</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">HTML5 Web Storage</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2017-11-01T16:00:00.000Z" title="Created 2017-11-02 00:00:00">2017-11-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2018-05-20T16:00:00.000Z" title="Updated 2018-05-21 00:00:00">2018-05-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/">Web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/HTML/">HTML</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">5.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>36min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="HTML5 Web Storage"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p><strong>Note</strong>: This section must invovled in some <strong>JS</strong> prerequistes for better understanding.</p>
</blockquote>
<p>Most major modern web sites are dynamic — they store data on the server using some kind of database (server-side storage), then run Server-side code to retrieve needed data, insert it into static page templates, and serve the resulting HTML to the client to be displayed by the user’s browser.</p>
<p>Client-side storage works on similar principles, but has different uses. It consists of JavaScript APIs that allow you to store data on the client (i.e. on the user’s machine) and then retrieve it when needed. This has many distinct uses, such as:</p>
<ul>
<li>Personalizing site preferences (e.g. showing a user’s choice of custom widgets, color scheme, or font size).</li>
<li>Persisting previous site activity (e.g. storing the contents of a shopping cart from a previous session, remembering if a user was previously logged in).</li>
<li>Saving data and assets locally so a site will be quicker (and potentially less expensive) to download, or be usable without a network connection.</li>
<li>Saving web application generated documents locally for use offline</li>
</ul>
<h1 id="web-storage"><a class="markdownIt-Anchor" href="#web-storage"></a> Web Storage</h1>
<p>The Web Storage API provides a very simple syntax for storing and retrieving smaller, data items consisting of a name and a corresponding value. This is useful when you just need to store some simple data, like the user’s name, whether they are logged in, what color to use for the background of the screen, etc.</p>
<p>The Web Storage API is very easy to use — you store simple name/value pairs of data (limited to strings, numbers, etc.) and retrieve these values when needed.</p>
<p>There are two types of web storage objects:</p>
<ul>
<li>sessionStorage()</li>
<li>localStorage()</li>
</ul>
<h2 id="sessionstorage"><a class="markdownIt-Anchor" href="#sessionstorage"></a> SessionStorage</h2>
<h2 id="localstorage"><a class="markdownIt-Anchor" href="#localstorage"></a> localStorage</h2>
<p>All of your web storage data is contained within two object-like structures inside the browser:  The first one persists data for as long as the browser is open (the data is lost when the browser is closed) and the second one persists data even after the browser is closed and then opened again. We’ll use the second one in this article as it is generally more useful.</p>
<p>The <code>Storage.setItem()</code> method allows you to save a data item in storage — it takes two parameters: the name of the item, and its value.</p>
<p>The <code>Storage.getItem()</code> method takes one parameter — the name of a data item you want to retrieve — and returns the item’s value.</p>
<p>The <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Storage/removeItem"><code>Storage.removeItem()</code></a> method takes one parameter — the name of a data item you want to remove — and removes that item out of web storage. Type the following lines into your JavaScript console:</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store</span></span><br><span class="line"><span class="built_in">localStorage</span>.setItem(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br><span class="line"><span class="built_in">localStorage</span>.key1 = <span class="string">'value1'</span>;</span><br><span class="line"><span class="built_in">localStorage</span>[<span class="string">'key1'</span>] = <span class="string">'value1'</span>;</span><br><span class="line"><span class="comment">// getting</span></span><br><span class="line">alert(<span class="built_in">localStorage</span>.getItem(<span class="string">"key1"</span>)); </span><br><span class="line"><span class="comment">// remove a value</span></span><br><span class="line"><span class="built_in">localStorage</span>.removeItem(<span class="string">"key1"</span>);</span><br><span class="line"><span class="comment">// remove all vars --&gt; null</span></span><br><span class="line"><span class="built_in">localStorage</span>.clear();</span><br></pre></td></tr></tbody></table></figure>
<p>Adding a personalized welcome message, here we will add a welcome message when the user first navigates to the site. This welcome message will persist, should the user leave the site and later return — we will save it using the Web Storage API. We will also include an option to change the user and, therefore, the welcome message anytime it is required.</p>
<p><a href="/web/html/stroage/html5_storage.html" target="_blank">Preview Local Storage Here</a></p>
<p><strong>Note</strong>: In the line <code>&lt;script src="index.js" defer&gt;&lt;/script&gt;</code> of the source for our finished version, the <code>defer</code> attribute specifies that the contents of the script element will not execute until the page has finished loading.</p>
<h1 id="indexeddb"><a class="markdownIt-Anchor" href="#indexeddb"></a> IndexedDB</h1>
<p>The IndexedDB API (sometimes abbreviated IDB) is a complete database system available in the browser in which you can store complex related data, the types of which aren’t limited to simple values like strings or numbers. You can store videos, images, and pretty much anything else in an IndexedDB instance.</p>
<p>However, this does come at a cost: IndexedDB is much more complex to use than the Web Storage API. In this section, we’ll really only scratch the surface of what it is capable of, but we will give you enough to get started.</p>
<p>The IndexedDB API provides the browser with a complete database system for storing complex data. This can be used for things from complete sets of customer records to even complex data types like audio or video files.</p>
<h2 id="set-up-a-database"><a class="markdownIt-Anchor" href="#set-up-a-database"></a> Set up a database</h2>
<p>Now let’s look at what we have to do in the first place, to actually set up a database.</p>
<ol>
<li>
<p>Below the constant declarations, add the following lines:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create an instance of a db object for us to store the open database in</span></span><br><span class="line"><span class="keyword">let</span> db;</span><br></pre></td></tr></tbody></table></figure>
<p>Here we are declaring a variable called <code>db</code> — this will later be used to store an object representing our database. We will use this in a few places, so we’ve declared it globally here to make things easier.</p>
</li>
<li>
<p>Next, add the following to the bottom of your code:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line"></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>We will write all of our subsequent code inside this <code>window.onload</code> event handler function, called when the window’s <code>load</code> event fires, to make sure we don’t try to use IndexedDB functionality before the app has completely finished loading (it could fail if we don’t).</p>
</li>
<li>
<p>Inside the <code>window.onload</code> handler, add the following:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Open our database; it is created if it doesn't already exist</span></span><br><span class="line"><span class="comment">// (see onupgradeneeded below)</span></span><br><span class="line"><span class="keyword">let</span> request = <span class="built_in">window</span>.indexedDB.open(<span class="string">'notes_db'</span>, <span class="number">1</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>This line creates a <code>request</code> to open version <code>1</code> of a database called <code>notes_db</code>. If this doesn’t already exist, it will be created for you by subsequent code. You will see this request pattern used very often throughout IndexedDB. Database operations take time. You don’t want to hang the browser while you wait for the results, so database operations are <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Glossary/asynchronous">asynchronous</a>, meaning that instead of happening immediately, they will happen at some point in the future, and you get notified when they’re done.</p>
<p>To handle this in IndexedDB, you create a request object (which can be called anything you like — we called it <code>request</code> so it is obvious what it is for). You then use event handlers to run code when the request completes, fails, etc., which you’ll see in use below.</p>
<p><strong>Note</strong>: The version number is important. If you want to upgrade your database (for example, by changing the table structure), you have to run your code again with an increased version number, different schema specified inside the <code>onupgradeneeded</code>handler (see below), etc. We won’t cover upgrading databases in this simple tutorial.</p>
</li>
<li>
<p>Now add the following event handlers just below your previous addition — again inside the <code>window.onload</code> handler:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onerror handler signifies that the database didn't open successfully</span></span><br><span class="line">request.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Database failed to open'</span>);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// onsuccess handler signifies that the database opened successfully</span></span><br><span class="line">request.onsuccess = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Database opened successfully'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Store the opened database object in the db variable. This is used a lot below</span></span><br><span class="line">  db = request.result;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Run the displayData() function to display the notes already in the IDB</span></span><br><span class="line">  displayData();</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>The <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBRequest/onerror"><code>request.onerror</code></a> handler will run if the system comes back saying that the request failed. This allows you to respond to this problem. In our simple example, we just print a message to the JavaScript console.</p>
<p>The <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBRequest/onsuccess"><code>request.onsuccess</code></a> handler on the other hand will run if the request returns successfully, meaning the database was successfully opened. If this is the case, an object representing the opened database becomes available in the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBRequest/result"><code>request.result</code></a> property, allowing us to manipulate the database. We store this in the <code>db</code> variable we created earlier for later use. We also run a custom function called <code>displayData()</code>, which displays the data in the database inside the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/ul">``</a>. We run it now so that the notes already in the database are displayed as soon as the page loads. You’ll see this defined later on.</p>
</li>
<li>
<p>Finally for this section, we’ll add probably the most important event handler for setting up the database: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBOpenDBRequest/onupgradeneeded"><code>request.onupdateneeded</code></a>. This handler runs if the database has not already been set up, or if the database is opened with a bigger version number than the existing stored database (when performing an upgrade). Add the following code, below your previous handler:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Setup the database tables if this has not already been done</span></span><br><span class="line">request.onupgradeneeded = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>{</span><br><span class="line">  <span class="comment">// Grab a reference to the opened database</span></span><br><span class="line">  <span class="keyword">let</span> db = e.target.result;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create an objectStore to store our notes in (basically like a single table)</span></span><br><span class="line">  <span class="comment">// including a auto-incrementing key</span></span><br><span class="line">  <span class="keyword">let</span> objectStore = db.createObjectStore(<span class="string">'notes_os'</span>, { <span class="attr">keyPath</span>: <span class="string">'id'</span>, <span class="attr">autoIncrement</span>:<span class="literal">true</span> });</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define what data items the objectStore will contain</span></span><br><span class="line">  objectStore.createIndex(<span class="string">'title'</span>, <span class="string">'title'</span>, { <span class="attr">unique</span>: <span class="literal">false</span> });</span><br><span class="line">  objectStore.createIndex(<span class="string">'body'</span>, <span class="string">'body'</span>, { <span class="attr">unique</span>: <span class="literal">false</span> });</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Database setup complete'</span>);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>This is where we define the schema (structure) of our database; that is, the set of columns (or fields) it contains. Here we first grab a reference to the existing database from <code>e.target.result</code> (the event target’s <code>result</code> property), which is the <code>request</code>object. This is equivalent to the line <code>db = request.result;</code> inside the <code>onsuccess</code>handler, but we need to do this separately here because the <code>onupgradeneeded</code> handler (if needed) will run before the <code>onsuccess</code> handler, meaning that the <code>db</code> value wouldn’t be available if we didn’t do this.</p>
<p>We then use <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBDatabase/createObjectStore"><code>IDBDatabase.createObjectStore()</code></a> to create a new object store inside our opened database called <code>notes_os</code>. This is equivalent to a single table in a conventional database system. We’ve given it the name notes, and also specified an <code>autoIncrement</code> key field called <code>id</code> — in each new record this will automatically be given an incremented value — the developer doesn’t need to set this explicitly. Being the key, the <code>id</code> field will be used to uniquely identify records, such as when deleting or displaying a record.</p>
<p>We also create two other indexes (fields) using the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBObjectStore/createIndex"><code>IDBObjectStore.createIndex()</code></a>method: <code>title</code> (which will contain a title for each note), and <code>body</code> (which will contain the body text of the note).</p>
</li>
</ol>
<p>So with this simple database schema set up, when we start adding records to the database; each one will be represented as an object along these lines:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  title: <span class="string">"Buy milk"</span>,</span><br><span class="line">  body: <span class="string">"Need both cows milk and soya."</span>,</span><br><span class="line">  id: <span class="number">8</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="adding-data-to-the-database"><a class="markdownIt-Anchor" href="#adding-data-to-the-database"></a> Adding data to the database</h2>
<p>Now let’s look at how we can add records to the database. This will be done using the form on our page.</p>
<p>Below your previous event handler (but still inside the <code>window.onload</code> handler), add the following line, which sets up an <code>onsubmit</code> handler that runs a function called <code>addData()</code> when the form is submitted (when the submit <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/button">``</a> is pressed leading to a successful form submission):</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create an onsubmit handler so that when the form is submitted the addData() function is run</span></span><br><span class="line">form.onsubmit = addData;</span><br></pre></td></tr></tbody></table></figure>
<p>Now let’s define the <code>addData()</code> function. Add this below your previous line:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define the addData() function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addData</span>(<span class="params">e</span>) </span>{</span><br><span class="line">  <span class="comment">// prevent default - we don't want the form to submit in the conventional way</span></span><br><span class="line">  e.preventDefault();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// grab the values entered into the form fields and store them in an object ready for being inserted into the DB</span></span><br><span class="line">  <span class="keyword">let</span> newItem = { <span class="attr">title</span>: titleInput.value, <span class="attr">body</span>: bodyInput.value };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// open a read/write db transaction, ready for adding the data</span></span><br><span class="line">  <span class="keyword">let</span> transaction = db.transaction([<span class="string">'notes_os'</span>], <span class="string">'readwrite'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// call an object store that's already been added to the database</span></span><br><span class="line">  <span class="keyword">let</span> objectStore = transaction.objectStore(<span class="string">'notes_os'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make a request to add our newItem object to the object store</span></span><br><span class="line">  <span class="keyword">var</span> request = objectStore.add(newItem);</span><br><span class="line">  request.onsuccess = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="comment">// Clear the form, ready for adding the next entry</span></span><br><span class="line">    titleInput.value = <span class="string">''</span>;</span><br><span class="line">    bodyInput.value = <span class="string">''</span>;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Report on the success of the transaction completing, when everything is done</span></span><br><span class="line">  transaction.oncomplete = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Transaction completed: database modification finished.'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update the display of data to show the newly added item, by running displayData() again.</span></span><br><span class="line">    displayData();</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  transaction.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Transaction not opened due to error'</span>);</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>This is quite complex; breaking it down, we:</p>
<ul>
<li>Run <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Event/preventDefault"><code>Event.preventDefault()</code></a> on the event object to stop the form actually submitting in the conventional manner (this would cause a page refresh and spoil the experience).</li>
<li>Create an object representing a record to enter into the database, populating it with values from the form inputs. note that we don’t have to explicitly include an <code>id</code> value — as we explained earlier, this is auto-populated.</li>
<li>Open a <code>readwrite</code> transaction against the <code>notes_os</code> object store using the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBDatabase/transaction"><code>IDBDatabase.transaction()</code></a> method. This transaction object allows us to access the object store so we can do something to it, e.g. add a new record.</li>
<li>Access the object store using the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBTransaction/objectStore"><code>IDBTransaction.objectStore()</code></a> method, saving the result in the <code>objectStore</code> variable.</li>
<li>Add the new record to the database using <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBObjectStore/add"><code>IDBObjectStore.add()</code></a>. This creates a request object, in the same fashion as we’ve seen before.</li>
<li>Add a bunch of event handlers to the <code>request</code> and the <code>transaction</code> to run code at critical points in the lifecycle. Once the request has succeeded, we clear the form inputs ready for entering the next note. Once the transaction has completed, we run the <code>displayData()</code> function again to update the display of notes on the page.</li>
</ul>
<h2 id="displaying-the-data"><a class="markdownIt-Anchor" href="#displaying-the-data"></a> Displaying the data</h2>
<p>We’ve referenced <code>displayData()</code> twice in our code already, so we’d probably better define it. Add this to your code, below the previous function definition:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define the displayData() function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">displayData</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="comment">// Here we empty the contents of the list element each time the display is updated</span></span><br><span class="line">  <span class="comment">// If you didn't do this, you'd get duplicates listed each time a new note is added</span></span><br><span class="line">  <span class="keyword">while</span> (list.firstChild) {</span><br><span class="line">    list.removeChild(list.firstChild);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Open our object store and then get a cursor - which iterates through all the</span></span><br><span class="line">  <span class="comment">// different data items in the store</span></span><br><span class="line">  <span class="keyword">let</span> objectStore = db.transaction(<span class="string">'notes_os'</span>).objectStore(<span class="string">'notes_os'</span>);</span><br><span class="line">  objectStore.openCursor().onsuccess = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>{</span><br><span class="line">    <span class="comment">// Get a reference to the cursor</span></span><br><span class="line">    <span class="keyword">let</span> cursor = e.target.result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there is still another data item to iterate through, keep running this code</span></span><br><span class="line">    <span class="keyword">if</span>(cursor) {</span><br><span class="line">      <span class="comment">// Create a list item, h3, and p to put each data item inside when displaying it</span></span><br><span class="line">      <span class="comment">// structure the HTML fragment, and append it inside the list</span></span><br><span class="line">      <span class="keyword">let</span> listItem = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</span><br><span class="line">      <span class="keyword">let</span> h3 = <span class="built_in">document</span>.createElement(<span class="string">'h3'</span>);</span><br><span class="line">      <span class="keyword">let</span> para = <span class="built_in">document</span>.createElement(<span class="string">'p'</span>);</span><br><span class="line"></span><br><span class="line">      listItem.appendChild(h3);</span><br><span class="line">      listItem.appendChild(para);</span><br><span class="line">      list.appendChild(listItem);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Put the data from the cursor inside the h3 and para</span></span><br><span class="line">      h3.textContent = cursor.value.title;</span><br><span class="line">      para.textContent = cursor.value.body;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Store the ID of the data item inside an attribute on the listItem, so we know</span></span><br><span class="line">      <span class="comment">// which item it corresponds to. This will be useful later when we want to delete items</span></span><br><span class="line">      listItem.setAttribute(<span class="string">'data-note-id'</span>, cursor.value.id);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Create a button and place it inside each listItem</span></span><br><span class="line">      <span class="keyword">let</span> deleteBtn = <span class="built_in">document</span>.createElement(<span class="string">'button'</span>);</span><br><span class="line">      listItem.appendChild(deleteBtn);</span><br><span class="line">      deleteBtn.textContent = <span class="string">'Delete'</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Set an event handler so that when the button is clicked, the deleteItem()</span></span><br><span class="line">      <span class="comment">// function is run</span></span><br><span class="line">      deleteBtn.onclick = deleteItem;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Iterate to the next item in the cursor</span></span><br><span class="line">      cursor.continue();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">// Again, if list item is empty, display a 'No notes stored' message</span></span><br><span class="line">      <span class="keyword">if</span>(!list.firstChild) {</span><br><span class="line">        <span class="keyword">let</span> listItem = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</span><br><span class="line">        listItem.textContent = <span class="string">'No notes stored.'</span>;</span><br><span class="line">        list.appendChild(listItem);</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">// if there are no more cursor items to iterate through, say so</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Notes all displayed'</span>);</span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Again, let’s break this down:</p>
<ul>
<li>First we empty out the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/ul">``</a> element’s content, before then filling it with the updated content. If you didn’t do this, you’d end up with a huge list of duplicated content being added to with each update.</li>
<li>Next, we get a reference to the <code>notes_os</code> object store using <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBDatabase/transaction"><code>IDBDatabase.transaction()</code></a> and <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBTransaction/objectStore"><code>IDBTransaction.objectStore()</code></a> like we did in <code>addData()</code>, except here we are chaining them together in one line.</li>
<li>The next step is to use <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBObjectStore/openCursor"><code>IDBObjectStore.openCursor()</code></a> method to open a request for a cursor — this is a construct that can be used to iterate over the records in an object store. We chain an <code>onsuccess</code> handler on to the end of this line to make the code more concise — when the cursor is successfully returned, the handler is run.</li>
<li>We get a reference to the cursor itself (an <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBCursor"><code>IDBCursor</code></a> object) using let <code>cursor = e.target.result</code>.</li>
<li>Next, we check to see if the cursor contains a record from the datastore (<code>if(cursor){ ... }</code>) — if so, we create a DOM fragment, populate it with the data from the record, and insert it into the page (inside the <code>&lt;ul&gt;</code> element). We also include a delete button that, when clicked, will delete that note by running the <code>deleteItem()</code> function, which we will look at in the next section.</li>
<li>At the end of the <code>if</code> block, we use the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBCursor/continue"><code>IDBCursor.continue()</code></a> method to advance the cursor to the next record in the datastore, and run the content of the <code>if</code> block again. If there is another record to iterate to, this causes it to be inserted into the page, and then <code>continue()</code> is run again, and so on.</li>
<li>When there are no more records to iterate over, <code>cursor</code> will return <code>undefined</code>, and therefore the <code>else</code> block will run instead of the <code>if</code> block. This block checks whether any notes were inserted into the <code>&lt;ul&gt;</code> — if not, it inserts a message to say no note was stored.</li>
</ul>
<h2 id="deleting-a-note"><a class="markdownIt-Anchor" href="#deleting-a-note"></a> Deleting a note</h2>
<p>As stated above, when a note’s delete button is pressed, the note is deleted. This is achieved by the <code>deleteItem()</code> function, which looks like so:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define the deleteItem() function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteItem</span>(<span class="params">e</span>) </span>{</span><br><span class="line">  <span class="comment">// retrieve the name of the task we want to delete. We need</span></span><br><span class="line">  <span class="comment">// to convert it to a number before trying it use it with IDB; IDB key</span></span><br><span class="line">  <span class="comment">// values are type-sensitive.</span></span><br><span class="line">  <span class="keyword">let</span> noteId = <span class="built_in">Number</span>(e.target.parentNode.getAttribute(<span class="string">'data-note-id'</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// open a database transaction and delete the task, finding it using the id we retrieved above</span></span><br><span class="line">  <span class="keyword">let</span> transaction = db.transaction([<span class="string">'notes_os'</span>], <span class="string">'readwrite'</span>);</span><br><span class="line">  <span class="keyword">let</span> objectStore = transaction.objectStore(<span class="string">'notes_os'</span>);</span><br><span class="line">  <span class="keyword">let</span> request = objectStore.delete(noteId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// report that the data item has been deleted</span></span><br><span class="line">  transaction.oncomplete = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">    <span class="comment">// delete the parent of the button</span></span><br><span class="line">    <span class="comment">// which is the list item, so it is no longer displayed</span></span><br><span class="line">    e.target.parentNode.parentNode.removeChild(e.target.parentNode);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Note '</span> + noteId + <span class="string">' deleted.'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Again, if list item is empty, display a 'No notes stored' message</span></span><br><span class="line">    <span class="keyword">if</span>(!list.firstChild) {</span><br><span class="line">      <span class="keyword">let</span> listItem = <span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</span><br><span class="line">      listItem.textContent = <span class="string">'No notes stored.'</span>;</span><br><span class="line">      list.appendChild(listItem);</span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>The first part of this could use some explaining — we retrieve the ID of the record to be deleted using <code>Number(e.target.parentNode.getAttribute('data-note-id'))</code> — recall that the ID of the record was saved in a <code>data-note-id</code> attribute on the <code>&lt;li&gt;</code> when it was first displayed. We do however need to pass the attribute through the global built-in <code>Number()</code> object as it is of datatype string, and therefore wouldn’t be recognized by the database, which expects a number.</li>
<li>We then get a reference to the object store using the same pattern we’ve seen previously, and use the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBObjectStore/delete"><code>IDBObjectStore.delete()</code></a> method to delete the record from the database, passing it the ID.</li>
<li>When the database transaction is complete, we delete the note’s <code>&lt;li&gt;</code> from the DOM, and again do the check to see if the <code>&lt;ul&gt;</code> is now empty, inserting a note as appropriate.</li>
</ul>
<p>So that’s it! Your example should now work.</p>
<p>If you are having trouble with it, feel free to <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/apis/client-side-storage/indexeddb/notes/">check it against our live example</a> (see the <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/apis/client-side-storage/indexeddb/notes/index.js">source code</a> also).</p>
<h2 id="storing-complex-data-via-indexeddb"><a class="markdownIt-Anchor" href="#storing-complex-data-via-indexeddb"></a> Storing complex data via IndexedDB</h2>
<p>As we mentioned above, IndexedDB can be used to store more than just simple text strings. You can store just about anything you want, including complex objects such as video or image blobs. And it isn’t much more difficult to achieve than any other type of data.</p>
<p>To demonstrate how to do it, we’ve written another example called <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/tree/master/javascript/apis/client-side-storage/indexeddb/video-store">IndexedDB video store</a>(see it <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/apis/client-side-storage/indexeddb/video-store/">running live here also</a>). When you first run the example, it downloads all the videos from the network, stores them in an IndexedDB database, and then displays the videos in the UI inside <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video">``</a> elements. The second time you run it, it finds the videos in the database and gets them from there instead before displaying them — this makes subsequent loads much quicker and less bandwidth-hungry.</p>
<p>Let’s walk through the most interesting parts of the example. We won’t look at it all — a lot of it is similar to the previous example, and the code is well-commented.</p>
<ol>
<li>
<p>For this simple example, we’ve stored the names of the videos to fetch in an array of objects:</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> videos = [</span><br><span class="line">  { <span class="string">'name'</span> : <span class="string">'crystal'</span> },</span><br><span class="line">  { <span class="string">'name'</span> : <span class="string">'elf'</span> },</span><br><span class="line">  { <span class="string">'name'</span> : <span class="string">'frog'</span> },</span><br><span class="line">  { <span class="string">'name'</span> : <span class="string">'monster'</span> },</span><br><span class="line">  { <span class="string">'name'</span> : <span class="string">'pig'</span> },</span><br><span class="line">  { <span class="string">'name'</span> : <span class="string">'rabbit'</span> }</span><br><span class="line">];</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>To start with, once the database is successfully opened we run an <code>init()</code> function. This loops through the different video names, trying to load a record identified by each name from the <code>videos</code> database.</p>
<p>If each video is found in the database (easily checked by seeing whether <code>request.result</code> evaluates to <code>true</code> — if the record is not present, it will be <code>undefined</code>), its video files (stored as blobs) and the video name are passed straight to the <code>displayVideo()</code> function to place them in the UI. If not, the video name is passed to the <code>fetchVideoFromNetwork()</code> function to … you guessed it — fetch the video from the network.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>{</span><br><span class="line">  <span class="comment">// Loop through the video names one by one</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; videos.length; i++) {</span><br><span class="line">    <span class="comment">// Open transaction, get object store, and get() each video by name</span></span><br><span class="line">    <span class="keyword">let</span> objectStore = db.transaction(<span class="string">'videos_os'</span>).objectStore(<span class="string">'videos_os'</span>);</span><br><span class="line">    <span class="keyword">let</span> request = objectStore.get(videos[i].name);</span><br><span class="line">    request.onsuccess = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{</span><br><span class="line">      <span class="comment">// If the result exists in the database (is not undefined)</span></span><br><span class="line">      <span class="keyword">if</span>(request.result) {</span><br><span class="line">        <span class="comment">// Grab the videos from IDB and display them using displayVideo()</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'taking videos from IDB'</span>);</span><br><span class="line">        displayVideo(request.result.mp4, request.result.webm, request.result.name);</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// Fetch the videos from the network</span></span><br><span class="line">        fetchVideoFromNetwork(videos[i]);</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>The following snippet is taken from inside <code>fetchVideoFromNetwork()</code> — here we fetch MP4 and WebM versions of the video using two separate <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch"><code>WindowOrWorkerGlobalScope.fetch()</code></a> requests. We then use the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Blob"><code>Body.blob()</code></a>method to extract each response’s body as a blob, giving us an object representation of the videos that can be stored and displayed later on.</p>
<p>We have a problem here though — these two requests are both asynchronous, but we only want to try to display or store the video when both promises have fulfilled. Fortunately there is a built-in method that handles such a problem — <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all"><code>Promise.all()</code></a>. This takes one argument — references to all the individual promises you want to check for fulfillment placed in an array — and is itself promise-based.</p>
<p>When all those promises have fulfilled, the <code>all()</code> promise fulfills with an array containing all the individual fulfillment values. Inside the <code>all()</code> block, you can see that we then call the <code>displayVideo()</code> function like we did before to display the videos in the UI, then we also call the <code>storeVideo()</code> function to store those videos inside the database.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> mp4Blob = fetch(<span class="string">'videos/'</span> + video.name + <span class="string">'.mp4'</span>).then(<span class="function"><span class="params">response</span> =&gt;</span></span><br><span class="line">  response.blob()</span><br><span class="line">);</span><br><span class="line"><span class="keyword">let</span> webmBlob = fetch(<span class="string">'videos/'</span> + video.name + <span class="string">'.webm'</span>).then(<span class="function"><span class="params">response</span> =&gt;</span></span><br><span class="line">  response.blob()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only run the next code when both promises have fulfilled</span></span><br><span class="line"><span class="built_in">Promise</span>.all([mp4Blob, webmBlob]).then(<span class="function"><span class="keyword">function</span>(<span class="params">values</span>) </span>{</span><br><span class="line">  <span class="comment">// display the video fetched from the network with displayVideo()</span></span><br><span class="line">  displayVideo(values[<span class="number">0</span>], values[<span class="number">1</span>], video.name);</span><br><span class="line">  <span class="comment">// store it in the IDB using storeVideo()</span></span><br><span class="line">  storeVideo(values[<span class="number">0</span>], values[<span class="number">1</span>], video.name);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>Let’s look at <code>storeVideo()</code> first. This is very similar to the pattern you saw in the previous example for adding data to the database — we open a <code>readwrite</code> transaction and get a reference to our <code>videos_os</code> object store, create an object representing the record to add to the database, then simply add it using <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IDBObjectStore/add"><code>IDBObjectStore.add()</code></a>.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">storeVideo</span>(<span class="params">mp4Blob, webmBlob, name</span>) </span>{</span><br><span class="line">  <span class="comment">// Open transaction, get object store; make it a readwrite so we can write to the IDB</span></span><br><span class="line">  <span class="keyword">let</span> objectStore = db.transaction([<span class="string">'videos_os'</span>], <span class="string">'readwrite'</span>).objectStore(<span class="string">'videos_os'</span>);</span><br><span class="line">  <span class="comment">// Create a record to add to the IDB</span></span><br><span class="line">  <span class="keyword">let</span> record = {</span><br><span class="line">    mp4 : mp4Blob,</span><br><span class="line">    webm : webmBlob,</span><br><span class="line">    name : name</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the record to the IDB using add()</span></span><br><span class="line">  <span class="keyword">let</span> request = objectStore.add(record);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>Last but not least, we have <code>displayVideo()</code>, which creates the DOM elements needed to insert the video in the UI and then appends them to the page. The most interesting parts of this are those shown below — to actually display our video blobs in a <code>&lt;video&gt;</code>element, we need to create object URLs (internal URLs that point to the video blobs stored in memory) using the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL"><code>URL.createObjectURL()</code></a> method. Once that is done, we can set the object URLs to be the values of our <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/source">``</a> element’s <code>src</code> attributes, and it works fine.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">displayVideo</span>(<span class="params">mp4Blob, webmBlob, title</span>) </span>{</span><br><span class="line">  <span class="comment">// Create object URLs out of the blobs</span></span><br><span class="line">  <span class="keyword">let</span> mp4URL = URL.createObjectURL(mp4Blob);</span><br><span class="line">  <span class="keyword">let</span> webmURL = URL.createObjectURL(webmBlob);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> video = <span class="built_in">document</span>.createElement(<span class="string">'video'</span>);</span><br><span class="line">  video.controls = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">let</span> source1 = <span class="built_in">document</span>.createElement(<span class="string">'source'</span>);</span><br><span class="line">  source1.src = mp4URL;</span><br><span class="line">  source1.type = <span class="string">'video/mp4'</span>;</span><br><span class="line">  <span class="keyword">let</span> source2 = <span class="built_in">document</span>.createElement(<span class="string">'source'</span>);</span><br><span class="line">  source2.src = webmURL;</span><br><span class="line">  source2.type = <span class="string">'video/webm'</span>;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<h1 id="offline-storage"><a class="markdownIt-Anchor" href="#offline-storage"></a> Offline Storage</h1>
<p>The above example already shows how to create an app that will store large assets in an IndexedDB database, avoiding the need to download them more than once. This is already a great improvement to the user experience, but there is still one thing missing — the main HTML, CSS, and JavaScript files still need to downloaded each time the site is accessed, meaning that it won’t work when there is no network connection.</p>
<p><img src="https://mdn.mozillademos.org/files/15759/ff-offline.png" alt="img"></p>
<p>This is where <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service workers</a> and the closely-related <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Cache">Cache API</a> come in.</p>
<p>A service worker is a JavaScript file that, simply put, is registered against a particular origin (web site, or part of a web site at a certain domain) when it is accessed by a browser. When registered, it can control pages available at that origin. It does this by sitting between a loaded page and the network and intercepting network requests aimed at that origin.</p>
<p>When it intercepts a request, it can do anything you wish to it (see <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API#Other_use_case_ideas">use case ideas</a>), but the classic example is saving the network responses offline and then providing those in response to a request instead of the responses from the network. In effect, it allows you to make a web site work completely offline.</p>
<p>The Cache API is a another client-side storage mechanism, with a bit of a difference — it is designed to save HTTP responses, and so works very well with service workers.</p>
<p><strong>Note</strong>: Service workers and Cache are supported in most modern browsers now. At the time of writing, Safari was still busy implementing it, but it should be there soon.</p>
<h2 id="a-service-worker-example"><a class="markdownIt-Anchor" href="#a-service-worker-example"></a> A service worker example</h2>
<p>Let’s look at an example, to give you a bit of an idea of what this might look like. We have created another version of the video store example we saw in the previous section — this functions identically, except that it also saves the HTML, CSS, and JavaScript in the Cache API via a service worker, allowing the example to run offline!</p>
<p>See <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/apis/client-side-storage/cache-sw/video-store-offline/">IndexedDB video store with service worker running live</a>, and also <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/tree/master/javascript/apis/client-side-storage/cache-sw/video-store-offline">see the source code</a>.</p>
<h4 id="registering-the-service-worker"><a class="markdownIt-Anchor" href="#registering-the-service-worker"></a> Registering the service worker</h4>
<p>The first thing to note is that there’s an extra bit of code placed in the main JavaScript file (see <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/apis/client-side-storage/cache-sw/video-store-offline/index.js">index.js</a>). First we do a feature detection test to see if the <code>serviceWorker</code> member is available in the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator"><code>Navigator</code></a> object. If this returns true, then we know that at least the basics of service workers are supported. Inside here we use the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerContainer/register"><code>ServiceWorkerContainer.register()</code></a> method to register a service worker contained in the <code>sw.js</code> file against the origin it resides at, so it can control pages in the same directory as it, or subdirectories. When its promise fulfills, the service worker is deemed registered.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Register service worker to control making site work offline</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="string">'serviceWorker'</span> <span class="keyword">in</span> navigator) {</span><br><span class="line">    navigator.serviceWorker</span><br><span class="line">             .register(<span class="string">'/learning-area/javascript/apis/client-side-storage/cache-sw/video-store-offline/sw.js'</span>)</span><br><span class="line">             .then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{ <span class="built_in">console</span>.log(<span class="string">'Service Worker Registered'</span>); });</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Note</strong>: The given path to the <code>sw.js</code> file is relative to the site origin, not the JavaScript file that contains the code. The service worker is at <code>https://mdn.github.io/learning-area/javascript/apis/client-side-storage/cache-sw/video-store-offline/sw.js</code>. The origin is <code>https://mdn.github.io</code>, and therefore the given path has to be <code>/learning-area/javascript/apis/client-side-storage/cache-sw/video-store-offline/sw.js</code>. If you wanted to host this example on your own server, you’d have to change this accordingly. This is rather confusing, but it has to work this way for security reasons.</p>
<h4 id="installing-the-service-worker"><a class="markdownIt-Anchor" href="#installing-the-service-worker"></a> Installing the service worker</h4>
<p>The next time any page under the service worker’s control is accessed (e.g. when the example is reloaded), the service worker is installed against that page, meaning that it will start controlling it. When this occurs, an <code>install</code> event is fired against the service worker; you can write code inside the service worker itself that will respond to the installation.</p>
<p>Let’s look at an example, in the <a target="_blank" rel="noopener" href="https://github.com/mdn/learning-area/blob/master/javascript/apis/client-side-storage/cache-sw/video-store-offline/sw.js">sw.js</a> file (the service worker). You’ll see that the install listener is registered against <code>self</code>. This <code>self</code> keyword is a way to refer to the global scope of the service worker from inside the service worker file.</p>
<p>Inside the <code>install</code> handler we use the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/ExtendableEvent/waitUntil"><code>ExtendableEvent.waitUntil()</code></a> method, available on the event object, to signal that the browser shouldn’t complete installation of the service worker until after the promise inside it has fulfilled successfully.</p>
<p>Here is where we see the Cache API in action. We use the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage/open"><code>CacheStorage.open()</code></a> method to open a new cache object in which responses can be stored (similar to an IndexedDB object store). This promise fulfills with a <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Cache"><code>Cache</code></a> object representing the <code>video-store</code> cache. We then use the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Cache/addAll"><code>Cache.addAll()</code></a> method to fetch a series of assets and add their responses to the cache.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(<span class="string">'install'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>{</span><br><span class="line"> e.waitUntil(</span><br><span class="line">   caches.open(<span class="string">'video-store'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">cache</span>) </span>{</span><br><span class="line">     <span class="keyword">return</span> cache.addAll([</span><br><span class="line">       <span class="string">'/learning-area/javascript/apis/client-side-storage/cache-sw/video-store-offline/'</span>,</span><br><span class="line">       <span class="string">'/learning-area/javascript/apis/client-side-storage/cache-sw/video-store-offline/index.html'</span>,</span><br><span class="line">       <span class="string">'/learning-area/javascript/apis/client-side-storage/cache-sw/video-store-offline/index.js'</span>,</span><br><span class="line">       <span class="string">'/learning-area/javascript/apis/client-side-storage/cache-sw/video-store-offline/style.css'</span></span><br><span class="line">     ]);</span><br><span class="line">   })</span><br><span class="line"> );</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>That’s it for now, installation done.</p>
<h4 id="responding-to-further-requests"><a class="markdownIt-Anchor" href="#responding-to-further-requests"></a> Responding to further requests</h4>
<p>With the service worker registered and installed against our HTML page, and the relevant assets all added to our cache, we are nearly ready to go. There is only one more thing to do, write some code to respond to further network requests.</p>
<p>This is what the second bit of code in <code>sw.js</code> does. We add another listener to the service worker global scope, which runs the handler function when the <code>fetch</code> event is raised. This happens whenever the browser makes a request for an asset in the directory the service worker is registered against.</p>
<p>Inside the handler we first log the URL of the requested asset. We then provide a custom response to the request, using the <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent/respondWith"><code>FetchEvent.respondWith()</code></a> method.</p>
<p>Inside this block we use <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage/match"><code>CacheStorage.match()</code></a> to check whether a matching request (i.e. matches the URL) can be found in any cache. This promise fulfills with the matching response if a match is not found, or <code>undefined</code> if it isn’t.</p>
<p>If a match is found, we simply return it as the custom response. If not, we <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch">fetch()</a> the response from the network and return that instead.</p>
<figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(<span class="string">'fetch'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>{</span><br><span class="line">  <span class="built_in">console</span>.log(e.request.url);</span><br><span class="line">  e.respondWith(</span><br><span class="line">    caches.match(e.request).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>{</span><br><span class="line">      <span class="keyword">return</span> response || fetch(e.request);</span><br><span class="line">    })</span><br><span class="line">  );</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>And that is it for our simple service worker. There is a whole load more you can do with them — for a lot more detail, see the <a target="_blank" rel="noopener" href="https://serviceworke.rs/">service worker cookbook</a>. And thanks to Paul Kinlan for his article <a target="_blank" rel="noopener" href="https://developers.google.com/web/fundamentals/codelabs/offline/">Adding a Service Worker and Offline into your Web App</a>, which inspired this simple example.</p>
<h4 id="testing-the-example-offline"><a class="markdownIt-Anchor" href="#testing-the-example-offline"></a> Testing the example offline</h4>
<p>To test our <a target="_blank" rel="noopener" href="https://mdn.github.io/learning-area/javascript/apis/client-side-storage/cache-sw/video-store-offline/">service worker example</a>, you’ll need to load it a couple of times to make sure it is installed. Once this is done, you can:</p>
<ul>
<li>Try unplugging your network/turning your Wifi off.</li>
<li>Select <em>File &gt; Work Offline</em> if you are using Firefox.</li>
<li>Go to the devtools, then choose <em>Application &gt; Service Workers</em>, then check the <em>Offline</em>checkbox if you are using Chrome.</li>
</ul>
<p>If you refresh your example page again, you should still see it load just fine. Everything is stored offline — the page assets in a cache, and the videos in an IndexedDB database.</p>
<h1 id="cache-api"><a class="markdownIt-Anchor" href="#cache-api"></a> Cache API</h1>
<p>. This API is designed for storing HTTP responses to specific requests, and is very useful for doing things like storing website assets offline so the site can subsequently be used without a network connection. Cache is usually used in combination with the Service Worker API, although it doesn’t have to be.</p>
<p>Use of Cache and Service Workers is an advanced topic, and we won’t be covering it in  great detail in this article, although we will show a simple example in the Offline asset storage section below.</p>
<h1 id="cookie"><a class="markdownIt-Anchor" href="#cookie"></a> Cookie</h1>
<p>The concept of client-side storage has been around for a long time. Since the early days of the web, sites have used cookies to store information to personalize user experience on websites. They’re the earliest form of client-side storage commonly used on the web.</p>
<p>Because of that age, there are a number of problems — both technical and user experience-wise — afflicting cookies. These problems are significant enough that upon visiting a site for the first time, people living in Europe are shown messages informing them if they will use cookies to store data about them. This is due to a piece of European Union legislation known as the EU Cookie directive.</p>
<blockquote>
<p>We use cookies to give you a fabulous customer experience and enable you to checkout on our website.<br>
By continuing to shop we willassume you are happy to receive all cookies, otherwise you can review more information on cookies here.</p>
</blockquote>
<p>For these reasons, we won’t be teaching you how to use cookies in this article. Between being outdated, their assorted security problems, and inability to store complex data, there are better, more modern ways to store a wider variety of data on the user’s computer.</p>
<p>The only advantage cookies have is that they’re supported by extremely old browsers, so if your project requires that you support browsers that are already obsolete (such as Internet Explorer 8 or earlier), cookies may still be useful, but for most projects you shouldn’t need to resort to them anymore.</p>
<p><strong>Note</strong>: Why are there still new sites being created using cookies? This is mostly because of developers’ habits, use of older libraries that still use cookies, and the existence of many web sites providing out-of-date reference and training materials to learn how to store data.</p>
<p><a href="/web/html/stroage/html5_storage.html" target="_blank">Preview Cookie Here</a></p>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> REFERENCES</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API">https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API">https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/sessionStorage"><code>sessionStorage</code></a> and <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage"><code>localStorage</code></a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API">IndexedDB API</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">Cookies</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Cache"><code>Cache</code></a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service worker API</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Browser_storage_limits_and_eviction_criteria">https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Browser_storage_limits_and_eviction_criteria</a></li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Joaxin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://u.pinsflora.xyz/Web/html/web_html_storage/">https://u.pinsflora.xyz/Web/html/web_html_storage/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_wechat"></a><a class="a2a_button_sina_weibo"></a><a class="a2a_button_facebook_messenger"></a><a class="a2a_button_email"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a></div></div><script async="async" src="https://static.addtoany.com/menu/page.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/Web/html/web_html_svg/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_writing-letters-french.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">HTML Vector graphics</div></div></a></div><div class="next-post pull-right"><a href="/Pysnista/Algor/Leetcode_Distance/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_red_dim_flower.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Leetcode - hamming</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="https://avatars2.githubusercontent.com/u/8346164?s=460&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Joaxin</div><div class="author-info__description">When I close my eyes, I'm in my own ♡cean 🐟aves.</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">340</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">110</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">34</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/joaxin"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/joaxin" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:lotility@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">感謝訪問本站，若喜歡請收藏 ^_^</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#web-storage"><span class="toc-number">1.</span> <span class="toc-text"> Web Storage</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sessionstorage"><span class="toc-number">1.1.</span> <span class="toc-text"> SessionStorage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#localstorage"><span class="toc-number">1.2.</span> <span class="toc-text"> localStorage</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#indexeddb"><span class="toc-number">2.</span> <span class="toc-text"> IndexedDB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#set-up-a-database"><span class="toc-number">2.1.</span> <span class="toc-text"> Set up a database</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#adding-data-to-the-database"><span class="toc-number">2.2.</span> <span class="toc-text"> Adding data to the database</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#displaying-the-data"><span class="toc-number">2.3.</span> <span class="toc-text"> Displaying the data</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deleting-a-note"><span class="toc-number">2.4.</span> <span class="toc-text"> Deleting a note</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#storing-complex-data-via-indexeddb"><span class="toc-number">2.5.</span> <span class="toc-text"> Storing complex data via IndexedDB</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#offline-storage"><span class="toc-number">3.</span> <span class="toc-text"> Offline Storage</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#a-service-worker-example"><span class="toc-number">3.1.</span> <span class="toc-text"> A service worker example</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#registering-the-service-worker"><span class="toc-number">3.1.0.1.</span> <span class="toc-text"> Registering the service worker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#installing-the-service-worker"><span class="toc-number">3.1.0.2.</span> <span class="toc-text"> Installing the service worker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#responding-to-further-requests"><span class="toc-number">3.1.0.3.</span> <span class="toc-text"> Responding to further requests</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#testing-the-example-offline"><span class="toc-number">3.1.0.4.</span> <span class="toc-text"> Testing the example offline</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cache-api"><span class="toc-number">4.</span> <span class="toc-text"> Cache API</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cookie"><span class="toc-number">5.</span> <span class="toc-text"> Cookie</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#references"><span class="toc-number">6.</span> <span class="toc-text"> REFERENCES</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/Lang/es/duo_es/" title="No title"><img src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_seeds.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/Lang/es/duo_es/" title="No title">No title</a><time datetime="2020-06-29T03:44:49.224Z" title="Created 2020-06-29 11:44:49">2020-06-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Lang/kl/duo_kl001_intro/" title="Klingon- Vol.1 - Introduction"><img src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_little_girl_phone.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Klingon- Vol.1 - Introduction"/></a><div class="content"><a class="title" href="/Lang/kl/duo_kl001_intro/" title="Klingon- Vol.1 - Introduction">Klingon- Vol.1 - Introduction</a><time datetime="2020-06-26T16:00:00.000Z" title="Created 2020-06-27 00:00:00">2020-06-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Life/apps/life_apps_android_list/" title="安卓 | 装机必备清单及习惯步骤"><img src="https://i.postimg.cc/KYPmhV8w/android-new-logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="安卓 | 装机必备清单及习惯步骤"/></a><div class="content"><a class="title" href="/Life/apps/life_apps_android_list/" title="安卓 | 装机必备清单及习惯步骤">安卓 | 装机必备清单及习惯步骤</a><time datetime="2020-06-20T04:29:10.462Z" title="Created 2020-06-20 12:29:10">2020-06-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Pysnista/Intro/files/py_pillow/" title="Python - 操作图像"><img src="https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_little_girl_phone.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python - 操作图像"/></a><div class="content"><a class="title" href="/Pysnista/Intro/files/py_pillow/" title="Python - 操作图像">Python - 操作图像</a><time datetime="2020-05-02T16:00:00.000Z" title="Created 2020-05-03 00:00:00">2020-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Pysnista/Intro/files/py_files_pdf_word/" title="Python - PDF &amp; Word"><img src="https://i.loli.net/2020/07/09/6ALoRXnITgcuvy2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python - PDF &amp; Word"/></a><div class="content"><a class="title" href="/Pysnista/Intro/files/py_files_pdf_word/" title="Python - PDF &amp; Word">Python - PDF &amp; Word</a><time datetime="2020-04-12T16:00:00.000Z" title="Created 2020-04-13 00:00:00">2020-04-13</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/joaxin/img_bed/img/cover/cover_sea_stairs.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Joaxin</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Refine, the Life</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="Increase font size"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="Decrease font size"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="fasle"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/fae45343.js","daovoice")
</script><script>var isChatBtn = true
daovoice('init', {
  app_id: 'fae45343',},{
  launcher: { 
     disableLauncherIcon: isChatBtn // 悬浮 ICON 是否显示
  },
});
daovoice('update');

if (isChatBtn) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      daovoice('show')
    });
  }
  chatBtnFn()
} else {
  if (true) {
    function chatBtnHide () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: true // 悬浮 ICON 是否显示
        },
      });
    }
    function chatBtnShow () {
      daovoice('update', {},{
        launcher: { 
        disableLauncherIcon: false // 悬浮 ICON 是否显示
        },
      });
    }
  }
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>